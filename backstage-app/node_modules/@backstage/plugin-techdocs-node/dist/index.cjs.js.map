{"version":3,"file":"index.cjs.js","sources":["../src/stages/publish/helpers.ts","../src/stages/generate/helpers.ts","../src/stages/generate/mkDocsPatchers.ts","../src/stages/generate/techdocs.ts","../src/stages/generate/generators.ts","../src/helpers.ts","../src/stages/prepare/dir.ts","../src/stages/prepare/url.ts","../src/stages/prepare/preparers.ts","../src/stages/publish/awsS3.ts","../src/stages/publish/azureBlobStorage.ts","../src/stages/publish/migrations/GoogleMigration.ts","../src/stages/publish/googleStorage.ts","../src/stages/publish/local.ts","../src/stages/publish/openStackSwift.ts","../src/stages/publish/publish.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { Entity, DEFAULT_NAMESPACE } from '@backstage/catalog-model';\nimport mime from 'mime-types';\nimport path from 'path';\nimport createLimiter from 'p-limit';\nimport recursiveReadDir from 'recursive-readdir';\n\n/**\n * Helper to get the expected content-type for a given file extension. Also\n * takes XSS mitigation into account.\n */\nconst getContentTypeForExtension = (ext: string): string => {\n  const defaultContentType = 'text/plain; charset=utf-8';\n\n  // Prevent sanitization bypass by preventing browsers from directly rendering\n  // the contents of untrusted files.\n  if (ext.match(/htm|xml|svg/i)) {\n    return defaultContentType;\n  }\n\n  return mime.contentType(ext) || defaultContentType;\n};\n\nexport type responseHeadersType = {\n  'Content-Type': string;\n};\n\n/**\n * Some files need special headers to be used correctly by the frontend. This function\n * generates headers in the response to those file requests.\n * @param fileExtension - .html, .css, .js, .png etc.\n */\nexport const getHeadersForFileExtension = (\n  fileExtension: string,\n): responseHeadersType => {\n  return {\n    'Content-Type': getContentTypeForExtension(fileExtension),\n  };\n};\n\n/**\n * Recursively traverse all the sub-directories of a path and return\n * a list of absolute paths of all the files. e.g. tree command in Unix\n *\n * @example\n *\n * /User/username/my_dir\n *     dirA\n *     |   subDirA\n *     |   |   file1\n *     EmptyDir\n *     dirB\n *     |   file2\n *     file3\n *\n * getFileListRecursively('/Users/username/myDir')\n * // returns\n * [\n *   '/User/username/my_dir/dirA/subDirA/file1',\n *   '/User/username/my_dir/dirB/file2',\n *   '/User/username/my_dir/file3'\n * ]\n * @param rootDirPath - Absolute path to the root directory.\n */\nexport const getFileTreeRecursively = async (\n  rootDirPath: string,\n): Promise<string[]> => {\n  // Iterate on all the files in the directory and its sub-directories\n  const fileList = await recursiveReadDir(rootDirPath).catch(error => {\n    throw new Error(`Failed to read template directory: ${error.message}`);\n  });\n  return fileList;\n};\n\n/**\n * Takes a posix path and returns a lower-cased version of entity's triplet\n * with the remaining path in posix.\n *\n * Path must not include a starting slash.\n *\n * @example\n * lowerCaseEntityTriplet('default/Component/backstage')\n * // return default/component/backstage\n */\nexport const lowerCaseEntityTriplet = (posixPath: string): string => {\n  const [namespace, kind, name, ...rest] = posixPath.split(path.posix.sep);\n  const lowerNamespace = namespace.toLowerCase();\n  const lowerKind = kind.toLowerCase();\n  const lowerName = name.toLowerCase();\n  return [lowerNamespace, lowerKind, lowerName, ...rest].join(path.posix.sep);\n};\n\n/**\n * Takes either a win32 or posix path and returns a lower-cased version of entity's triplet\n * with the remaining path in posix.\n *\n * Starting slashes will be trimmed.\n *\n * Throws an error if the path does not appear to be an entity triplet.\n *\n * @example\n * lowerCaseEntityTripletInStoragePath('/default/Component/backstage/file.txt')\n * // return default/component/backstage/file.txt\n */\nexport const lowerCaseEntityTripletInStoragePath = (\n  originalPath: string,\n): string => {\n  let posixPath = originalPath;\n  if (originalPath.includes(path.win32.sep)) {\n    posixPath = originalPath.split(path.win32.sep).join(path.posix.sep);\n  }\n\n  // remove leading slash\n  const parts = posixPath.split(path.posix.sep);\n  if (parts[0] === '') {\n    parts.shift();\n  }\n\n  // check if all parts of the entity exist (name, namespace, kind) plus filename\n  if (parts.length <= 3) {\n    throw new Error(\n      `Encountered file unmanaged by TechDocs ${originalPath}. Skipping.`,\n    );\n  }\n\n  return lowerCaseEntityTriplet(parts.join(path.posix.sep));\n};\n\n/**\n * Take a posix path and return a path without leading and trailing\n * separators\n *\n * @example\n * normalizeExternalStorageRootPath('/backstage-data/techdocs/')\n * // return backstage-data/techdocs\n */\nexport const normalizeExternalStorageRootPath = (posixPath: string): string => {\n  // remove leading slash\n  let normalizedPath = posixPath;\n  if (posixPath.startsWith(path.posix.sep)) {\n    normalizedPath = posixPath.slice(1);\n  }\n\n  // remove trailing slash\n  if (normalizedPath.endsWith(path.posix.sep)) {\n    normalizedPath = normalizedPath.slice(0, normalizedPath.length - 1);\n  }\n\n  return normalizedPath;\n};\n\n// Only returns the files that existed previously and are not present anymore.\nexport const getStaleFiles = (\n  newFiles: string[],\n  oldFiles: string[],\n): string[] => {\n  const staleFiles = new Set(oldFiles);\n  newFiles.forEach(newFile => {\n    staleFiles.delete(newFile);\n  });\n  return Array.from(staleFiles);\n};\n\n// Compose actual filename on remote bucket including entity information\nexport const getCloudPathForLocalPath = (\n  entity: Entity,\n  localPath = '',\n  useLegacyPathCasing = false,\n  externalStorageRootPath = '',\n): string => {\n  // Convert destination file path to a POSIX path for uploading.\n  // GCS expects / as path separator and relativeFilePath will contain \\\\ on Windows.\n  // https://cloud.google.com/storage/docs/gsutil/addlhelp/HowSubdirectoriesWork\n  const relativeFilePathPosix = localPath.split(path.sep).join(path.posix.sep);\n\n  // The / delimiter is intentional since it represents the cloud storage and not the local file system.\n  const entityRootDir = `${entity.metadata?.namespace ?? DEFAULT_NAMESPACE}/${\n    entity.kind\n  }/${entity.metadata.name}`;\n\n  const relativeFilePathTriplet = `${entityRootDir}/${relativeFilePathPosix}`;\n\n  const destination = useLegacyPathCasing\n    ? relativeFilePathTriplet\n    : lowerCaseEntityTriplet(relativeFilePathTriplet);\n\n  // Again, the / delimiter is intentional, as it represents remote storage.\n  const destinationWithRoot = [\n    // The extra filter prevents unintended double slashes and prefixes.\n    ...externalStorageRootPath.split(path.posix.sep).filter(s => s !== ''),\n    destination,\n  ].join('/');\n\n  return destinationWithRoot; // Remote storage file relative path\n};\n\n// Perform rate limited generic operations by passing a function and a list of arguments\nexport const bulkStorageOperation = async <T>(\n  operation: (arg: T) => Promise<unknown>,\n  args: T[],\n  { concurrencyLimit } = { concurrencyLimit: 25 },\n) => {\n  const limiter = createLimiter(concurrencyLimit);\n  await Promise.all(args.map(arg => limiter(operation, arg)));\n};\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { isChildPath } from '@backstage/backend-common';\nimport { Entity } from '@backstage/catalog-model';\nimport { assertError, ForwardedError } from '@backstage/errors';\nimport { ScmIntegrationRegistry } from '@backstage/integration';\nimport { SpawnOptionsWithoutStdio, spawn } from 'child_process';\nimport fs from 'fs-extra';\nimport gitUrlParse from 'git-url-parse';\nimport yaml, { DEFAULT_SCHEMA, Type } from 'js-yaml';\nimport path, { resolve as resolvePath } from 'path';\nimport { PassThrough, Writable } from 'stream';\nimport { Logger } from 'winston';\nimport { ParsedLocationAnnotation } from '../../helpers';\nimport { SupportedGeneratorKey } from './types';\nimport { getFileTreeRecursively } from '../publish/helpers';\n\n// TODO: Implement proper support for more generators.\nexport function getGeneratorKey(entity: Entity): SupportedGeneratorKey {\n  if (!entity) {\n    throw new Error('No entity provided');\n  }\n\n  return 'techdocs';\n}\n\nexport type RunCommandOptions = {\n  /** command to run */\n  command: string;\n  /** arguments to pass the command */\n  args: string[];\n  /** options to pass to spawn */\n  options: SpawnOptionsWithoutStdio;\n  /** stream to capture stdout and stderr output */\n  logStream?: Writable;\n};\n\n/**\n * Run a command in a sub-process, normally a shell command.\n */\nexport const runCommand = async ({\n  command,\n  args,\n  options,\n  logStream = new PassThrough(),\n}: RunCommandOptions) => {\n  await new Promise<void>((resolve, reject) => {\n    const process = spawn(command, args, options);\n\n    process.stdout.on('data', stream => {\n      logStream.write(stream);\n    });\n\n    process.stderr.on('data', stream => {\n      logStream.write(stream);\n    });\n\n    process.on('error', error => {\n      return reject(error);\n    });\n\n    process.on('close', code => {\n      if (code !== 0) {\n        return reject(`Command ${command} failed, exit code: ${code}`);\n      }\n      return resolve();\n    });\n  });\n};\n\n/**\n * Return the source url for MkDocs based on the backstage.io/techdocs-ref annotation.\n * Depending on the type of target, it can either return a repo_url, an edit_uri, both, or none.\n *\n * @param parsedLocationAnnotation - Object with location url and type\n * @param scmIntegrations - the scmIntegration to do url transformations\n * @param docsFolder - the configured docs folder in the mkdocs.yml (defaults to 'docs')\n * @returns the settings for the mkdocs.yml\n */\nexport const getRepoUrlFromLocationAnnotation = (\n  parsedLocationAnnotation: ParsedLocationAnnotation,\n  scmIntegrations: ScmIntegrationRegistry,\n  docsFolder: string = 'docs',\n): { repo_url?: string; edit_uri?: string } => {\n  const { type: locationType, target } = parsedLocationAnnotation;\n\n  if (locationType === 'url') {\n    const integration = scmIntegrations.byUrl(target);\n\n    // We only support it for github and gitlab for now as the edit_uri\n    // is not properly supported for others yet.\n    if (integration && ['github', 'gitlab'].includes(integration.type)) {\n      // handle the case where a user manually writes url:https://github.com/backstage/backstage i.e. without /blob/...\n      const { filepathtype } = gitUrlParse(target);\n      if (filepathtype === '') {\n        return { repo_url: target };\n      }\n\n      const sourceFolder = integration.resolveUrl({\n        url: `./${docsFolder}`,\n        base: target,\n      });\n      return { edit_uri: integration.resolveEditUrl(sourceFolder) };\n    }\n  }\n\n  return {};\n};\n\nclass UnknownTag {\n  constructor(public readonly data: any, public readonly type?: string) {}\n}\n\nexport const MKDOCS_SCHEMA = DEFAULT_SCHEMA.extend([\n  new Type('', {\n    kind: 'scalar',\n    multi: true,\n    representName: o => (o as UnknownTag).type,\n    represent: o => (o as UnknownTag).data ?? '',\n    instanceOf: UnknownTag,\n    construct: (data: string, type?: string) => new UnknownTag(data, type),\n  }),\n]);\n\n/**\n * Finds and loads the contents of either an mkdocs.yml or mkdocs.yaml file,\n * depending on which is present (MkDocs supports both as of v1.2.2).\n *\n * @param inputDir - base dir to be searched for either an mkdocs.yml or\n *   mkdocs.yaml file.\n */\nexport const getMkdocsYml = async (\n  inputDir: string,\n): Promise<{ path: string; content: string }> => {\n  let mkdocsYmlPath: string;\n  let mkdocsYmlFileString: string;\n  try {\n    mkdocsYmlPath = path.join(inputDir, 'mkdocs.yaml');\n    mkdocsYmlFileString = await fs.readFile(mkdocsYmlPath, 'utf8');\n  } catch {\n    try {\n      mkdocsYmlPath = path.join(inputDir, 'mkdocs.yml');\n      mkdocsYmlFileString = await fs.readFile(mkdocsYmlPath, 'utf8');\n    } catch (error) {\n      throw new ForwardedError(\n        'Could not read MkDocs YAML config file mkdocs.yml or mkdocs.yaml for validation',\n        error,\n      );\n    }\n  }\n\n  return {\n    path: mkdocsYmlPath,\n    content: mkdocsYmlFileString,\n  };\n};\n\n/**\n * Validating mkdocs config file for incorrect/insecure values\n * Throws on invalid configs\n *\n * @param inputDir - base dir to be used as a docs_dir path validity check\n * @param mkdocsYmlFileString - The string contents of the loaded\n *   mkdocs.yml or equivalent of a docs site\n * @returns the parsed docs_dir or undefined\n */\nexport const validateMkdocsYaml = async (\n  inputDir: string,\n  mkdocsYmlFileString: string,\n): Promise<string | undefined> => {\n  const mkdocsYml = yaml.load(mkdocsYmlFileString, {\n    schema: MKDOCS_SCHEMA,\n  });\n\n  if (mkdocsYml === null || typeof mkdocsYml !== 'object') {\n    return undefined;\n  }\n\n  const parsedMkdocsYml: Record<string, any> = mkdocsYml;\n  if (\n    parsedMkdocsYml.docs_dir &&\n    !isChildPath(inputDir, resolvePath(inputDir, parsedMkdocsYml.docs_dir))\n  ) {\n    throw new Error(\n      `docs_dir configuration value in mkdocs can't be an absolute directory or start with ../ for security reasons.\n       Use relative paths instead which are resolved relative to your mkdocs.yml file location.`,\n    );\n  }\n  return parsedMkdocsYml.docs_dir;\n};\n\n/**\n * Update docs/index.md file before TechDocs generator uses it to generate docs site,\n * falling back to docs/README.md or README.md in case a default docs/index.md\n * is not provided.\n */\nexport const patchIndexPreBuild = async ({\n  inputDir,\n  logger,\n  docsDir = 'docs',\n}: {\n  inputDir: string;\n  logger: Logger;\n  docsDir?: string;\n}) => {\n  const docsPath = path.join(inputDir, docsDir);\n  const indexMdPath = path.join(docsPath, 'index.md');\n\n  if (await fs.pathExists(indexMdPath)) {\n    return;\n  }\n  logger.warn(`${path.join(docsDir, 'index.md')} not found.`);\n  const fallbacks = [\n    path.join(docsPath, 'README.md'),\n    path.join(docsPath, 'readme.md'),\n    path.join(inputDir, 'README.md'),\n    path.join(inputDir, 'readme.md'),\n  ];\n\n  await fs.ensureDir(docsPath);\n  for (const filePath of fallbacks) {\n    try {\n      await fs.copyFile(filePath, indexMdPath);\n      return;\n    } catch (error) {\n      logger.warn(`${path.relative(inputDir, filePath)} not found.`);\n    }\n  }\n\n  logger.warn(\n    `Could not find any techdocs' index file. Please make sure at least one of ${[\n      indexMdPath,\n      ...fallbacks,\n    ].join(' ')} exists.`,\n  );\n};\n\n/**\n * Create or update the techdocs_metadata.json. Values initialized/updated are:\n * - The build_timestamp (now)\n * - The list of files generated\n *\n * @param techdocsMetadataPath - File path to techdocs_metadata.json\n */\nexport const createOrUpdateMetadata = async (\n  techdocsMetadataPath: string,\n  logger: Logger,\n): Promise<void> => {\n  const techdocsMetadataDir = techdocsMetadataPath\n    .split(path.sep)\n    .slice(0, -1)\n    .join(path.sep);\n  // check if file exists, create if it does not.\n  try {\n    await fs.access(techdocsMetadataPath, fs.constants.F_OK);\n  } catch (err) {\n    // Bootstrap file with empty JSON\n    await fs.writeJson(techdocsMetadataPath, JSON.parse('{}'));\n  }\n  // check if valid Json\n  let json;\n  try {\n    json = await fs.readJson(techdocsMetadataPath);\n  } catch (err) {\n    assertError(err);\n    const message = `Invalid JSON at ${techdocsMetadataPath} with error ${err.message}`;\n    logger.error(message);\n    throw new Error(message);\n  }\n\n  json.build_timestamp = Date.now();\n\n  // Get and write generated files to the metadata JSON. Each file string is in\n  // a form appropriate for invalidating the associated object from cache.\n  try {\n    json.files = (await getFileTreeRecursively(techdocsMetadataDir)).map(file =>\n      file.replace(`${techdocsMetadataDir}${path.sep}`, ''),\n    );\n  } catch (err) {\n    assertError(err);\n    json.files = [];\n    logger.warn(`Unable to add files list to metadata: ${err.message}`);\n  }\n\n  await fs.writeJson(techdocsMetadataPath, json);\n  return;\n};\n\n/**\n * Update the techdocs_metadata.json to add etag of the prepared tree (e.g. commit SHA or actual Etag of the resource).\n * This is helpful to check if a TechDocs site in storage has gone outdated, without maintaining an in-memory build info\n * per Backstage instance.\n *\n * @param techdocsMetadataPath - File path to techdocs_metadata.json\n * @param etag - The ETag to use\n */\nexport const storeEtagMetadata = async (\n  techdocsMetadataPath: string,\n  etag: string,\n): Promise<void> => {\n  const json = await fs.readJson(techdocsMetadataPath);\n  json.etag = etag;\n  await fs.writeJson(techdocsMetadataPath, json);\n};\n","/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { Logger } from 'winston';\nimport fs from 'fs-extra';\nimport yaml from 'js-yaml';\nimport { ParsedLocationAnnotation } from '../../helpers';\nimport { getRepoUrlFromLocationAnnotation, MKDOCS_SCHEMA } from './helpers';\nimport { assertError } from '@backstage/errors';\nimport { ScmIntegrationRegistry } from '@backstage/integration';\n\ntype MkDocsObject = {\n  plugins?: string[];\n  docs_dir: string;\n  repo_url?: string;\n  edit_uri?: string;\n};\n\nconst patchMkdocsFile = async (\n  mkdocsYmlPath: string,\n  logger: Logger,\n  updateAction: (mkdocsYml: MkDocsObject) => boolean,\n) => {\n  // We only want to override the mkdocs.yml if it has actually changed. This is relevant if\n  // used with a 'dir' location on the file system as this would permanently update the file.\n  let didEdit = false;\n\n  let mkdocsYmlFileString;\n  try {\n    mkdocsYmlFileString = await fs.readFile(mkdocsYmlPath, 'utf8');\n  } catch (error) {\n    assertError(error);\n    logger.warn(\n      `Could not read MkDocs YAML config file ${mkdocsYmlPath} before running the generator: ${error.message}`,\n    );\n    return;\n  }\n\n  let mkdocsYml: any;\n  try {\n    mkdocsYml = yaml.load(mkdocsYmlFileString, { schema: MKDOCS_SCHEMA });\n\n    // mkdocsYml should be an object type after successful parsing.\n    // But based on its type definition, it can also be a string or undefined, which we don't want.\n    if (typeof mkdocsYml === 'string' || typeof mkdocsYml === 'undefined') {\n      throw new Error('Bad YAML format.');\n    }\n  } catch (error) {\n    assertError(error);\n    logger.warn(\n      `Error in parsing YAML at ${mkdocsYmlPath} before running the generator. ${error.message}`,\n    );\n    return;\n  }\n\n  didEdit = updateAction(mkdocsYml);\n\n  try {\n    if (didEdit) {\n      await fs.writeFile(\n        mkdocsYmlPath,\n        yaml.dump(mkdocsYml, { schema: MKDOCS_SCHEMA }),\n        'utf8',\n      );\n    }\n  } catch (error) {\n    assertError(error);\n    logger.warn(\n      `Could not write to ${mkdocsYmlPath} after updating it before running the generator. ${error.message}`,\n    );\n    return;\n  }\n};\n\n/**\n * Update the mkdocs.yml file before TechDocs generator uses it to generate docs site.\n *\n * List of tasks:\n * - Add repo_url or edit_uri if it does not exists\n * If mkdocs.yml has a repo_url, the generated docs site gets an Edit button on the pages by default.\n * If repo_url is missing in mkdocs.yml, we will use techdocs annotation of the entity to possibly get\n * the repository URL.\n *\n * This function will not throw an error since this is not critical to the whole TechDocs pipeline.\n * Instead it will log warnings if there are any errors in reading, parsing or writing YAML.\n *\n * @param mkdocsYmlPath - Absolute path to mkdocs.yml or equivalent of a docs site\n * @param logger - A logger instance\n * @param parsedLocationAnnotation - Object with location url and type\n * @param scmIntegrations - the scmIntegration to do url transformations\n */\nexport const patchMkdocsYmlPreBuild = async (\n  mkdocsYmlPath: string,\n  logger: Logger,\n  parsedLocationAnnotation: ParsedLocationAnnotation,\n  scmIntegrations: ScmIntegrationRegistry,\n) => {\n  await patchMkdocsFile(mkdocsYmlPath, logger, mkdocsYml => {\n    if (!('repo_url' in mkdocsYml) && !('edit_uri' in mkdocsYml)) {\n      // Add edit_uri and/or repo_url to mkdocs.yml if it is missing.\n      // This will enable the Page edit button generated by MkDocs.\n      // If the either has been set, keep the original value\n      const result = getRepoUrlFromLocationAnnotation(\n        parsedLocationAnnotation,\n        scmIntegrations,\n        mkdocsYml.docs_dir,\n      );\n\n      if (result.repo_url || result.edit_uri) {\n        mkdocsYml.repo_url = result.repo_url;\n        mkdocsYml.edit_uri = result.edit_uri;\n\n        logger.info(\n          `Set ${JSON.stringify(\n            result,\n          )}. You can disable this feature by manually setting 'repo_url' or 'edit_uri' according to the MkDocs documentation at https://www.mkdocs.org/user-guide/configuration/#repo_url`,\n        );\n        return true;\n      }\n    }\n    return false;\n  });\n};\n\n/**\n * Update the mkdocs.yml file before TechDocs generator uses it to generate docs site.\n *\n * List of tasks:\n * - Add techdocs-core plugin to mkdocs file if it doesn't exist\n *\n * This function will not throw an error since this is not critical to the whole TechDocs pipeline.\n * Instead it will log warnings if there are any errors in reading, parsing or writing YAML.\n *\n * @param mkdocsYmlPath - Absolute path to mkdocs.yml or equivalent of a docs site\n * @param logger - A logger instance\n */\nexport const pathMkdocsYmlWithTechdocsPlugin = async (\n  mkdocsYmlPath: string,\n  logger: Logger,\n) => {\n  await patchMkdocsFile(mkdocsYmlPath, logger, mkdocsYml => {\n    // Modify mkdocs.yaml to contain the needed techdocs-core plugin if it is not there\n    if (!('plugins' in mkdocsYml)) {\n      mkdocsYml.plugins = ['techdocs-core'];\n      return true;\n    }\n\n    if (mkdocsYml.plugins && !mkdocsYml.plugins.includes('techdocs-core')) {\n      mkdocsYml.plugins.push('techdocs-core');\n      return true;\n    }\n    return false;\n  });\n};\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { ContainerRunner } from '@backstage/backend-common';\nimport { Config } from '@backstage/config';\nimport path from 'path';\nimport { Logger } from 'winston';\nimport {\n  ScmIntegrationRegistry,\n  ScmIntegrations,\n} from '@backstage/integration';\nimport {\n  createOrUpdateMetadata,\n  getMkdocsYml,\n  patchIndexPreBuild,\n  runCommand,\n  storeEtagMetadata,\n  validateMkdocsYaml,\n} from './helpers';\n\nimport {\n  patchMkdocsYmlPreBuild,\n  pathMkdocsYmlWithTechdocsPlugin,\n} from './mkDocsPatchers';\nimport {\n  GeneratorBase,\n  GeneratorConfig,\n  GeneratorOptions,\n  GeneratorRunInType,\n  GeneratorRunOptions,\n} from './types';\nimport { ForwardedError } from '@backstage/errors';\n\n/**\n * Generates documentation files\n * @public\n */\nexport class TechdocsGenerator implements GeneratorBase {\n  /**\n   * The default docker image (and version) used to generate content. Public\n   * and static so that techdocs-node consumers can use the same version.\n   */\n  public static readonly defaultDockerImage = 'spotify/techdocs:v0.3.7';\n  private readonly logger: Logger;\n  private readonly containerRunner: ContainerRunner;\n  private readonly options: GeneratorConfig;\n  private readonly scmIntegrations: ScmIntegrationRegistry;\n\n  /**\n   * Returns a instance of TechDocs generator\n   * @param config - A Backstage configuration\n   * @param options - Options to configure the generator\n   */\n  static fromConfig(config: Config, options: GeneratorOptions) {\n    const { containerRunner, logger } = options;\n    const scmIntegrations = ScmIntegrations.fromConfig(config);\n    return new TechdocsGenerator({\n      logger,\n      containerRunner,\n      config,\n      scmIntegrations,\n    });\n  }\n\n  constructor(options: {\n    logger: Logger;\n    containerRunner: ContainerRunner;\n    config: Config;\n    scmIntegrations: ScmIntegrationRegistry;\n  }) {\n    this.logger = options.logger;\n    this.options = readGeneratorConfig(options.config, options.logger);\n    this.containerRunner = options.containerRunner;\n    this.scmIntegrations = options.scmIntegrations;\n  }\n\n  /** {@inheritDoc GeneratorBase.run} */\n  public async run(options: GeneratorRunOptions): Promise<void> {\n    const {\n      inputDir,\n      outputDir,\n      parsedLocationAnnotation,\n      etag,\n      logger: childLogger,\n      logStream,\n    } = options;\n\n    // Do some updates to mkdocs.yml before generating docs e.g. adding repo_url\n    const { path: mkdocsYmlPath, content } = await getMkdocsYml(inputDir);\n\n    // validate the docs_dir first\n    const docsDir = await validateMkdocsYaml(inputDir, content);\n\n    if (parsedLocationAnnotation) {\n      await patchMkdocsYmlPreBuild(\n        mkdocsYmlPath,\n        childLogger,\n        parsedLocationAnnotation,\n        this.scmIntegrations,\n      );\n      await patchIndexPreBuild({ inputDir, logger: childLogger, docsDir });\n    }\n\n    if (!this.options.omitTechdocsCoreMkdocsPlugin) {\n      await pathMkdocsYmlWithTechdocsPlugin(mkdocsYmlPath, childLogger);\n    }\n\n    // Directories to bind on container\n    const mountDirs = {\n      [inputDir]: '/input',\n      [outputDir]: '/output',\n    };\n\n    try {\n      switch (this.options.runIn) {\n        case 'local':\n          await runCommand({\n            command: 'mkdocs',\n            args: ['build', '-d', outputDir, '-v'],\n            options: {\n              cwd: inputDir,\n            },\n            logStream,\n          });\n          childLogger.info(\n            `Successfully generated docs from ${inputDir} into ${outputDir} using local mkdocs`,\n          );\n          break;\n        case 'docker':\n          await this.containerRunner.runContainer({\n            imageName:\n              this.options.dockerImage ?? TechdocsGenerator.defaultDockerImage,\n            args: ['build', '-d', '/output'],\n            logStream,\n            mountDirs,\n            workingDir: '/input',\n            // Set the home directory inside the container as something that applications can\n            // write to, otherwise they will just fail trying to write to /\n            envVars: { HOME: '/tmp' },\n            pullImage: this.options.pullImage,\n          });\n          childLogger.info(\n            `Successfully generated docs from ${inputDir} into ${outputDir} using techdocs-container`,\n          );\n          break;\n        default:\n          throw new Error(\n            `Invalid config value \"${this.options.runIn}\" provided in 'techdocs.generators.techdocs'.`,\n          );\n      }\n    } catch (error) {\n      this.logger.debug(\n        `Failed to generate docs from ${inputDir} into ${outputDir}`,\n      );\n      throw new ForwardedError(\n        `Failed to generate docs from ${inputDir} into ${outputDir}`,\n        error,\n      );\n    }\n\n    /**\n     * Post Generate steps\n     */\n\n    // Add build timestamp and files to techdocs_metadata.json\n    // Creates techdocs_metadata.json if file does not exist.\n    await createOrUpdateMetadata(\n      path.join(outputDir, 'techdocs_metadata.json'),\n      childLogger,\n    );\n\n    // Add etag of the prepared tree to techdocs_metadata.json\n    // Assumes that the file already exists.\n    if (etag) {\n      await storeEtagMetadata(\n        path.join(outputDir, 'techdocs_metadata.json'),\n        etag,\n      );\n    }\n  }\n}\n\nexport function readGeneratorConfig(\n  config: Config,\n  logger: Logger,\n): GeneratorConfig {\n  const legacyGeneratorType = config.getOptionalString(\n    'techdocs.generators.techdocs',\n  ) as GeneratorRunInType;\n\n  if (legacyGeneratorType) {\n    logger.warn(\n      `The 'techdocs.generators.techdocs' configuration key is deprecated and will be removed in the future. Please use 'techdocs.generator' instead. ` +\n        `See here https://backstage.io/docs/features/techdocs/configuration`,\n    );\n  }\n\n  return {\n    runIn:\n      legacyGeneratorType ??\n      config.getOptionalString('techdocs.generator.runIn') ??\n      'docker',\n    dockerImage: config.getOptionalString('techdocs.generator.dockerImage'),\n    pullImage: config.getOptionalBoolean('techdocs.generator.pullImage'),\n    omitTechdocsCoreMkdocsPlugin: config.getOptionalBoolean(\n      'techdocs.generator.mkdocs.omitTechdocsCorePlugin',\n    ),\n  };\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { ContainerRunner } from '@backstage/backend-common';\nimport { Entity } from '@backstage/catalog-model';\nimport { Config } from '@backstage/config';\nimport { Logger } from 'winston';\nimport { getGeneratorKey } from './helpers';\nimport { TechdocsGenerator } from './techdocs';\nimport {\n  GeneratorBase,\n  GeneratorBuilder,\n  SupportedGeneratorKey,\n} from './types';\n\n/**\n * Collection of docs generators\n * @public\n */\nexport class Generators implements GeneratorBuilder {\n  private generatorMap = new Map<SupportedGeneratorKey, GeneratorBase>();\n\n  /**\n   * Returns a generators instance containing a generator for TechDocs\n   * @param config - A Backstage configuration\n   * @param options - Options to configure the TechDocs generator\n   */\n  static async fromConfig(\n    config: Config,\n    options: { logger: Logger; containerRunner: ContainerRunner },\n  ): Promise<GeneratorBuilder> {\n    const generators = new Generators();\n\n    const techdocsGenerator = TechdocsGenerator.fromConfig(config, options);\n    generators.register('techdocs', techdocsGenerator);\n\n    return generators;\n  }\n\n  /**\n   * Register a generator in the generators collection\n   * @param generatorKey - Unique identifier for the generator\n   * @param generator - The generator instance to register\n   */\n  register(generatorKey: SupportedGeneratorKey, generator: GeneratorBase) {\n    this.generatorMap.set(generatorKey, generator);\n  }\n\n  /**\n   * Returns the generator for a given TechDocs entity\n   * @param entity - A TechDocs entity instance\n   */\n  get(entity: Entity): GeneratorBase {\n    const generatorKey = getGeneratorKey(entity);\n    const generator = this.generatorMap.get(generatorKey);\n\n    if (!generator) {\n      throw new Error(`No generator registered for entity: \"${generatorKey}\"`);\n    }\n\n    return generator;\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { resolveSafeChildPath, UrlReader } from '@backstage/backend-common';\nimport {\n  Entity,\n  getEntitySourceLocation,\n  parseLocationRef,\n} from '@backstage/catalog-model';\nimport { InputError } from '@backstage/errors';\nimport { ScmIntegrationRegistry } from '@backstage/integration';\nimport path from 'path';\nimport { Logger } from 'winston';\nimport { PreparerResponse, RemoteProtocol } from './stages/prepare/types';\n\n/**\n * Parsed location annotation\n * @public\n */\nexport type ParsedLocationAnnotation = {\n  type: RemoteProtocol;\n  target: string;\n};\n\n/**\n * Returns a parset locations annotation\n * @public\n * @param annotationName - The name of the annotation in the entity metadata\n * @param entity - A TechDocs entity instance\n */\nexport const parseReferenceAnnotation = (\n  annotationName: string,\n  entity: Entity,\n): ParsedLocationAnnotation => {\n  const annotation = entity.metadata.annotations?.[annotationName];\n  if (!annotation) {\n    throw new InputError(\n      `No location annotation provided in entity: ${entity.metadata.name}`,\n    );\n  }\n\n  const { type, target } = parseLocationRef(annotation);\n  return {\n    type: type as RemoteProtocol,\n    target,\n  };\n};\n\n/**\n * TechDocs references of type `dir` are relative the source location of the entity.\n * This function transforms relative references to absolute ones, based on the\n * location the entity was ingested from. If the entity was registered by a `url`\n * location, it returns a `url` location with a resolved target that points to the\n * targeted subfolder. If the entity was registered by a `file` location, it returns\n * an absolute `dir` location.\n * @public\n * @param entity - the entity with annotations\n * @param dirAnnotation - the parsed techdocs-ref annotation of type 'dir'\n * @param scmIntegrations - access to the scmIntegration to do url transformations\n * @throws if the entity doesn't specify a `dir` location or is ingested from an unsupported location.\n * @returns the transformed location with an absolute target.\n */\nexport const transformDirLocation = (\n  entity: Entity,\n  dirAnnotation: ParsedLocationAnnotation,\n  scmIntegrations: ScmIntegrationRegistry,\n): { type: 'dir' | 'url'; target: string } => {\n  const location = getEntitySourceLocation(entity);\n\n  switch (location.type) {\n    case 'url': {\n      const target = scmIntegrations.resolveUrl({\n        url: dirAnnotation.target,\n        base: location.target,\n      });\n\n      return {\n        type: 'url',\n        target,\n      };\n    }\n\n    case 'file': {\n      // only permit targets in the same folder as the target of the `file` location!\n      const target = resolveSafeChildPath(\n        path.dirname(location.target),\n        dirAnnotation.target,\n      );\n\n      return {\n        type: 'dir',\n        target,\n      };\n    }\n\n    default:\n      throw new InputError(`Unable to resolve location type ${location.type}`);\n  }\n};\n\n/**\n * Returns a entity reference based on the TechDocs annotation type\n * @public\n * @param entity - A TechDocs instance\n * @param scmIntegration - An implementation for  SCM integration API\n */\nexport const getLocationForEntity = (\n  entity: Entity,\n  scmIntegration: ScmIntegrationRegistry,\n): ParsedLocationAnnotation => {\n  const annotation = parseReferenceAnnotation(\n    'backstage.io/techdocs-ref',\n    entity,\n  );\n\n  switch (annotation.type) {\n    case 'url':\n      return annotation;\n    case 'dir':\n      return transformDirLocation(entity, annotation, scmIntegration);\n    default:\n      throw new Error(`Invalid reference annotation ${annotation.type}`);\n  }\n};\n\n/**\n * Returns a preparer response {@link PreparerResponse}\n * @public\n * @param reader - Read a tree of files from a repository\n * @param entity - A TechDocs entity instance\n * @param opts - Options for configuring the reader, e.g. logger, etag, etc.\n */\nexport const getDocFilesFromRepository = async (\n  reader: UrlReader,\n  entity: Entity,\n  opts?: { etag?: string; logger?: Logger },\n): Promise<PreparerResponse> => {\n  const { target } = parseReferenceAnnotation(\n    'backstage.io/techdocs-ref',\n    entity,\n  );\n\n  opts?.logger?.debug(`Reading files from ${target}`);\n  // readTree will throw NotModifiedError if etag has not changed.\n  const readTreeResponse = await reader.readTree(target, { etag: opts?.etag });\n  const preparedDir = await readTreeResponse.dir();\n\n  opts?.logger?.debug(`Tree downloaded and stored at ${preparedDir}`);\n\n  return {\n    preparedDir,\n    etag: readTreeResponse.etag,\n  };\n};\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { UrlReader } from '@backstage/backend-common';\nimport { Entity } from '@backstage/catalog-model';\nimport { Config } from '@backstage/config';\nimport { InputError } from '@backstage/errors';\nimport {\n  ScmIntegrationRegistry,\n  ScmIntegrations,\n} from '@backstage/integration';\nimport { Logger } from 'winston';\nimport { parseReferenceAnnotation, transformDirLocation } from '../../helpers';\nimport {\n  PreparerBase,\n  PreparerConfig,\n  PreparerOptions,\n  PreparerResponse,\n} from './types';\n\n/**\n * Preparer used to retrieve documentation files from a local directory\n * @public\n */\nexport class DirectoryPreparer implements PreparerBase {\n  private readonly scmIntegrations: ScmIntegrationRegistry;\n  private readonly reader: UrlReader;\n\n  /**\n   * Returns a directory preparer instance\n   * @param config - A backstage config\n   * @param options - A directory preparer options containing a logger and reader\n   */\n  static fromConfig(\n    config: Config,\n    { logger, reader }: PreparerConfig,\n  ): DirectoryPreparer {\n    return new DirectoryPreparer(config, logger, reader);\n  }\n\n  private constructor(\n    config: Config,\n    _logger: Logger | null,\n    reader: UrlReader,\n  ) {\n    this.reader = reader;\n    this.scmIntegrations = ScmIntegrations.fromConfig(config);\n  }\n\n  /** {@inheritDoc PreparerBase.prepare} */\n  async prepare(\n    entity: Entity,\n    options?: PreparerOptions,\n  ): Promise<PreparerResponse> {\n    const annotation = parseReferenceAnnotation(\n      'backstage.io/techdocs-ref',\n      entity,\n    );\n    const { type, target } = transformDirLocation(\n      entity,\n      annotation,\n      this.scmIntegrations,\n    );\n\n    switch (type) {\n      case 'url': {\n        options?.logger?.debug(`Reading files from ${target}`);\n        // the target is an absolute url since it has already been transformed\n        const response = await this.reader.readTree(target, {\n          etag: options?.etag,\n        });\n        const preparedDir = await response.dir();\n\n        options?.logger?.debug(`Tree downloaded and stored at ${preparedDir}`);\n\n        return {\n          preparedDir,\n          etag: response.etag,\n        };\n      }\n\n      case 'dir': {\n        return {\n          // the transformation already validated that the target is in a safe location\n          preparedDir: target,\n          // Instead of supporting caching on local sources, use techdocs-cli for local development and debugging.\n          etag: '',\n        };\n      }\n\n      default:\n        throw new InputError(`Unable to resolve location type ${type}`);\n    }\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { assertError } from '@backstage/errors';\nimport { UrlReader } from '@backstage/backend-common';\nimport { Entity } from '@backstage/catalog-model';\nimport { Logger } from 'winston';\nimport { getDocFilesFromRepository } from '../../helpers';\nimport {\n  PreparerBase,\n  PreparerConfig,\n  PreparerOptions,\n  PreparerResponse,\n} from './types';\n\n/**\n * Preparer used to retrieve documentation files from a remote repository\n * @public\n */\nexport class UrlPreparer implements PreparerBase {\n  private readonly logger: Logger;\n  private readonly reader: UrlReader;\n\n  /**\n   * Returns a directory preparer instance\n   * @param config - A URL preparer config containing the a logger and reader\n   */\n  static fromConfig({ reader, logger }: PreparerConfig): UrlPreparer {\n    return new UrlPreparer(reader, logger);\n  }\n\n  private constructor(reader: UrlReader, logger: Logger) {\n    this.logger = logger;\n    this.reader = reader;\n  }\n\n  /** {@inheritDoc PreparerBase.prepare} */\n  async prepare(\n    entity: Entity,\n    options?: PreparerOptions,\n  ): Promise<PreparerResponse> {\n    try {\n      return await getDocFilesFromRepository(this.reader, entity, {\n        etag: options?.etag,\n        logger: this.logger,\n      });\n    } catch (error) {\n      assertError(error);\n      // NotModifiedError means that etag based cache is still valid.\n      if (error.name === 'NotModifiedError') {\n        this.logger.debug(`Cache is valid for etag ${options?.etag}`);\n      } else {\n        this.logger.debug(\n          `Unable to fetch files for building docs ${error.message}`,\n        );\n      }\n\n      throw error;\n    }\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { Entity } from '@backstage/catalog-model';\nimport { Config } from '@backstage/config';\nimport { parseReferenceAnnotation } from '../../helpers';\nimport { DirectoryPreparer } from './dir';\nimport { UrlPreparer } from './url';\nimport {\n  PreparerBase,\n  PreparerBuilder,\n  PreparerConfig,\n  RemoteProtocol,\n} from './types';\n\n/**\n * Collection of docs preparers (dir and url)\n * @public\n */\nexport class Preparers implements PreparerBuilder {\n  private preparerMap = new Map<RemoteProtocol, PreparerBase>();\n\n  /**\n   * Returns a generators instance containing a generator for TechDocs\n   * @public\n   * @param backstageConfig - A Backstage configuration\n   * @param preparerConfig - Options to configure preparers\n   */\n  static async fromConfig(\n    backstageConfig: Config,\n    { logger, reader }: PreparerConfig,\n  ): Promise<PreparerBuilder> {\n    const preparers = new Preparers();\n\n    const urlPreparer = UrlPreparer.fromConfig({ reader, logger });\n    preparers.register('url', urlPreparer);\n\n    /**\n     * Dir preparer is a syntactic sugar for users to define techdocs-ref annotation.\n     * When using dir preparer, the docs will be fetched using URL Reader.\n     */\n    const directoryPreparer = DirectoryPreparer.fromConfig(backstageConfig, {\n      logger,\n      reader,\n    });\n    preparers.register('dir', directoryPreparer);\n\n    return preparers;\n  }\n\n  /**\n   * Register a preparer in the preparers collection\n   * @param protocol - url or dir to associate with preparer\n   * @param preparer - The preparer instance to set\n   */\n  register(protocol: RemoteProtocol, preparer: PreparerBase) {\n    this.preparerMap.set(protocol, preparer);\n  }\n\n  /**\n   * Returns the preparer for a given TechDocs entity\n   * @param entity - A TechDocs entity instance\n   * @returns\n   */\n  get(entity: Entity): PreparerBase {\n    const { type } = parseReferenceAnnotation(\n      'backstage.io/techdocs-ref',\n      entity,\n    );\n    const preparer = this.preparerMap.get(type);\n\n    if (!preparer) {\n      throw new Error(`No preparer registered for type: \"${type}\"`);\n    }\n\n    return preparer;\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { Entity, CompoundEntityRef } from '@backstage/catalog-model';\nimport { Config } from '@backstage/config';\nimport { assertError, ForwardedError } from '@backstage/errors';\nimport aws, { Credentials } from 'aws-sdk';\nimport { ListObjectsV2Output } from 'aws-sdk/clients/s3';\nimport { CredentialsOptions } from 'aws-sdk/lib/credentials';\nimport express from 'express';\nimport fs from 'fs-extra';\nimport JSON5 from 'json5';\nimport createLimiter from 'p-limit';\nimport path from 'path';\nimport { Readable } from 'stream';\nimport { Logger } from 'winston';\nimport {\n  bulkStorageOperation,\n  getCloudPathForLocalPath,\n  getFileTreeRecursively,\n  getHeadersForFileExtension,\n  getStaleFiles,\n  lowerCaseEntityTriplet,\n  lowerCaseEntityTripletInStoragePath,\n  normalizeExternalStorageRootPath,\n} from './helpers';\nimport {\n  PublisherBase,\n  PublishRequest,\n  PublishResponse,\n  ReadinessResponse,\n  TechDocsMetadata,\n} from './types';\n\nconst streamToBuffer = (stream: Readable): Promise<Buffer> => {\n  return new Promise((resolve, reject) => {\n    try {\n      const chunks: any[] = [];\n      stream.on('data', chunk => chunks.push(chunk));\n      stream.on('error', reject);\n      stream.on('end', () => resolve(Buffer.concat(chunks)));\n    } catch (e) {\n      throw new ForwardedError('Unable to parse the response data', e);\n    }\n  });\n};\n\nexport class AwsS3Publish implements PublisherBase {\n  private readonly storageClient: aws.S3;\n  private readonly bucketName: string;\n  private readonly legacyPathCasing: boolean;\n  private readonly logger: Logger;\n  private readonly bucketRootPath: string;\n  private readonly sse?: 'aws:kms' | 'AES256';\n\n  constructor(options: {\n    storageClient: aws.S3;\n    bucketName: string;\n    legacyPathCasing: boolean;\n    logger: Logger;\n    bucketRootPath: string;\n    sse?: 'aws:kms' | 'AES256';\n  }) {\n    this.storageClient = options.storageClient;\n    this.bucketName = options.bucketName;\n    this.legacyPathCasing = options.legacyPathCasing;\n    this.logger = options.logger;\n    this.bucketRootPath = options.bucketRootPath;\n    this.sse = options.sse;\n  }\n\n  static fromConfig(config: Config, logger: Logger): PublisherBase {\n    let bucketName = '';\n    try {\n      bucketName = config.getString('techdocs.publisher.awsS3.bucketName');\n    } catch (error) {\n      throw new Error(\n        \"Since techdocs.publisher.type is set to 'awsS3' in your app config, \" +\n          'techdocs.publisher.awsS3.bucketName is required.',\n      );\n    }\n\n    const bucketRootPath = normalizeExternalStorageRootPath(\n      config.getOptionalString('techdocs.publisher.awsS3.bucketRootPath') || '',\n    );\n\n    const sse = config.getOptionalString('techdocs.publisher.awsS3.sse') as\n      | 'aws:kms'\n      | 'AES256'\n      | undefined;\n\n    // Credentials is an optional config. If missing, the default ways of authenticating AWS SDK V2 will be used.\n    // 1. AWS environment variables\n    // https://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/loading-node-credentials-environment.html\n    // 2. AWS shared credentials file at ~/.aws/credentials\n    // https://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/loading-node-credentials-shared.html\n    // 3. IAM Roles for EC2\n    // https://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/loading-node-credentials-iam.html\n    const credentialsConfig = config.getOptionalConfig(\n      'techdocs.publisher.awsS3.credentials',\n    );\n    const credentials = AwsS3Publish.buildCredentials(credentialsConfig);\n\n    // AWS Region is an optional config. If missing, default AWS env variable AWS_REGION\n    // or AWS shared credentials file at ~/.aws/credentials will be used.\n    const region = config.getOptionalString('techdocs.publisher.awsS3.region');\n\n    // AWS endpoint is an optional config. If missing, the default endpoint is built from\n    // the configured region.\n    const endpoint = config.getOptionalString(\n      'techdocs.publisher.awsS3.endpoint',\n    );\n\n    // AWS forcePathStyle is an optional config. If missing, it defaults to false. Needs to be enabled for cases\n    // where endpoint url points to locally hosted S3 compatible storage like Localstack\n    const s3ForcePathStyle = config.getOptionalBoolean(\n      'techdocs.publisher.awsS3.s3ForcePathStyle',\n    );\n\n    const storageClient = new aws.S3({\n      credentials,\n      ...(region && { region }),\n      ...(endpoint && { endpoint }),\n      ...(s3ForcePathStyle && { s3ForcePathStyle }),\n    });\n\n    const legacyPathCasing =\n      config.getOptionalBoolean(\n        'techdocs.legacyUseCaseSensitiveTripletPaths',\n      ) || false;\n\n    return new AwsS3Publish({\n      storageClient,\n      bucketName,\n      bucketRootPath,\n      legacyPathCasing,\n      logger,\n      sse,\n    });\n  }\n\n  private static buildCredentials(\n    config?: Config,\n  ): Credentials | CredentialsOptions | undefined {\n    if (!config) {\n      return undefined;\n    }\n\n    const accessKeyId = config.getOptionalString('accessKeyId');\n    const secretAccessKey = config.getOptionalString('secretAccessKey');\n    let explicitCredentials: Credentials | undefined;\n    if (accessKeyId && secretAccessKey) {\n      explicitCredentials = new Credentials({\n        accessKeyId,\n        secretAccessKey,\n      });\n    }\n\n    const roleArn = config.getOptionalString('roleArn');\n    if (roleArn) {\n      return new aws.ChainableTemporaryCredentials({\n        masterCredentials: explicitCredentials,\n        params: {\n          RoleSessionName: 'backstage-aws-techdocs-s3-publisher',\n          RoleArn: roleArn,\n        },\n      });\n    }\n\n    return explicitCredentials;\n  }\n\n  /**\n   * Check if the defined bucket exists. Being able to connect means the configuration is good\n   * and the storage client will work.\n   */\n  async getReadiness(): Promise<ReadinessResponse> {\n    try {\n      await this.storageClient\n        .headBucket({ Bucket: this.bucketName })\n        .promise();\n\n      this.logger.info(\n        `Successfully connected to the AWS S3 bucket ${this.bucketName}.`,\n      );\n\n      return { isAvailable: true };\n    } catch (error) {\n      this.logger.error(\n        `Could not retrieve metadata about the AWS S3 bucket ${this.bucketName}. ` +\n          'Make sure the bucket exists. Also make sure that authentication is setup either by ' +\n          'explicitly defining credentials and region in techdocs.publisher.awsS3 in app config or ' +\n          'by using environment variables. Refer to https://backstage.io/docs/features/techdocs/using-cloud-storage',\n      );\n      this.logger.error(`from AWS client library`, error);\n      return {\n        isAvailable: false,\n      };\n    }\n  }\n\n  /**\n   * Upload all the files from the generated `directory` to the S3 bucket.\n   * Directory structure used in the bucket is - entityNamespace/entityKind/entityName/index.html\n   */\n  async publish({\n    entity,\n    directory,\n  }: PublishRequest): Promise<PublishResponse> {\n    const objects: string[] = [];\n    const useLegacyPathCasing = this.legacyPathCasing;\n    const bucketRootPath = this.bucketRootPath;\n    const sse = this.sse;\n\n    // First, try to retrieve a list of all individual files currently existing\n    let existingFiles: string[] = [];\n    try {\n      const remoteFolder = getCloudPathForLocalPath(\n        entity,\n        undefined,\n        useLegacyPathCasing,\n        bucketRootPath,\n      );\n      existingFiles = await this.getAllObjectsFromBucket({\n        prefix: remoteFolder,\n      });\n    } catch (e) {\n      assertError(e);\n      this.logger.error(\n        `Unable to list files for Entity ${entity.metadata.name}: ${e.message}`,\n      );\n    }\n\n    // Then, merge new files into the same folder\n    let absoluteFilesToUpload;\n    try {\n      // Remove the absolute path prefix of the source directory\n      // Path of all files to upload, relative to the root of the source directory\n      // e.g. ['index.html', 'sub-page/index.html', 'assets/images/favicon.png']\n      absoluteFilesToUpload = await getFileTreeRecursively(directory);\n\n      await bulkStorageOperation(\n        async absoluteFilePath => {\n          const relativeFilePath = path.relative(directory, absoluteFilePath);\n          const fileStream = fs.createReadStream(absoluteFilePath);\n\n          const params = {\n            Bucket: this.bucketName,\n            Key: getCloudPathForLocalPath(\n              entity,\n              relativeFilePath,\n              useLegacyPathCasing,\n              bucketRootPath,\n            ),\n            Body: fileStream,\n            ...(sse && { ServerSideEncryption: sse }),\n          } as aws.S3.PutObjectRequest;\n\n          objects.push(params.Key);\n          return this.storageClient.upload(params).promise();\n        },\n        absoluteFilesToUpload,\n        { concurrencyLimit: 10 },\n      );\n\n      this.logger.info(\n        `Successfully uploaded all the generated files for Entity ${entity.metadata.name}. Total number of files: ${absoluteFilesToUpload.length}`,\n      );\n    } catch (e) {\n      const errorMessage = `Unable to upload file(s) to AWS S3. ${e}`;\n      this.logger.error(errorMessage);\n      throw new Error(errorMessage);\n    }\n\n    // Last, try to remove the files that were *only* present previously\n    try {\n      const relativeFilesToUpload = absoluteFilesToUpload.map(\n        absoluteFilePath =>\n          getCloudPathForLocalPath(\n            entity,\n            path.relative(directory, absoluteFilePath),\n            useLegacyPathCasing,\n            bucketRootPath,\n          ),\n      );\n      const staleFiles = getStaleFiles(relativeFilesToUpload, existingFiles);\n\n      await bulkStorageOperation(\n        async relativeFilePath => {\n          return await this.storageClient\n            .deleteObject({\n              Bucket: this.bucketName,\n              Key: relativeFilePath,\n            })\n            .promise();\n        },\n        staleFiles,\n        { concurrencyLimit: 10 },\n      );\n\n      this.logger.info(\n        `Successfully deleted stale files for Entity ${entity.metadata.name}. Total number of files: ${staleFiles.length}`,\n      );\n    } catch (error) {\n      const errorMessage = `Unable to delete file(s) from AWS S3. ${error}`;\n      this.logger.error(errorMessage);\n    }\n    return { objects };\n  }\n\n  async fetchTechDocsMetadata(\n    entityName: CompoundEntityRef,\n  ): Promise<TechDocsMetadata> {\n    try {\n      return await new Promise<TechDocsMetadata>(async (resolve, reject) => {\n        const entityTriplet = `${entityName.namespace}/${entityName.kind}/${entityName.name}`;\n        const entityDir = this.legacyPathCasing\n          ? entityTriplet\n          : lowerCaseEntityTriplet(entityTriplet);\n\n        const entityRootDir = path.posix.join(this.bucketRootPath, entityDir);\n\n        const stream = this.storageClient\n          .getObject({\n            Bucket: this.bucketName,\n            Key: `${entityRootDir}/techdocs_metadata.json`,\n          })\n          .createReadStream();\n\n        try {\n          const techdocsMetadataJson = await streamToBuffer(stream);\n          if (!techdocsMetadataJson) {\n            throw new Error(\n              `Unable to parse the techdocs metadata file ${entityRootDir}/techdocs_metadata.json.`,\n            );\n          }\n\n          const techdocsMetadata = JSON5.parse(\n            techdocsMetadataJson.toString('utf-8'),\n          );\n\n          resolve(techdocsMetadata);\n        } catch (err) {\n          assertError(err);\n          this.logger.error(err.message);\n          reject(new Error(err.message));\n        }\n      });\n    } catch (e) {\n      throw new ForwardedError('TechDocs metadata fetch failed', e);\n    }\n  }\n\n  /**\n   * Express route middleware to serve static files on a route in techdocs-backend.\n   */\n  docsRouter(): express.Handler {\n    return async (req, res) => {\n      // Decode and trim the leading forward slash\n      const decodedUri = decodeURI(req.path.replace(/^\\//, ''));\n\n      // Root path is removed from the Uri so that legacy casing can be applied\n      // to the entity triplet without manipulating the root path\n      const decodedUriNoRoot = path.relative(this.bucketRootPath, decodedUri);\n\n      // filePath example - /default/component/documented-component/index.html\n      const filePathNoRoot = this.legacyPathCasing\n        ? decodedUriNoRoot\n        : lowerCaseEntityTripletInStoragePath(decodedUriNoRoot);\n\n      // Re-prepend the root path to the relative file path\n      const filePath = path.posix.join(this.bucketRootPath, filePathNoRoot);\n\n      // Files with different extensions (CSS, HTML) need to be served with different headers\n      const fileExtension = path.extname(filePath);\n      const responseHeaders = getHeadersForFileExtension(fileExtension);\n\n      const stream = this.storageClient\n        .getObject({ Bucket: this.bucketName, Key: filePath })\n        .createReadStream();\n      try {\n        // Inject response headers\n        for (const [headerKey, headerValue] of Object.entries(\n          responseHeaders,\n        )) {\n          res.setHeader(headerKey, headerValue);\n        }\n\n        res.send(await streamToBuffer(stream));\n      } catch (err) {\n        assertError(err);\n        this.logger.warn(\n          `TechDocs S3 router failed to serve static files from bucket ${this.bucketName} at key ${filePath}: ${err.message}`,\n        );\n        res.status(404).send('File Not Found');\n      }\n    };\n  }\n\n  /**\n   * A helper function which checks if index.html of an Entity's docs site is available. This\n   * can be used to verify if there are any pre-generated docs available to serve.\n   */\n  async hasDocsBeenGenerated(entity: Entity): Promise<boolean> {\n    try {\n      const entityTriplet = `${entity.metadata.namespace}/${entity.kind}/${entity.metadata.name}`;\n      const entityDir = this.legacyPathCasing\n        ? entityTriplet\n        : lowerCaseEntityTriplet(entityTriplet);\n\n      const entityRootDir = path.posix.join(this.bucketRootPath, entityDir);\n\n      await this.storageClient\n        .headObject({\n          Bucket: this.bucketName,\n          Key: `${entityRootDir}/index.html`,\n        })\n        .promise();\n      return Promise.resolve(true);\n    } catch (e) {\n      return Promise.resolve(false);\n    }\n  }\n\n  async migrateDocsCase({\n    removeOriginal = false,\n    concurrency = 25,\n  }): Promise<void> {\n    // Iterate through every file in the root of the publisher.\n    const allObjects = await this.getAllObjectsFromBucket();\n    const limiter = createLimiter(concurrency);\n    await Promise.all(\n      allObjects.map(f =>\n        limiter(async file => {\n          let newPath;\n          try {\n            newPath = lowerCaseEntityTripletInStoragePath(file);\n          } catch (e) {\n            assertError(e);\n            this.logger.warn(e.message);\n            return;\n          }\n\n          // If all parts are already lowercase, ignore.\n          if (file === newPath) {\n            return;\n          }\n\n          try {\n            this.logger.verbose(`Migrating ${file}`);\n            await this.storageClient\n              .copyObject({\n                Bucket: this.bucketName,\n                CopySource: [this.bucketName, file].join('/'),\n                Key: newPath,\n              })\n              .promise();\n\n            if (removeOriginal) {\n              await this.storageClient\n                .deleteObject({\n                  Bucket: this.bucketName,\n                  Key: file,\n                })\n                .promise();\n            }\n          } catch (e) {\n            assertError(e);\n            this.logger.warn(`Unable to migrate ${file}: ${e.message}`);\n          }\n        }, f),\n      ),\n    );\n  }\n\n  /**\n   * Returns a list of all object keys from the configured bucket.\n   */\n  protected async getAllObjectsFromBucket(\n    { prefix } = { prefix: '' },\n  ): Promise<string[]> {\n    const objects: string[] = [];\n    let nextContinuation: string | undefined;\n    let allObjects: ListObjectsV2Output;\n    // Iterate through every file in the root of the publisher.\n    do {\n      allObjects = await this.storageClient\n        .listObjectsV2({\n          Bucket: this.bucketName,\n          ContinuationToken: nextContinuation,\n          ...(prefix ? { Prefix: prefix } : {}),\n        })\n        .promise();\n      objects.push(\n        ...(allObjects.Contents || []).map(f => f.Key || '').filter(f => !!f),\n      );\n      nextContinuation = allObjects.NextContinuationToken;\n    } while (nextContinuation);\n\n    return objects;\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { DefaultAzureCredential } from '@azure/identity';\nimport {\n  BlobServiceClient,\n  ContainerClient,\n  StorageSharedKeyCredential,\n} from '@azure/storage-blob';\nimport { Entity, CompoundEntityRef } from '@backstage/catalog-model';\nimport { Config } from '@backstage/config';\nimport { assertError, ForwardedError } from '@backstage/errors';\nimport express from 'express';\nimport JSON5 from 'json5';\nimport limiterFactory from 'p-limit';\nimport { default as path, default as platformPath } from 'path';\nimport { Logger } from 'winston';\nimport {\n  bulkStorageOperation,\n  getCloudPathForLocalPath,\n  getFileTreeRecursively,\n  getHeadersForFileExtension,\n  lowerCaseEntityTriplet,\n  getStaleFiles,\n  lowerCaseEntityTripletInStoragePath,\n} from './helpers';\nimport {\n  PublisherBase,\n  PublishRequest,\n  PublishResponse,\n  ReadinessResponse,\n  TechDocsMetadata,\n} from './types';\n\n// The number of batches that may be ongoing at the same time.\nconst BATCH_CONCURRENCY = 3;\n\nexport class AzureBlobStoragePublish implements PublisherBase {\n  private readonly storageClient: BlobServiceClient;\n  private readonly containerName: string;\n  private readonly legacyPathCasing: boolean;\n  private readonly logger: Logger;\n\n  constructor(options: {\n    storageClient: BlobServiceClient;\n    containerName: string;\n    legacyPathCasing: boolean;\n    logger: Logger;\n  }) {\n    this.storageClient = options.storageClient;\n    this.containerName = options.containerName;\n    this.legacyPathCasing = options.legacyPathCasing;\n    this.logger = options.logger;\n  }\n\n  static fromConfig(config: Config, logger: Logger): PublisherBase {\n    let containerName = '';\n    try {\n      containerName = config.getString(\n        'techdocs.publisher.azureBlobStorage.containerName',\n      );\n    } catch (error) {\n      throw new Error(\n        \"Since techdocs.publisher.type is set to 'azureBlobStorage' in your app config, \" +\n          'techdocs.publisher.azureBlobStorage.containerName is required.',\n      );\n    }\n\n    let accountName = '';\n    try {\n      accountName = config.getString(\n        'techdocs.publisher.azureBlobStorage.credentials.accountName',\n      );\n    } catch (error) {\n      throw new Error(\n        \"Since techdocs.publisher.type is set to 'azureBlobStorage' in your app config, \" +\n          'techdocs.publisher.azureBlobStorage.credentials.accountName is required.',\n      );\n    }\n\n    // Credentials is an optional config. If missing, default Azure Blob Storage environment variables will be used.\n    // https://docs.microsoft.com/en-us/azure/storage/common/storage-auth-aad-app\n    const accountKey = config.getOptionalString(\n      'techdocs.publisher.azureBlobStorage.credentials.accountKey',\n    );\n\n    let credential;\n    if (accountKey) {\n      credential = new StorageSharedKeyCredential(accountName, accountKey);\n    } else {\n      credential = new DefaultAzureCredential();\n    }\n\n    const storageClient = new BlobServiceClient(\n      `https://${accountName}.blob.core.windows.net`,\n      credential,\n    );\n\n    const legacyPathCasing =\n      config.getOptionalBoolean(\n        'techdocs.legacyUseCaseSensitiveTripletPaths',\n      ) || false;\n\n    return new AzureBlobStoragePublish({\n      storageClient: storageClient,\n      containerName: containerName,\n      legacyPathCasing: legacyPathCasing,\n      logger: logger,\n    });\n  }\n\n  async getReadiness(): Promise<ReadinessResponse> {\n    try {\n      const response = await this.storageClient\n        .getContainerClient(this.containerName)\n        .getProperties();\n\n      if (response._response.status === 200) {\n        return {\n          isAvailable: true,\n        };\n      }\n\n      if (response._response.status >= 400) {\n        this.logger.error(\n          `Failed to retrieve metadata from ${response._response.request.url} with status code ${response._response.status}.`,\n        );\n      }\n    } catch (e) {\n      assertError(e);\n      this.logger.error(`from Azure Blob Storage client library: ${e.message}`);\n    }\n\n    this.logger.error(\n      `Could not retrieve metadata about the Azure Blob Storage container ${this.containerName}. ` +\n        'Make sure that the Azure project and container exist and the access key is setup correctly ' +\n        'techdocs.publisher.azureBlobStorage.credentials defined in app config has correct permissions. ' +\n        'Refer to https://backstage.io/docs/features/techdocs/using-cloud-storage',\n    );\n\n    return { isAvailable: false };\n  }\n\n  /**\n   * Upload all the files from the generated `directory` to the Azure Blob Storage container.\n   * Directory structure used in the container is - entityNamespace/entityKind/entityName/index.html\n   */\n  async publish({\n    entity,\n    directory,\n  }: PublishRequest): Promise<PublishResponse> {\n    const objects: string[] = [];\n    const useLegacyPathCasing = this.legacyPathCasing;\n\n    // First, try to retrieve a list of all individual files currently existing\n    const remoteFolder = getCloudPathForLocalPath(\n      entity,\n      undefined,\n      useLegacyPathCasing,\n    );\n    let existingFiles: string[] = [];\n    try {\n      existingFiles = await this.getAllBlobsFromContainer({\n        prefix: remoteFolder,\n        maxPageSize: BATCH_CONCURRENCY,\n      });\n    } catch (e) {\n      assertError(e);\n      this.logger.error(\n        `Unable to list files for Entity ${entity.metadata.name}: ${e.message}`,\n      );\n    }\n\n    // Then, merge new files into the same folder\n    let absoluteFilesToUpload;\n    let container: ContainerClient;\n    try {\n      // Remove the absolute path prefix of the source directory\n      // Path of all files to upload, relative to the root of the source directory\n      // e.g. ['index.html', 'sub-page/index.html', 'assets/images/favicon.png']\n      absoluteFilesToUpload = await getFileTreeRecursively(directory);\n\n      container = this.storageClient.getContainerClient(this.containerName);\n      const failedOperations: Error[] = [];\n      await bulkStorageOperation(\n        async absoluteFilePath => {\n          const relativeFilePath = path.normalize(\n            path.relative(directory, absoluteFilePath),\n          );\n          const remotePath = getCloudPathForLocalPath(\n            entity,\n            relativeFilePath,\n            useLegacyPathCasing,\n          );\n          objects.push(remotePath);\n          const response = await container\n            .getBlockBlobClient(remotePath)\n            .uploadFile(absoluteFilePath);\n\n          if (response._response.status >= 400) {\n            failedOperations.push(\n              new Error(\n                `Upload failed for ${absoluteFilePath} with status code ${response._response.status}`,\n              ),\n            );\n          }\n\n          return response;\n        },\n        absoluteFilesToUpload,\n        { concurrencyLimit: BATCH_CONCURRENCY },\n      );\n\n      if (failedOperations.length > 0) {\n        throw new Error(\n          failedOperations\n            .map(r => r.message)\n            .filter(Boolean)\n            .join(' '),\n        );\n      }\n\n      this.logger.info(\n        `Successfully uploaded all the generated files for Entity ${entity.metadata.name}. Total number of files: ${absoluteFilesToUpload.length}`,\n      );\n    } catch (e) {\n      const errorMessage = `Unable to upload file(s) to Azure. ${e}`;\n      this.logger.error(errorMessage);\n      throw new Error(errorMessage);\n    }\n\n    // Last, try to remove the files that were *only* present previously\n    try {\n      const relativeFilesToUpload = absoluteFilesToUpload.map(\n        absoluteFilePath =>\n          getCloudPathForLocalPath(\n            entity,\n            path.relative(directory, absoluteFilePath),\n            useLegacyPathCasing,\n          ),\n      );\n\n      const staleFiles = getStaleFiles(relativeFilesToUpload, existingFiles);\n\n      await bulkStorageOperation(\n        async relativeFilePath => {\n          return await container.deleteBlob(relativeFilePath);\n        },\n        staleFiles,\n        { concurrencyLimit: BATCH_CONCURRENCY },\n      );\n\n      this.logger.info(\n        `Successfully deleted stale files for Entity ${entity.metadata.name}. Total number of files: ${staleFiles.length}`,\n      );\n    } catch (error) {\n      const errorMessage = `Unable to delete file(s) from Azure. ${error}`;\n      this.logger.error(errorMessage);\n    }\n\n    return { objects };\n  }\n\n  private download(containerName: string, blobPath: string): Promise<Buffer> {\n    return new Promise((resolve, reject) => {\n      const fileStreamChunks: Array<any> = [];\n      this.storageClient\n        .getContainerClient(containerName)\n        .getBlockBlobClient(blobPath)\n        .download()\n        .then(res => {\n          const body = res.readableStreamBody;\n          if (!body) {\n            reject(new Error(`Unable to parse the response data`));\n            return;\n          }\n          body\n            .on('error', reject)\n            .on('data', chunk => {\n              fileStreamChunks.push(chunk);\n            })\n            .on('end', () => {\n              resolve(Buffer.concat(fileStreamChunks));\n            });\n        })\n        .catch(reject);\n    });\n  }\n\n  async fetchTechDocsMetadata(\n    entityName: CompoundEntityRef,\n  ): Promise<TechDocsMetadata> {\n    const entityTriplet = `${entityName.namespace}/${entityName.kind}/${entityName.name}`;\n    const entityRootDir = this.legacyPathCasing\n      ? entityTriplet\n      : lowerCaseEntityTriplet(entityTriplet);\n\n    try {\n      const techdocsMetadataJson = await this.download(\n        this.containerName,\n        `${entityRootDir}/techdocs_metadata.json`,\n      );\n      if (!techdocsMetadataJson) {\n        throw new Error(\n          `Unable to parse the techdocs metadata file ${entityRootDir}/techdocs_metadata.json.`,\n        );\n      }\n      const techdocsMetadata = JSON5.parse(\n        techdocsMetadataJson.toString('utf-8'),\n      );\n      return techdocsMetadata;\n    } catch (e) {\n      throw new ForwardedError('TechDocs metadata fetch failed', e);\n    }\n  }\n\n  /**\n   * Express route middleware to serve static files on a route in techdocs-backend.\n   */\n  docsRouter(): express.Handler {\n    return (req, res) => {\n      // Decode and trim the leading forward slash\n      const decodedUri = decodeURI(req.path.replace(/^\\//, ''));\n\n      // filePath example - /default/Component/documented-component/index.html\n      const filePath = this.legacyPathCasing\n        ? decodedUri\n        : lowerCaseEntityTripletInStoragePath(decodedUri);\n\n      // Files with different extensions (CSS, HTML) need to be served with different headers\n      const fileExtension = platformPath.extname(filePath);\n      const responseHeaders = getHeadersForFileExtension(fileExtension);\n\n      this.download(this.containerName, filePath)\n        .then(fileContent => {\n          // Inject response headers\n          for (const [headerKey, headerValue] of Object.entries(\n            responseHeaders,\n          )) {\n            res.setHeader(headerKey, headerValue);\n          }\n          res.send(fileContent);\n        })\n        .catch(e => {\n          this.logger.warn(\n            `TechDocs Azure router failed to serve content from container ${this.containerName} at path ${filePath}: ${e.message}`,\n          );\n          res.status(404).send('File Not Found');\n        });\n    };\n  }\n\n  /**\n   * A helper function which checks if index.html of an Entity's docs site is available. This\n   * can be used to verify if there are any pre-generated docs available to serve.\n   */\n  hasDocsBeenGenerated(entity: Entity): Promise<boolean> {\n    const entityTriplet = `${entity.metadata.namespace}/${entity.kind}/${entity.metadata.name}`;\n    const entityRootDir = this.legacyPathCasing\n      ? entityTriplet\n      : lowerCaseEntityTriplet(entityTriplet);\n\n    return this.storageClient\n      .getContainerClient(this.containerName)\n      .getBlockBlobClient(`${entityRootDir}/index.html`)\n      .exists();\n  }\n\n  protected async renameBlob(\n    originalName: string,\n    newName: string,\n    removeOriginal = false,\n  ): Promise<void> {\n    const container = this.storageClient.getContainerClient(this.containerName);\n    const blob = container.getBlobClient(newName);\n    const { url } = container.getBlobClient(originalName);\n    const response = await blob.beginCopyFromURL(url);\n    await response.pollUntilDone();\n    if (removeOriginal) {\n      await container.deleteBlob(originalName);\n    }\n  }\n\n  protected async renameBlobToLowerCase(\n    originalPath: string,\n    removeOriginal: boolean,\n  ) {\n    let newPath;\n    try {\n      newPath = lowerCaseEntityTripletInStoragePath(originalPath);\n    } catch (e) {\n      assertError(e);\n      this.logger.warn(e.message);\n      return;\n    }\n\n    if (originalPath === newPath) return;\n    try {\n      this.logger.verbose(`Migrating ${originalPath}`);\n      await this.renameBlob(originalPath, newPath, removeOriginal);\n    } catch (e) {\n      assertError(e);\n      this.logger.warn(`Unable to migrate ${originalPath}: ${e.message}`);\n    }\n  }\n\n  async migrateDocsCase({\n    removeOriginal = false,\n    concurrency = 25,\n  }): Promise<void> {\n    const promises = [];\n    const limiter = limiterFactory(concurrency);\n    const container = this.storageClient.getContainerClient(this.containerName);\n\n    for await (const blob of container.listBlobsFlat()) {\n      promises.push(\n        limiter(\n          this.renameBlobToLowerCase.bind(this),\n          blob.name,\n          removeOriginal,\n        ),\n      );\n    }\n\n    await Promise.all(promises);\n  }\n\n  protected async getAllBlobsFromContainer({\n    prefix,\n    maxPageSize,\n  }: {\n    prefix: string;\n    maxPageSize: number;\n  }): Promise<string[]> {\n    const blobs: string[] = [];\n    const container = this.storageClient.getContainerClient(this.containerName);\n\n    let iterator = container.listBlobsFlat({ prefix }).byPage({ maxPageSize });\n    let response = (await iterator.next()).value;\n\n    do {\n      for (const blob of response?.segment?.blobItems ?? []) {\n        blobs.push(blob.name);\n      }\n      iterator = container\n        .listBlobsFlat({ prefix })\n        .byPage({ continuationToken: response.continuationToken, maxPageSize });\n      response = (await iterator.next()).value;\n    } while (response && response.continuationToken);\n\n    return blobs;\n  }\n}\n","/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { assertError } from '@backstage/errors';\nimport { File } from '@google-cloud/storage';\nimport { Writable } from 'stream';\nimport { Logger } from 'winston';\nimport { lowerCaseEntityTripletInStoragePath } from '../helpers';\n\n/**\n * Writable stream to handle object copy/move operations. This implementation\n * ensures we don't read in files from GCS faster than GCS can copy/move them.\n */\nexport class MigrateWriteStream extends Writable {\n  protected logger: Logger;\n  protected removeOriginal: boolean;\n  protected maxConcurrency: number;\n  protected inFlight = 0;\n\n  constructor(logger: Logger, removeOriginal: boolean, concurrency: number) {\n    super({ objectMode: true });\n    this.logger = logger;\n    this.removeOriginal = removeOriginal;\n    this.maxConcurrency = concurrency;\n  }\n\n  _write(file: File, _encoding: BufferEncoding, next: Function) {\n    let shouldCallNext = true;\n    let newFile;\n    try {\n      newFile = lowerCaseEntityTripletInStoragePath(file.name);\n    } catch (e) {\n      assertError(e);\n      this.logger.warn(e.message);\n      next();\n      return;\n    }\n\n    // If all parts are already lowercase, ignore.\n    if (newFile === file.name) {\n      next();\n      return;\n    }\n\n    // Allow up to n-many files to be migrated at a time.\n    this.inFlight++;\n    if (this.inFlight < this.maxConcurrency) {\n      next();\n      shouldCallNext = false;\n    }\n\n    // Otherwise, copy or move the file.\n    const migrate = this.removeOriginal\n      ? file.move.bind(file)\n      : file.copy.bind(file);\n    this.logger.verbose(`Migrating ${file.name}`);\n    migrate(newFile)\n      .catch(e =>\n        this.logger.warn(`Unable to migrate ${file.name}: ${e.message}`),\n      )\n      .finally(() => {\n        this.inFlight--;\n        if (shouldCallNext) {\n          next();\n        }\n      });\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { Entity, CompoundEntityRef } from '@backstage/catalog-model';\nimport { Config } from '@backstage/config';\nimport { assertError } from '@backstage/errors';\nimport { File, FileExistsResponse, Storage } from '@google-cloud/storage';\nimport express from 'express';\nimport JSON5 from 'json5';\nimport path from 'path';\nimport { Readable } from 'stream';\nimport { Logger } from 'winston';\nimport {\n  getFileTreeRecursively,\n  getHeadersForFileExtension,\n  lowerCaseEntityTriplet,\n  lowerCaseEntityTripletInStoragePath,\n  bulkStorageOperation,\n  getCloudPathForLocalPath,\n  getStaleFiles,\n  normalizeExternalStorageRootPath,\n} from './helpers';\nimport { MigrateWriteStream } from './migrations';\nimport {\n  PublisherBase,\n  PublishRequest,\n  PublishResponse,\n  ReadinessResponse,\n  TechDocsMetadata,\n} from './types';\n\nexport class GoogleGCSPublish implements PublisherBase {\n  private readonly storageClient: Storage;\n  private readonly bucketName: string;\n  private readonly legacyPathCasing: boolean;\n  private readonly logger: Logger;\n  private readonly bucketRootPath: string;\n\n  constructor(options: {\n    storageClient: Storage;\n    bucketName: string;\n    legacyPathCasing: boolean;\n    logger: Logger;\n    bucketRootPath: string;\n  }) {\n    this.storageClient = options.storageClient;\n    this.bucketName = options.bucketName;\n    this.legacyPathCasing = options.legacyPathCasing;\n    this.logger = options.logger;\n    this.bucketRootPath = options.bucketRootPath;\n  }\n\n  static fromConfig(config: Config, logger: Logger): PublisherBase {\n    let bucketName = '';\n    try {\n      bucketName = config.getString('techdocs.publisher.googleGcs.bucketName');\n    } catch (error) {\n      throw new Error(\n        \"Since techdocs.publisher.type is set to 'googleGcs' in your app config, \" +\n          'techdocs.publisher.googleGcs.bucketName is required.',\n      );\n    }\n\n    const bucketRootPath = normalizeExternalStorageRootPath(\n      config.getOptionalString('techdocs.publisher.googleGcs.bucketRootPath') ||\n        '',\n    );\n\n    // Credentials is an optional config. If missing, default GCS environment variables will be used.\n    // Read more here https://cloud.google.com/docs/authentication/production\n    const credentials = config.getOptionalString(\n      'techdocs.publisher.googleGcs.credentials',\n    );\n    let credentialsJson: any = {};\n    if (credentials) {\n      try {\n        credentialsJson = JSON.parse(credentials);\n      } catch (err) {\n        throw new Error(\n          'Error in parsing techdocs.publisher.googleGcs.credentials config to JSON.',\n        );\n      }\n    }\n\n    const storageClient = new Storage({\n      ...(credentials && {\n        projectId: credentialsJson.project_id,\n        credentials: credentialsJson,\n      }),\n    });\n\n    const legacyPathCasing =\n      config.getOptionalBoolean(\n        'techdocs.legacyUseCaseSensitiveTripletPaths',\n      ) || false;\n\n    return new GoogleGCSPublish({\n      storageClient,\n      bucketName,\n      legacyPathCasing,\n      logger,\n      bucketRootPath,\n    });\n  }\n\n  /**\n   * Check if the defined bucket exists. Being able to connect means the configuration is good\n   * and the storage client will work.\n   */\n  async getReadiness(): Promise<ReadinessResponse> {\n    try {\n      await this.storageClient.bucket(this.bucketName).getMetadata();\n      this.logger.info(\n        `Successfully connected to the GCS bucket ${this.bucketName}.`,\n      );\n\n      return {\n        isAvailable: true,\n      };\n    } catch (err) {\n      assertError(err);\n      this.logger.error(\n        `Could not retrieve metadata about the GCS bucket ${this.bucketName}. ` +\n          'Make sure the bucket exists. Also make sure that authentication is setup either by explicitly defining ' +\n          'techdocs.publisher.googleGcs.credentials in app config or by using environment variables. ' +\n          'Refer to https://backstage.io/docs/features/techdocs/using-cloud-storage',\n      );\n      this.logger.error(`from GCS client library: ${err.message}`);\n\n      return { isAvailable: false };\n    }\n  }\n\n  /**\n   * Upload all the files from the generated `directory` to the GCS bucket.\n   * Directory structure used in the bucket is - entityNamespace/entityKind/entityName/index.html\n   */\n  async publish({\n    entity,\n    directory,\n  }: PublishRequest): Promise<PublishResponse> {\n    const objects: string[] = [];\n    const useLegacyPathCasing = this.legacyPathCasing;\n    const bucket = this.storageClient.bucket(this.bucketName);\n    const bucketRootPath = this.bucketRootPath;\n\n    // First, try to retrieve a list of all individual files currently existing\n    let existingFiles: string[] = [];\n    try {\n      const remoteFolder = getCloudPathForLocalPath(\n        entity,\n        undefined,\n        useLegacyPathCasing,\n        bucketRootPath,\n      );\n      existingFiles = await this.getFilesForFolder(remoteFolder);\n    } catch (e) {\n      assertError(e);\n      this.logger.error(\n        `Unable to list files for Entity ${entity.metadata.name}: ${e.message}`,\n      );\n    }\n\n    // Then, merge new files into the same folder\n    let absoluteFilesToUpload;\n    try {\n      // Remove the absolute path prefix of the source directory\n      // Path of all files to upload, relative to the root of the source directory\n      // e.g. ['index.html', 'sub-page/index.html', 'assets/images/favicon.png']\n      absoluteFilesToUpload = await getFileTreeRecursively(directory);\n\n      await bulkStorageOperation(\n        async absoluteFilePath => {\n          const relativeFilePath = path.relative(directory, absoluteFilePath);\n          const destination = getCloudPathForLocalPath(\n            entity,\n            relativeFilePath,\n            useLegacyPathCasing,\n            bucketRootPath,\n          );\n          objects.push(destination);\n          return await bucket.upload(absoluteFilePath, { destination });\n        },\n        absoluteFilesToUpload,\n        { concurrencyLimit: 10 },\n      );\n\n      this.logger.info(\n        `Successfully uploaded all the generated files for Entity ${entity.metadata.name}. Total number of files: ${absoluteFilesToUpload.length}`,\n      );\n    } catch (e) {\n      const errorMessage = `Unable to upload file(s) to Google Cloud Storage. ${e}`;\n      this.logger.error(errorMessage);\n      throw new Error(errorMessage);\n    }\n\n    // Last, try to remove the files that were *only* present previously\n    try {\n      const relativeFilesToUpload = absoluteFilesToUpload.map(\n        absoluteFilePath =>\n          getCloudPathForLocalPath(\n            entity,\n            path.relative(directory, absoluteFilePath),\n            useLegacyPathCasing,\n            bucketRootPath,\n          ),\n      );\n      const staleFiles = getStaleFiles(relativeFilesToUpload, existingFiles);\n\n      await bulkStorageOperation(\n        async relativeFilePath => {\n          return await bucket.file(relativeFilePath).delete();\n        },\n        staleFiles,\n        { concurrencyLimit: 10 },\n      );\n\n      this.logger.info(\n        `Successfully deleted stale files for Entity ${entity.metadata.name}. Total number of files: ${staleFiles.length}`,\n      );\n    } catch (error) {\n      const errorMessage = `Unable to delete file(s) from Google Cloud Storage. ${error}`;\n      this.logger.error(errorMessage);\n    }\n\n    return { objects };\n  }\n\n  fetchTechDocsMetadata(\n    entityName: CompoundEntityRef,\n  ): Promise<TechDocsMetadata> {\n    return new Promise((resolve, reject) => {\n      const entityTriplet = `${entityName.namespace}/${entityName.kind}/${entityName.name}`;\n      const entityDir = this.legacyPathCasing\n        ? entityTriplet\n        : lowerCaseEntityTriplet(entityTriplet);\n\n      const entityRootDir = path.posix.join(this.bucketRootPath, entityDir);\n\n      const fileStreamChunks: Array<any> = [];\n      this.storageClient\n        .bucket(this.bucketName)\n        .file(`${entityRootDir}/techdocs_metadata.json`)\n        .createReadStream()\n        .on('error', err => {\n          this.logger.error(err.message);\n          reject(err);\n        })\n        .on('data', chunk => {\n          fileStreamChunks.push(chunk);\n        })\n        .on('end', () => {\n          const techdocsMetadataJson =\n            Buffer.concat(fileStreamChunks).toString('utf-8');\n          resolve(JSON5.parse(techdocsMetadataJson));\n        });\n    });\n  }\n\n  /**\n   * Express route middleware to serve static files on a route in techdocs-backend.\n   */\n  docsRouter(): express.Handler {\n    return (req, res) => {\n      // Decode and trim the leading forward slash\n      const decodedUri = decodeURI(req.path.replace(/^\\//, ''));\n\n      // Root path is removed from the Uri so that legacy casing can be applied\n      // to the entity triplet without manipulating the root path\n      const decodedUriNoRoot = path.relative(this.bucketRootPath, decodedUri);\n\n      const filePathNoRoot = this.legacyPathCasing\n        ? decodedUriNoRoot\n        : lowerCaseEntityTripletInStoragePath(decodedUriNoRoot);\n\n      // Re-prepend the root path to the relative file path\n      const filePath = path.posix.join(this.bucketRootPath, filePathNoRoot);\n\n      // Files with different extensions (CSS, HTML) need to be served with different headers\n      const fileExtension = path.extname(filePath);\n      const responseHeaders = getHeadersForFileExtension(fileExtension);\n\n      // Pipe file chunks directly from storage to client.\n      this.storageClient\n        .bucket(this.bucketName)\n        .file(filePath)\n        .createReadStream()\n        .on('pipe', () => {\n          res.writeHead(200, responseHeaders);\n        })\n        .on('error', err => {\n          this.logger.warn(\n            `TechDocs Google GCS router failed to serve content from bucket ${this.bucketName} at path ${filePath}: ${err.message}`,\n          );\n          // Send a 404 with a meaningful message if possible.\n          if (!res.headersSent) {\n            res.status(404).send('File Not Found');\n          } else {\n            res.destroy();\n          }\n        })\n        .pipe(res);\n    };\n  }\n\n  /**\n   * A helper function which checks if index.html of an Entity's docs site is available. This\n   * can be used to verify if there are any pre-generated docs available to serve.\n   */\n  async hasDocsBeenGenerated(entity: Entity): Promise<boolean> {\n    return new Promise(resolve => {\n      const entityTriplet = `${entity.metadata.namespace}/${entity.kind}/${entity.metadata.name}`;\n      const entityDir = this.legacyPathCasing\n        ? entityTriplet\n        : lowerCaseEntityTriplet(entityTriplet);\n\n      const entityRootDir = path.posix.join(this.bucketRootPath, entityDir);\n\n      this.storageClient\n        .bucket(this.bucketName)\n        .file(`${entityRootDir}/index.html`)\n        .exists()\n        .then((response: FileExistsResponse) => {\n          resolve(response[0]);\n        })\n        .catch(() => {\n          resolve(false);\n        });\n    });\n  }\n\n  migrateDocsCase({ removeOriginal = false, concurrency = 25 }): Promise<void> {\n    return new Promise((resolve, reject) => {\n      // Iterate through every file in the root of the publisher.\n      const allFileMetadata: Readable = this.storageClient\n        .bucket(this.bucketName)\n        .getFilesStream();\n      const migrateFiles = new MigrateWriteStream(\n        this.logger,\n        removeOriginal,\n        concurrency,\n      );\n      migrateFiles.on('finish', resolve).on('error', reject);\n      allFileMetadata.pipe(migrateFiles).on('error', error => {\n        migrateFiles.destroy();\n        reject(error);\n      });\n    });\n  }\n\n  private getFilesForFolder(folder: string): Promise<string[]> {\n    const fileMetadataStream: Readable = this.storageClient\n      .bucket(this.bucketName)\n      .getFilesStream({ prefix: folder });\n\n    return new Promise((resolve, reject) => {\n      const files: string[] = [];\n\n      fileMetadataStream.on('error', error => {\n        // push file to file array\n        reject(error);\n      });\n\n      fileMetadataStream.on('data', (file: File) => {\n        // push file to file array\n        files.push(file.name);\n      });\n\n      fileMetadataStream.on('end', () => {\n        // resolve promise\n        resolve(files);\n      });\n    });\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {\n  PluginEndpointDiscovery,\n  resolvePackagePath,\n} from '@backstage/backend-common';\nimport { Entity, CompoundEntityRef } from '@backstage/catalog-model';\nimport { Config } from '@backstage/config';\nimport express from 'express';\nimport fs from 'fs-extra';\nimport os from 'os';\nimport createLimiter from 'p-limit';\nimport path from 'path';\nimport { Logger } from 'winston';\nimport {\n  PublisherBase,\n  PublishRequest,\n  PublishResponse,\n  ReadinessResponse,\n  TechDocsMetadata,\n} from './types';\nimport {\n  getFileTreeRecursively,\n  getHeadersForFileExtension,\n  lowerCaseEntityTripletInStoragePath,\n} from './helpers';\nimport { assertError } from '@backstage/errors';\n\n// TODO: Use a more persistent storage than node_modules or /tmp directory.\n// Make it configurable with techdocs.publisher.local.publishDirectory\nlet staticDocsDir = '';\ntry {\n  staticDocsDir = resolvePackagePath(\n    '@backstage/plugin-techdocs-backend',\n    'static/docs',\n  );\n} catch (err) {\n  // This will most probably never be used.\n  // The try/catch is introduced so that techdocs-cli can import @backstage/plugin-techdocs-node\n  // on CI/CD without installing techdocs backend plugin.\n  staticDocsDir = os.tmpdir();\n}\n\n/**\n * Local publisher which uses the local filesystem to store the generated static files. It uses a directory\n * called \"static\" at the root of techdocs-backend plugin.\n */\nexport class LocalPublish implements PublisherBase {\n  private readonly legacyPathCasing: boolean;\n  private readonly logger: Logger;\n  private readonly discovery: PluginEndpointDiscovery;\n\n  // TODO: Move the logic of setting staticDocsDir based on config over to\n  // fromConfig, and set the value as a class parameter.\n  constructor(options: {\n    logger: Logger;\n    discovery: PluginEndpointDiscovery;\n    legacyPathCasing: boolean;\n  }) {\n    this.logger = options.logger;\n    this.discovery = options.discovery;\n    this.legacyPathCasing = options.legacyPathCasing;\n  }\n\n  static fromConfig(\n    config: Config,\n    logger: Logger,\n    discovery: PluginEndpointDiscovery,\n  ): PublisherBase {\n    const legacyPathCasing =\n      config.getOptionalBoolean(\n        'techdocs.legacyUseCaseSensitiveTripletPaths',\n      ) || false;\n\n    return new LocalPublish({\n      logger,\n      discovery,\n      legacyPathCasing,\n    });\n  }\n\n  async getReadiness(): Promise<ReadinessResponse> {\n    return {\n      isAvailable: true,\n    };\n  }\n\n  async publish({\n    entity,\n    directory,\n  }: PublishRequest): Promise<PublishResponse> {\n    const entityNamespace = entity.metadata.namespace ?? 'default';\n\n    const publishDir = this.staticEntityPathJoin(\n      entityNamespace,\n      entity.kind,\n      entity.metadata.name,\n    );\n\n    if (!fs.existsSync(publishDir)) {\n      this.logger.info(`Could not find ${publishDir}, creating the directory.`);\n      fs.mkdirSync(publishDir, { recursive: true });\n    }\n\n    try {\n      await fs.copy(directory, publishDir);\n      this.logger.info(`Published site stored at ${publishDir}`);\n    } catch (error) {\n      this.logger.debug(\n        `Failed to copy docs from ${directory} to ${publishDir}`,\n      );\n      throw error;\n    }\n\n    // Generate publish response.\n    const techdocsApiUrl = await this.discovery.getBaseUrl('techdocs');\n    const publishedFilePaths = (await getFileTreeRecursively(publishDir)).map(\n      abs => {\n        return abs.split(`${staticDocsDir}/`)[1];\n      },\n    );\n\n    return {\n      remoteUrl: `${techdocsApiUrl}/static/docs/${encodeURIComponent(\n        entity.metadata.name,\n      )}`,\n      objects: publishedFilePaths,\n    };\n  }\n\n  async fetchTechDocsMetadata(\n    entityName: CompoundEntityRef,\n  ): Promise<TechDocsMetadata> {\n    const metadataPath = this.staticEntityPathJoin(\n      entityName.namespace,\n      entityName.kind,\n      entityName.name,\n      'techdocs_metadata.json',\n    );\n\n    try {\n      return await fs.readJson(metadataPath);\n    } catch (err) {\n      assertError(err);\n      this.logger.error(\n        `Unable to read techdocs_metadata.json at ${metadataPath}. Error: ${err}`,\n      );\n      throw new Error(err.message);\n    }\n  }\n\n  docsRouter(): express.Handler {\n    const router = express.Router();\n\n    // Redirect middleware ensuring that requests to case-sensitive entity\n    // triplet paths are always sent to lower-case versions.\n    router.use((req, res, next) => {\n      // If legacy path casing is on, let the request immediately continue.\n      if (this.legacyPathCasing) {\n        return next();\n      }\n\n      // Generate a lower-case entity triplet path.\n      const [_, namespace, kind, name, ...rest] = req.path.split('/');\n\n      // Ignore non-triplet objects.\n      if (!namespace || !kind || !name) {\n        return next();\n      }\n\n      const newPath = [\n        _,\n        namespace.toLowerCase(),\n        kind.toLowerCase(),\n        name.toLowerCase(),\n        ...rest,\n      ].join('/');\n\n      // If there was no change, then let express.static() handle the request.\n      if (newPath === req.path) {\n        return next();\n      }\n\n      // Otherwise, redirect to the new path.\n      return res.redirect(req.baseUrl + newPath, 301);\n    });\n\n    router.use(\n      express.static(staticDocsDir, {\n        // Handle content-type header the same as all other publishers.\n        setHeaders: (res, filePath) => {\n          const fileExtension = path.extname(filePath);\n          const headers = getHeadersForFileExtension(fileExtension);\n          for (const [header, value] of Object.entries(headers)) {\n            res.setHeader(header, value);\n          }\n        },\n      }),\n    );\n\n    return router;\n  }\n\n  async hasDocsBeenGenerated(entity: Entity): Promise<boolean> {\n    const namespace = entity.metadata.namespace ?? 'default';\n\n    const indexHtmlPath = this.staticEntityPathJoin(\n      namespace,\n      entity.kind,\n      entity.metadata.name,\n      'index.html',\n    );\n\n    // Check if the file exists\n    try {\n      await fs.access(indexHtmlPath, fs.constants.F_OK);\n      return true;\n    } catch (err) {\n      return false;\n    }\n  }\n\n  /**\n   * This code will never run in practice. It is merely here to illustrate how\n   * to implement this method for other storage providers.\n   */\n  async migrateDocsCase({\n    removeOriginal = false,\n    concurrency = 25,\n  }): Promise<void> {\n    // Iterate through every file in the root of the publisher.\n    const files = await getFileTreeRecursively(staticDocsDir);\n    const limit = createLimiter(concurrency);\n\n    await Promise.all(\n      files.map(f =>\n        limit(async file => {\n          const relativeFile = file.replace(`${staticDocsDir}${path.sep}`, '');\n          const newFile = lowerCaseEntityTripletInStoragePath(relativeFile);\n\n          // If all parts are already lowercase, ignore.\n          if (relativeFile === newFile) {\n            return;\n          }\n\n          // Otherwise, copy or move the file.\n          await new Promise<void>(resolve => {\n            const migrate = removeOriginal ? fs.move : fs.copyFile;\n            this.logger.verbose(`Migrating ${relativeFile}`);\n            migrate(file, newFile, err => {\n              if (err) {\n                this.logger.warn(\n                  `Unable to migrate ${relativeFile}: ${err.message}`,\n                );\n              }\n              resolve();\n            });\n          });\n        }, f),\n      ),\n    );\n  }\n\n  /**\n   * Utility wrapper around path.join(), used to control legacy case logic.\n   */\n  protected staticEntityPathJoin(...allParts: string[]): string {\n    if (this.legacyPathCasing) {\n      const [namespace, kind, name, ...parts] = allParts;\n      return path.join(staticDocsDir, namespace, kind, name, ...parts);\n    }\n    const [namespace, kind, name, ...parts] = allParts;\n    return path.join(\n      staticDocsDir,\n      namespace.toLowerCase(),\n      kind.toLowerCase(),\n      name.toLowerCase(),\n      ...parts,\n    );\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { Entity, CompoundEntityRef } from '@backstage/catalog-model';\nimport { Config } from '@backstage/config';\nimport express from 'express';\nimport fs from 'fs-extra';\nimport JSON5 from 'json5';\nimport createLimiter from 'p-limit';\nimport path from 'path';\nimport { SwiftClient } from '@trendyol-js/openstack-swift-sdk';\nimport { NotFound } from '@trendyol-js/openstack-swift-sdk/lib/types';\nimport { Stream, Readable } from 'stream';\nimport { Logger } from 'winston';\nimport {\n  getFileTreeRecursively,\n  getHeadersForFileExtension,\n  lowerCaseEntityTripletInStoragePath,\n} from './helpers';\nimport {\n  PublisherBase,\n  PublishRequest,\n  PublishResponse,\n  ReadinessResponse,\n  TechDocsMetadata,\n} from './types';\nimport { assertError, ForwardedError } from '@backstage/errors';\n\nconst streamToBuffer = (stream: Stream | Readable): Promise<Buffer> => {\n  return new Promise((resolve, reject) => {\n    try {\n      const chunks: any[] = [];\n      stream.on('data', chunk => chunks.push(chunk));\n      stream.on('error', reject);\n      stream.on('end', () => resolve(Buffer.concat(chunks)));\n    } catch (e) {\n      throw new ForwardedError('Unable to parse the response data', e);\n    }\n  });\n};\n\nconst bufferToStream = (buffer: Buffer): Readable => {\n  const stream = new Readable();\n  stream.push(buffer);\n  stream.push(null);\n  return stream;\n};\n\nexport class OpenStackSwiftPublish implements PublisherBase {\n  private readonly storageClient: SwiftClient;\n  private readonly containerName: string;\n  private readonly logger: Logger;\n\n  constructor(options: {\n    storageClient: SwiftClient;\n    containerName: string;\n    logger: Logger;\n  }) {\n    this.storageClient = options.storageClient;\n    this.containerName = options.containerName;\n    this.logger = options.logger;\n  }\n\n  static fromConfig(config: Config, logger: Logger): PublisherBase {\n    let containerName = '';\n    try {\n      containerName = config.getString(\n        'techdocs.publisher.openStackSwift.containerName',\n      );\n    } catch (error) {\n      throw new Error(\n        \"Since techdocs.publisher.type is set to 'openStackSwift' in your app config, \" +\n          'techdocs.publisher.openStackSwift.containerName is required.',\n      );\n    }\n\n    const openStackSwiftConfig = config.getConfig(\n      'techdocs.publisher.openStackSwift',\n    );\n\n    const storageClient = new SwiftClient({\n      authEndpoint: openStackSwiftConfig.getString('authUrl'),\n      swiftEndpoint: openStackSwiftConfig.getString('swiftUrl'),\n      credentialId: openStackSwiftConfig.getString('credentials.id'),\n      secret: openStackSwiftConfig.getString('credentials.secret'),\n    });\n\n    return new OpenStackSwiftPublish({ storageClient, containerName, logger });\n  }\n\n  /*\n   * Check if the defined container exists. Being able to connect means the configuration is good\n   * and the storage client will work.\n   */\n  async getReadiness(): Promise<ReadinessResponse> {\n    try {\n      const container = await this.storageClient.getContainerMetadata(\n        this.containerName,\n      );\n\n      if (!(container instanceof NotFound)) {\n        this.logger.info(\n          `Successfully connected to the OpenStack Swift container ${this.containerName}.`,\n        );\n        return {\n          isAvailable: true,\n        };\n      }\n      this.logger.error(\n        `Could not retrieve metadata about the OpenStack Swift container ${this.containerName}. ` +\n          'Make sure the container exists. Also make sure that authentication is setup either by ' +\n          'explicitly defining credentials and region in techdocs.publisher.openStackSwift in app config or ' +\n          'by using environment variables. Refer to https://backstage.io/docs/features/techdocs/using-cloud-storage',\n      );\n      return {\n        isAvailable: false,\n      };\n    } catch (err) {\n      assertError(err);\n      this.logger.error(`from OpenStack client library: ${err.message}`);\n      return {\n        isAvailable: false,\n      };\n    }\n  }\n\n  /**\n   * Upload all the files from the generated `directory` to the OpenStack Swift container.\n   * Directory structure used in the bucket is - entityNamespace/entityKind/entityName/index.html\n   */\n  async publish({\n    entity,\n    directory,\n  }: PublishRequest): Promise<PublishResponse> {\n    try {\n      const objects: string[] = [];\n\n      // Note: OpenStack Swift manages creation of parent directories if they do not exist.\n      // So collecting path of only the files is good enough.\n      const allFilesToUpload = await getFileTreeRecursively(directory);\n      const limiter = createLimiter(10);\n      const uploadPromises: Array<Promise<unknown>> = [];\n      for (const filePath of allFilesToUpload) {\n        // Remove the absolute path prefix of the source directory\n        // Path of all files to upload, relative to the root of the source directory\n        // e.g. ['index.html', 'sub-page/index.html', 'assets/images/favicon.png']\n        const relativeFilePath = path.relative(directory, filePath);\n        // Convert destination file path to a POSIX path for uploading.\n        // Swift expects / as path separator and relativeFilePath will contain \\\\ on Windows.\n        // https://docs.openstack.org/python-openstackclient/pike/cli/man/openstack.html\n        const relativeFilePathPosix = relativeFilePath\n          .split(path.sep)\n          .join(path.posix.sep);\n\n        // The / delimiter is intentional since it represents the cloud storage and not the local file system.\n        const entityRootDir = `${entity.metadata.namespace}/${entity.kind}/${entity.metadata.name}`;\n        const destination = `${entityRootDir}/${relativeFilePathPosix}`; // Swift container file relative path\n        objects.push(destination);\n\n        // Rate limit the concurrent execution of file uploads to batches of 10 (per publish)\n        const uploadFile = limiter(async () => {\n          const fileBuffer = await fs.readFile(filePath);\n          const stream = bufferToStream(fileBuffer);\n          return this.storageClient.upload(\n            this.containerName,\n            destination,\n            stream,\n          );\n        });\n        uploadPromises.push(uploadFile);\n      }\n      await Promise.all(uploadPromises);\n      this.logger.info(\n        `Successfully uploaded all the generated files for Entity ${entity.metadata.name}. Total number of files: ${allFilesToUpload.length}`,\n      );\n      return { objects };\n    } catch (e) {\n      const errorMessage = `Unable to upload file(s) to OpenStack Swift. ${e}`;\n      this.logger.error(errorMessage);\n      throw new Error(errorMessage);\n    }\n  }\n\n  async fetchTechDocsMetadata(\n    entityName: CompoundEntityRef,\n  ): Promise<TechDocsMetadata> {\n    return await new Promise<TechDocsMetadata>(async (resolve, reject) => {\n      const entityRootDir = `${entityName.namespace}/${entityName.kind}/${entityName.name}`;\n\n      const downloadResponse = await this.storageClient.download(\n        this.containerName,\n        `${entityRootDir}/techdocs_metadata.json`,\n      );\n\n      if (!(downloadResponse instanceof NotFound)) {\n        const stream = downloadResponse.data;\n        try {\n          const techdocsMetadataJson = await streamToBuffer(stream);\n          if (!techdocsMetadataJson) {\n            throw new Error(\n              `Unable to parse the techdocs metadata file ${entityRootDir}/techdocs_metadata.json.`,\n            );\n          }\n\n          const techdocsMetadata = JSON5.parse(\n            techdocsMetadataJson.toString('utf-8'),\n          );\n\n          resolve(techdocsMetadata);\n        } catch (err) {\n          assertError(err);\n          this.logger.error(err.message);\n          reject(new Error(err.message));\n        }\n      } else {\n        reject({\n          message: `TechDocs metadata fetch failed, The file /rootDir/${entityRootDir}/techdocs_metadata.json does not exist !`,\n        });\n      }\n    });\n  }\n\n  /**\n   * Express route middleware to serve static files on a route in techdocs-backend.\n   */\n  docsRouter(): express.Handler {\n    return async (req, res) => {\n      // Decode and trim the leading forward slash\n      // filePath example - /default/Component/documented-component/index.html\n      const filePath = decodeURI(req.path.replace(/^\\//, ''));\n\n      // Files with different extensions (CSS, HTML) need to be served with different headers\n      const fileExtension = path.extname(filePath);\n      const responseHeaders = getHeadersForFileExtension(fileExtension);\n\n      const downloadResponse = await this.storageClient.download(\n        this.containerName,\n        filePath,\n      );\n\n      if (!(downloadResponse instanceof NotFound)) {\n        const stream = downloadResponse.data;\n\n        try {\n          // Inject response headers\n          for (const [headerKey, headerValue] of Object.entries(\n            responseHeaders,\n          )) {\n            res.setHeader(headerKey, headerValue);\n          }\n\n          res.send(await streamToBuffer(stream));\n        } catch (err) {\n          assertError(err);\n          this.logger.warn(\n            `TechDocs OpenStack swift router failed to serve content from container ${this.containerName} at path ${filePath}: ${err.message}`,\n          );\n          res.status(404).send('File Not Found');\n        }\n      } else {\n        this.logger.warn(\n          `TechDocs OpenStack swift router failed to serve content from container ${this.containerName} at path ${filePath}: Not found`,\n        );\n        res.status(404).send('File Not Found');\n      }\n    };\n  }\n\n  /**\n   * A helper function which checks if index.html of an Entity's docs site is available. This\n   * can be used to verify if there are any pre-generated docs available to serve.\n   */\n  async hasDocsBeenGenerated(entity: Entity): Promise<boolean> {\n    const entityRootDir = `${entity.metadata.namespace}/${entity.kind}/${entity.metadata.name}`;\n    try {\n      const fileResponse = await this.storageClient.getMetadata(\n        this.containerName,\n        `${entityRootDir}/index.html`,\n      );\n\n      if (!(fileResponse instanceof NotFound)) {\n        return true;\n      }\n      return false;\n    } catch (err) {\n      assertError(err);\n      this.logger.warn(err.message);\n      return false;\n    }\n  }\n\n  async migrateDocsCase({\n    removeOriginal = false,\n    concurrency = 25,\n  }): Promise<void> {\n    // Iterate through every file in the root of the publisher.\n    const allObjects = await this.getAllObjectsFromContainer();\n    const limiter = createLimiter(concurrency);\n    await Promise.all(\n      allObjects.map(f =>\n        limiter(async file => {\n          let newPath;\n          try {\n            newPath = lowerCaseEntityTripletInStoragePath(file);\n          } catch (e) {\n            assertError(e);\n            this.logger.warn(e.message);\n            return;\n          }\n\n          // If all parts are already lowercase, ignore.\n          if (file === newPath) {\n            return;\n          }\n\n          try {\n            this.logger.verbose(`Migrating ${file} to ${newPath}`);\n            await this.storageClient.copy(\n              this.containerName,\n              file,\n              this.containerName,\n              newPath,\n            );\n            if (removeOriginal) {\n              await this.storageClient.delete(this.containerName, file);\n            }\n          } catch (e) {\n            assertError(e);\n            this.logger.warn(`Unable to migrate ${file}: ${e.message}`);\n          }\n        }, f),\n      ),\n    );\n  }\n\n  /**\n   * Returns a list of all object keys from the configured container.\n   */\n  protected async getAllObjectsFromContainer(\n    { prefix } = { prefix: '' },\n  ): Promise<string[]> {\n    let objects: string[] = [];\n    const OSS_MAX_LIMIT = Math.pow(2, 31) - 1;\n\n    const allObjects = await this.storageClient.list(\n      this.containerName,\n      prefix,\n      OSS_MAX_LIMIT,\n    );\n    objects = allObjects.map((object: any) => object.name);\n\n    return objects;\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Config } from '@backstage/config';\nimport { AwsS3Publish } from './awsS3';\nimport { AzureBlobStoragePublish } from './azureBlobStorage';\nimport { GoogleGCSPublish } from './googleStorage';\nimport { LocalPublish } from './local';\nimport { OpenStackSwiftPublish } from './openStackSwift';\nimport { PublisherFactory, PublisherBase, PublisherType } from './types';\n\n/**\n * Factory class to create a TechDocs publisher based on defined publisher type in app config.\n * Uses `techdocs.publisher.type`.\n * @public\n */\nexport class Publisher {\n  /**\n   * Returns a instance of TechDocs publisher\n   * @param config - A Backstage configuration\n   * @param options - Options for configuring the publisher factory\n   */\n  static async fromConfig(\n    config: Config,\n    { logger, discovery }: PublisherFactory,\n  ): Promise<PublisherBase> {\n    const publisherType = (config.getOptionalString(\n      'techdocs.publisher.type',\n    ) ?? 'local') as PublisherType;\n\n    switch (publisherType) {\n      case 'googleGcs':\n        logger.info('Creating Google Storage Bucket publisher for TechDocs');\n        return GoogleGCSPublish.fromConfig(config, logger);\n      case 'awsS3':\n        logger.info('Creating AWS S3 Bucket publisher for TechDocs');\n        return AwsS3Publish.fromConfig(config, logger);\n      case 'azureBlobStorage':\n        logger.info(\n          'Creating Azure Blob Storage Container publisher for TechDocs',\n        );\n        return AzureBlobStoragePublish.fromConfig(config, logger);\n      case 'openStackSwift':\n        logger.info(\n          'Creating OpenStack Swift Container publisher for TechDocs',\n        );\n        return OpenStackSwiftPublish.fromConfig(config, logger);\n      case 'local':\n        logger.info('Creating Local publisher for TechDocs');\n        return LocalPublish.fromConfig(config, logger, discovery);\n      default:\n        logger.info('Creating Local publisher for TechDocs');\n        return LocalPublish.fromConfig(config, logger, discovery);\n    }\n  }\n}\n"],"names":["mime","recursiveReadDir","path","DEFAULT_NAMESPACE","createLimiter","PassThrough","spawn","gitUrlParse","DEFAULT_SCHEMA","Type","fs","ForwardedError","yaml","isChildPath","resolvePath","assertError","ScmIntegrations","InputError","parseLocationRef","getEntitySourceLocation","resolveSafeChildPath","streamToBuffer","aws","Credentials","JSON5","StorageSharedKeyCredential","DefaultAzureCredential","BlobServiceClient","platformPath","limiterFactory","Writable","Storage","resolvePackagePath","os","express","stream","Readable","SwiftClient","NotFound"],"mappings":"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"}