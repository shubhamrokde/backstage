{"version":3,"file":"index.cjs.js","sources":["../src/DocsBuilder/BuildMetadataStorage.ts","../src/DocsBuilder/builder.ts","../src/service/DocsSynchronizer.ts","../src/cache/cacheMiddleware.ts","../src/cache/TechDocsCache.ts","../src/service/CachedEntityLoader.ts","../src/service/DocsBuildStrategy.ts","../src/service/router.ts","../src/search/DefaultTechDocsCollatorFactory.ts","../src/search/DefaultTechDocsCollator.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n// Entity uid: unix timestamp\nconst lastUpdatedRecord = {} as Record<string, number>;\n\n/**\n * Store timestamps of the most recent TechDocs update of each Entity. This is\n * used to avoid checking for an update on each and every request to TechDocs.\n */\nexport class BuildMetadataStorage {\n  private entityUid: string;\n  private lastUpdatedRecord: Record<string, number>;\n\n  constructor(entityUid: string) {\n    this.entityUid = entityUid;\n    this.lastUpdatedRecord = lastUpdatedRecord;\n  }\n\n  setLastUpdated(): void {\n    this.lastUpdatedRecord[this.entityUid] = Date.now();\n  }\n\n  getLastUpdated(): number | undefined {\n    return this.lastUpdatedRecord[this.entityUid];\n  }\n}\n\n/**\n * Return false if a check for update has happened in last 60 seconds.\n */\nexport const shouldCheckForUpdate = (entityUid: string) => {\n  const lastUpdated = new BuildMetadataStorage(entityUid).getLastUpdated();\n  if (lastUpdated) {\n    // The difference is in milliseconds\n    if (Date.now() - lastUpdated < 60 * 1000) {\n      return false;\n    }\n  }\n  return true;\n};\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {\n  Entity,\n  DEFAULT_NAMESPACE,\n  stringifyEntityRef,\n} from '@backstage/catalog-model';\nimport { Config } from '@backstage/config';\nimport { assertError, isError } from '@backstage/errors';\nimport { ScmIntegrationRegistry } from '@backstage/integration';\nimport {\n  GeneratorBase,\n  GeneratorBuilder,\n  getLocationForEntity,\n  PreparerBase,\n  PreparerBuilder,\n  PublisherBase,\n  UrlPreparer,\n} from '@backstage/plugin-techdocs-node';\nimport fs from 'fs-extra';\nimport os from 'os';\nimport path from 'path';\nimport { Writable } from 'stream';\nimport { Logger } from 'winston';\nimport { BuildMetadataStorage } from './BuildMetadataStorage';\nimport { TechDocsCache } from '../cache';\n\ntype DocsBuilderArguments = {\n  preparers: PreparerBuilder;\n  generators: GeneratorBuilder;\n  publisher: PublisherBase;\n  entity: Entity;\n  logger: Logger;\n  config: Config;\n  scmIntegrations: ScmIntegrationRegistry;\n  logStream?: Writable;\n  cache?: TechDocsCache;\n};\n\nexport class DocsBuilder {\n  private preparer: PreparerBase;\n  private generator: GeneratorBase;\n  private publisher: PublisherBase;\n  private entity: Entity;\n  private logger: Logger;\n  private config: Config;\n  private scmIntegrations: ScmIntegrationRegistry;\n  private logStream: Writable | undefined;\n  private cache?: TechDocsCache;\n\n  constructor({\n    preparers,\n    generators,\n    publisher,\n    entity,\n    logger,\n    config,\n    scmIntegrations,\n    logStream,\n    cache,\n  }: DocsBuilderArguments) {\n    this.preparer = preparers.get(entity);\n    this.generator = generators.get(entity);\n    this.publisher = publisher;\n    this.entity = entity;\n    this.logger = logger;\n    this.config = config;\n    this.scmIntegrations = scmIntegrations;\n    this.logStream = logStream;\n    this.cache = cache;\n  }\n\n  /**\n   * Build the docs and return whether they have been newly generated or have been cached\n   * @returns true, if the docs have been built. false, if the cached docs are still up-to-date.\n   */\n  public async build(): Promise<boolean> {\n    if (!this.entity.metadata.uid) {\n      throw new Error(\n        'Trying to build documentation for entity not in software catalog',\n      );\n    }\n\n    /**\n     * Prepare (and cache check)\n     */\n\n    this.logger.info(\n      `Step 1 of 3: Preparing docs for entity ${stringifyEntityRef(\n        this.entity,\n      )}`,\n    );\n\n    // If available, use the etag stored in techdocs_metadata.json to\n    // check if docs are outdated and need to be regenerated.\n    let storedEtag: string | undefined;\n    if (await this.publisher.hasDocsBeenGenerated(this.entity)) {\n      try {\n        storedEtag = (\n          await this.publisher.fetchTechDocsMetadata({\n            namespace: this.entity.metadata.namespace ?? DEFAULT_NAMESPACE,\n            kind: this.entity.kind,\n            name: this.entity.metadata.name,\n          })\n        ).etag;\n      } catch (err) {\n        // Proceed with a fresh build\n        this.logger.warn(\n          `Unable to read techdocs_metadata.json, proceeding with fresh build, error ${err}.`,\n        );\n      }\n    }\n\n    let preparedDir: string;\n    let newEtag: string;\n    try {\n      const preparerResponse = await this.preparer.prepare(this.entity, {\n        etag: storedEtag,\n        logger: this.logger,\n      });\n\n      preparedDir = preparerResponse.preparedDir;\n      newEtag = preparerResponse.etag;\n    } catch (err) {\n      if (isError(err) && err.name === 'NotModifiedError') {\n        // No need to prepare anymore since cache is valid.\n        // Set last check happened to now\n        new BuildMetadataStorage(this.entity.metadata.uid).setLastUpdated();\n        this.logger.debug(\n          `Docs for ${stringifyEntityRef(\n            this.entity,\n          )} are unmodified. Using cache, skipping generate and prepare`,\n        );\n        return false;\n      }\n      throw err;\n    }\n\n    this.logger.info(\n      `Prepare step completed for entity ${stringifyEntityRef(\n        this.entity,\n      )}, stored at ${preparedDir}`,\n    );\n\n    /**\n     * Generate\n     */\n\n    this.logger.info(\n      `Step 2 of 3: Generating docs for entity ${stringifyEntityRef(\n        this.entity,\n      )}`,\n    );\n\n    const workingDir = this.config.getOptionalString(\n      'backend.workingDirectory',\n    );\n    const tmpdirPath = workingDir || os.tmpdir();\n    // Fixes a problem with macOS returning a path that is a symlink\n    const tmpdirResolvedPath = fs.realpathSync(tmpdirPath);\n    const outputDir = await fs.mkdtemp(\n      path.join(tmpdirResolvedPath, 'techdocs-tmp-'),\n    );\n\n    const parsedLocationAnnotation = getLocationForEntity(\n      this.entity,\n      this.scmIntegrations,\n    );\n    await this.generator.run({\n      inputDir: preparedDir,\n      outputDir,\n      parsedLocationAnnotation,\n      etag: newEtag,\n      logger: this.logger,\n      logStream: this.logStream,\n    });\n\n    // Remove Prepared directory since it is no longer needed.\n    // Caveat: Can not remove prepared directory in case of git preparer since the\n    // local git repository is used to get etag on subsequent requests.\n    if (this.preparer instanceof UrlPreparer) {\n      this.logger.debug(\n        `Removing prepared directory ${preparedDir} since the site has been generated`,\n      );\n      try {\n        // Not a blocker hence no need to await this.\n        fs.remove(preparedDir);\n      } catch (error) {\n        assertError(error);\n        this.logger.debug(`Error removing prepared directory ${error.message}`);\n      }\n    }\n\n    /**\n     * Publish\n     */\n\n    this.logger.info(\n      `Step 3 of 3: Publishing docs for entity ${stringifyEntityRef(\n        this.entity,\n      )}`,\n    );\n\n    const published = await this.publisher.publish({\n      entity: this.entity,\n      directory: outputDir,\n    });\n\n    // Invalidate the cache for any published objects.\n    if (this.cache && published && published?.objects?.length) {\n      this.logger.debug(\n        `Invalidating ${published.objects.length} cache objects`,\n      );\n      await this.cache.invalidateMultiple(published.objects);\n    }\n\n    try {\n      // Not a blocker hence no need to await this.\n      fs.remove(outputDir);\n      this.logger.debug(\n        `Removing generated directory ${outputDir} since the site has been published`,\n      );\n    } catch (error) {\n      assertError(error);\n      this.logger.debug(`Error removing generated directory ${error.message}`);\n    }\n\n    // Update the last check time for the entity\n    new BuildMetadataStorage(this.entity.metadata.uid).setLastUpdated();\n\n    return true;\n  }\n}\n","/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { PluginEndpointDiscovery } from '@backstage/backend-common';\nimport { Entity, DEFAULT_NAMESPACE } from '@backstage/catalog-model';\nimport { Config } from '@backstage/config';\nimport { assertError, NotFoundError } from '@backstage/errors';\nimport { ScmIntegrationRegistry } from '@backstage/integration';\nimport {\n  GeneratorBuilder,\n  PreparerBuilder,\n  PublisherBase,\n} from '@backstage/plugin-techdocs-node';\nimport fetch from 'node-fetch';\nimport { PassThrough } from 'stream';\nimport * as winston from 'winston';\nimport { TechDocsCache } from '../cache';\nimport {\n  BuildMetadataStorage,\n  DocsBuilder,\n  shouldCheckForUpdate,\n} from '../DocsBuilder';\n\nexport type DocsSynchronizerSyncOpts = {\n  log: (message: string) => void;\n  error: (e: Error) => void;\n  finish: (result: { updated: boolean }) => void;\n};\n\nexport class DocsSynchronizer {\n  private readonly publisher: PublisherBase;\n  private readonly logger: winston.Logger;\n  private readonly config: Config;\n  private readonly scmIntegrations: ScmIntegrationRegistry;\n  private readonly cache: TechDocsCache | undefined;\n\n  constructor({\n    publisher,\n    logger,\n    config,\n    scmIntegrations,\n    cache,\n  }: {\n    publisher: PublisherBase;\n    logger: winston.Logger;\n    config: Config;\n    scmIntegrations: ScmIntegrationRegistry;\n    cache: TechDocsCache | undefined;\n  }) {\n    this.config = config;\n    this.logger = logger;\n    this.publisher = publisher;\n    this.scmIntegrations = scmIntegrations;\n    this.cache = cache;\n  }\n\n  async doSync({\n    responseHandler: { log, error, finish },\n    entity,\n    preparers,\n    generators,\n  }: {\n    responseHandler: DocsSynchronizerSyncOpts;\n    entity: Entity;\n    preparers: PreparerBuilder;\n    generators: GeneratorBuilder;\n  }) {\n    // create a new logger to log data to the caller\n    const taskLogger = winston.createLogger({\n      level: process.env.LOG_LEVEL || 'info',\n      format: winston.format.combine(\n        winston.format.colorize(),\n        winston.format.timestamp(),\n        winston.format.simple(),\n      ),\n      defaultMeta: {},\n    });\n\n    // create an in-memory stream to forward logs to the event-stream\n    const logStream = new PassThrough();\n    logStream.on('data', async data => {\n      log(data.toString().trim());\n    });\n\n    taskLogger.add(new winston.transports.Stream({ stream: logStream }));\n\n    // check if the last update check was too recent\n    if (!shouldCheckForUpdate(entity.metadata.uid!)) {\n      finish({ updated: false });\n      return;\n    }\n\n    let foundDocs = false;\n\n    try {\n      const docsBuilder = new DocsBuilder({\n        preparers,\n        generators,\n        publisher: this.publisher,\n        logger: taskLogger,\n        entity,\n        config: this.config,\n        scmIntegrations: this.scmIntegrations,\n        logStream,\n        cache: this.cache,\n      });\n\n      const updated = await docsBuilder.build();\n\n      if (!updated) {\n        finish({ updated: false });\n        return;\n      }\n    } catch (e) {\n      assertError(e);\n      const msg = `Failed to build the docs page: ${e.message}`;\n      taskLogger.error(msg);\n      this.logger.error(msg, e);\n      error(e);\n      return;\n    }\n\n    // With a maximum of ~5 seconds wait, check if the files got published and if docs will be fetched\n    // on the user's page. If not, respond with a message asking them to check back later.\n    // The delay here is to make sure GCS/AWS/etc. registers newly uploaded files which is usually <1 second\n    for (let attempt = 0; attempt < 5; attempt++) {\n      if (await this.publisher.hasDocsBeenGenerated(entity)) {\n        foundDocs = true;\n        break;\n      }\n      await new Promise(r => setTimeout(r, 1000));\n    }\n    if (!foundDocs) {\n      this.logger.error(\n        'Published files are taking longer to show up in storage. Something went wrong.',\n      );\n      error(\n        new NotFoundError(\n          'Sorry! It took too long for the generated docs to show up in storage. Check back later.',\n        ),\n      );\n      return;\n    }\n\n    finish({ updated: true });\n  }\n\n  async doCacheSync({\n    responseHandler: { finish },\n    discovery,\n    token,\n    entity,\n  }: {\n    responseHandler: DocsSynchronizerSyncOpts;\n    discovery: PluginEndpointDiscovery;\n    token: string | undefined;\n    entity: Entity;\n  }) {\n    // Check if the last update check was too recent.\n    if (!shouldCheckForUpdate(entity.metadata.uid!) || !this.cache) {\n      finish({ updated: false });\n      return;\n    }\n\n    // Fetch techdocs_metadata.json from the publisher and from cache.\n    const baseUrl = await discovery.getBaseUrl('techdocs');\n    const namespace = entity.metadata?.namespace || DEFAULT_NAMESPACE;\n    const kind = entity.kind;\n    const name = entity.metadata.name;\n    const legacyPathCasing =\n      this.config.getOptionalBoolean(\n        'techdocs.legacyUseCaseSensitiveTripletPaths',\n      ) || false;\n    const tripletPath = `${namespace}/${kind}/${name}`;\n    const entityTripletPath = `${\n      legacyPathCasing ? tripletPath : tripletPath.toLocaleLowerCase('en-US')\n    }`;\n    try {\n      const [sourceMetadata, cachedMetadata] = await Promise.all([\n        this.publisher.fetchTechDocsMetadata({ namespace, kind, name }),\n        fetch(\n          `${baseUrl}/static/docs/${entityTripletPath}/techdocs_metadata.json`,\n          {\n            headers: token ? { Authorization: `Bearer ${token}` } : {},\n          },\n        ).then(\n          f =>\n            f.json().catch(() => undefined) as ReturnType<\n              PublisherBase['fetchTechDocsMetadata']\n            >,\n        ),\n      ]);\n\n      // If build timestamps differ, merge their files[] lists and invalidate all objects.\n      if (sourceMetadata.build_timestamp !== cachedMetadata.build_timestamp) {\n        const files = [\n          ...new Set([\n            ...(sourceMetadata.files || []),\n            ...(cachedMetadata.files || []),\n          ]),\n        ].map(f => `${entityTripletPath}/${f}`);\n        await this.cache.invalidateMultiple(files);\n        finish({ updated: true });\n      } else {\n        finish({ updated: false });\n      }\n    } catch (e) {\n      assertError(e);\n      // In case of error, log and allow the user to go about their business.\n      this.logger.error(\n        `Error syncing cache for ${entityTripletPath}: ${e.message}`,\n      );\n      finish({ updated: false });\n    } finally {\n      // Update the last check time for the entity\n      new BuildMetadataStorage(entity.metadata.uid!).setLastUpdated();\n    }\n  }\n}\n","/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { Router } from 'express';\nimport router from 'express-promise-router';\nimport { Logger } from 'winston';\nimport { TechDocsCache } from './TechDocsCache';\n\ntype CacheMiddlewareOptions = {\n  cache: TechDocsCache;\n  logger: Logger;\n};\n\ntype ErrorCallback = (err?: Error) => void;\n\nexport const createCacheMiddleware = ({\n  cache,\n}: CacheMiddlewareOptions): Router => {\n  const cacheMiddleware = router();\n\n  // Middleware that, through socket monkey patching, captures responses as\n  // they're sent over /static/docs/* and caches them. Subsequent requests are\n  // loaded from cache. Cache key is the object's path (after `/static/docs/`).\n  cacheMiddleware.use(async (req, res, next) => {\n    const socket = res.socket;\n    const isCacheable = req.path.startsWith('/static/docs/');\n\n    // Continue early if this is non-cacheable, or there's no socket.\n    if (!isCacheable || !socket) {\n      next();\n      return;\n    }\n\n    // Make concrete references to these things.\n    const reqPath = decodeURI(req.path.match(/\\/static\\/docs\\/(.*)$/)![1]);\n    const realEnd = socket.end.bind(socket);\n    const realWrite = socket.write.bind(socket);\n    let writeToCache = true;\n    const chunks: Buffer[] = [];\n\n    // Monkey-patch the response's socket to keep track of chunks as they are\n    // written over the wire.\n    socket.write = (\n      data: string | Uint8Array,\n      encoding?: BufferEncoding | ErrorCallback,\n      callback?: ErrorCallback,\n    ) => {\n      chunks.push(Buffer.from(data));\n      if (typeof encoding === 'function') {\n        return realWrite(data, encoding);\n      }\n      return realWrite(data, encoding, callback);\n    };\n\n    // When a socket is closed, if there were no errors and the data written\n    // over the socket should be cached, cache it!\n    socket.on('close', async hadError => {\n      const content = Buffer.concat(chunks);\n      const head = content.toString('utf8', 0, 12);\n      if (writeToCache && !hadError && head.match(/HTTP\\/\\d\\.\\d 200/)) {\n        await cache.set(reqPath, content);\n      }\n    });\n\n    // Attempt to retrieve data from the cache.\n    const cached = await cache.get(reqPath);\n\n    // If there is a cache hit, write it out on the socket, ensure we don't re-\n    // cache the data, and prevent going back to canonical storage by never\n    // calling next().\n    if (cached) {\n      writeToCache = false;\n      realEnd(cached);\n      return;\n    }\n\n    // No data retrieved from cache: allow retrieval from canonical storage.\n    next();\n  });\n\n  return cacheMiddleware;\n};\n","/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { CacheClient } from '@backstage/backend-common';\nimport { assertError, CustomErrorBase } from '@backstage/errors';\nimport { Config } from '@backstage/config';\nimport { Logger } from 'winston';\n\nexport class CacheInvalidationError extends CustomErrorBase {}\n\nexport class TechDocsCache {\n  protected readonly cache: CacheClient;\n  protected readonly logger: Logger;\n  protected readonly readTimeout: number;\n\n  private constructor({\n    cache,\n    logger,\n    readTimeout,\n  }: {\n    cache: CacheClient;\n    logger: Logger;\n    readTimeout: number;\n  }) {\n    this.cache = cache;\n    this.logger = logger;\n    this.readTimeout = readTimeout;\n  }\n\n  static fromConfig(\n    config: Config,\n    { cache, logger }: { cache: CacheClient; logger: Logger },\n  ) {\n    const timeout = config.getOptionalNumber('techdocs.cache.readTimeout');\n    const readTimeout = timeout === undefined ? 1000 : timeout;\n    return new TechDocsCache({ cache, logger, readTimeout });\n  }\n\n  async get(path: string): Promise<Buffer | undefined> {\n    try {\n      // Promise.race ensures we don't hang the client for long if the cache is\n      // temporarily unreachable.\n      const response = (await Promise.race([\n        this.cache.get(path),\n        new Promise(cancelAfter => setTimeout(cancelAfter, this.readTimeout)),\n      ])) as string | undefined;\n\n      if (response !== undefined) {\n        this.logger.debug(`Cache hit: ${path}`);\n        return Buffer.from(response, 'base64');\n      }\n\n      this.logger.debug(`Cache miss: ${path}`);\n      return response;\n    } catch (e) {\n      assertError(e);\n      this.logger.warn(`Error getting cache entry ${path}: ${e.message}`);\n      this.logger.debug(e.stack);\n      return undefined;\n    }\n  }\n\n  async set(path: string, data: Buffer): Promise<void> {\n    this.logger.debug(`Writing cache entry for ${path}`);\n    this.cache\n      .set(path, data.toString('base64'))\n      .catch(e => this.logger.error('write error', e));\n  }\n\n  async invalidate(path: string): Promise<void> {\n    return this.cache.delete(path);\n  }\n\n  async invalidateMultiple(\n    paths: string[],\n  ): Promise<PromiseSettledResult<void>[]> {\n    const settled = await Promise.allSettled(\n      paths.map(path => this.cache.delete(path)),\n    );\n    const rejected = settled.filter(\n      s => s.status === 'rejected',\n    ) as PromiseRejectedResult[];\n\n    if (rejected.length) {\n      throw new CacheInvalidationError(\n        'TechDocs cache invalidation error',\n        rejected,\n      );\n    }\n\n    return settled;\n  }\n}\n","/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { CatalogClient } from '@backstage/catalog-client';\nimport { CacheClient } from '@backstage/backend-common';\nimport {\n  Entity,\n  CompoundEntityRef,\n  stringifyEntityRef,\n} from '@backstage/catalog-model';\n\nexport type CachedEntityLoaderOptions = {\n  catalog: CatalogClient;\n  cache: CacheClient;\n};\n\nexport class CachedEntityLoader {\n  private readonly catalog: CatalogClient;\n  private readonly cache: CacheClient;\n  private readonly readTimeout = 1000;\n\n  constructor({ catalog, cache }: CachedEntityLoaderOptions) {\n    this.catalog = catalog;\n    this.cache = cache;\n  }\n\n  async load(\n    entityRef: CompoundEntityRef,\n    token: string | undefined,\n  ): Promise<Entity | undefined> {\n    const cacheKey = this.getCacheKey(entityRef, token);\n    let result = await this.getFromCache(cacheKey);\n\n    if (result) {\n      return result;\n    }\n\n    result = await this.catalog.getEntityByRef(entityRef, { token });\n\n    if (result) {\n      this.cache.set(cacheKey, result, { ttl: 5000 });\n    }\n\n    return result;\n  }\n\n  private async getFromCache(key: string): Promise<Entity | undefined> {\n    // Promise.race ensures we don't hang the client for long if the cache is\n    // temporarily unreachable.\n    return (await Promise.race([\n      this.cache.get(key),\n      new Promise(cancelAfter => setTimeout(cancelAfter, this.readTimeout)),\n    ])) as Entity | undefined;\n  }\n\n  private getCacheKey(\n    entityName: CompoundEntityRef,\n    token: string | undefined,\n  ): string {\n    const key = ['catalog', stringifyEntityRef(entityName)];\n\n    if (token) {\n      key.push(token);\n    }\n\n    return key.join(':');\n  }\n}\n","/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { Entity } from '@backstage/catalog-model';\nimport { Config } from '@backstage/config';\n\n/**\n * Parameters passed to the shouldBuild method on the DocsBuildStrategy interface\n *\n * @public\n */\nexport type ShouldBuildParameters = {\n  entity: Entity;\n};\n\n/**\n * A strategy for when to build TechDocs locally, and when to skip building TechDocs (allowing for an external build)\n *\n * @public\n */\nexport interface DocsBuildStrategy {\n  shouldBuild(params: ShouldBuildParameters): Promise<boolean>;\n}\n\nexport class DefaultDocsBuildStrategy {\n  private readonly config: Config;\n\n  private constructor(config: Config) {\n    this.config = config;\n  }\n\n  static fromConfig(config: Config): DefaultDocsBuildStrategy {\n    return new DefaultDocsBuildStrategy(config);\n  }\n\n  async shouldBuild(_: ShouldBuildParameters): Promise<boolean> {\n    return this.config.getString('techdocs.builder') === 'local';\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {\n  PluginEndpointDiscovery,\n  PluginCacheManager,\n} from '@backstage/backend-common';\nimport { CatalogClient } from '@backstage/catalog-client';\nimport { stringifyEntityRef } from '@backstage/catalog-model';\nimport { Config } from '@backstage/config';\nimport { NotFoundError } from '@backstage/errors';\nimport {\n  GeneratorBuilder,\n  getLocationForEntity,\n  PreparerBuilder,\n  PublisherBase,\n} from '@backstage/plugin-techdocs-node';\nimport express, { Response } from 'express';\nimport Router from 'express-promise-router';\nimport { Knex } from 'knex';\nimport { Logger } from 'winston';\nimport { ScmIntegrations } from '@backstage/integration';\nimport { DocsSynchronizer, DocsSynchronizerSyncOpts } from './DocsSynchronizer';\nimport { createCacheMiddleware, TechDocsCache } from '../cache';\nimport { CachedEntityLoader } from './CachedEntityLoader';\nimport {\n  DefaultDocsBuildStrategy,\n  DocsBuildStrategy,\n} from './DocsBuildStrategy';\n\n/**\n * Required dependencies for running TechDocs in the \"out-of-the-box\"\n * deployment configuration (prepare/generate/publish all in the Backend).\n *\n * @public\n */\nexport type OutOfTheBoxDeploymentOptions = {\n  preparers: PreparerBuilder;\n  generators: GeneratorBuilder;\n  publisher: PublisherBase;\n  logger: Logger;\n  discovery: PluginEndpointDiscovery;\n  database?: Knex; // TODO: Make database required when we're implementing database stuff.\n  config: Config;\n  cache: PluginCacheManager;\n  docsBuildStrategy?: DocsBuildStrategy;\n};\n\n/**\n * Required dependencies for running TechDocs in the \"recommended\" deployment\n * configuration (prepare/generate handled externally in CI/CD).\n *\n * @public\n */\nexport type RecommendedDeploymentOptions = {\n  publisher: PublisherBase;\n  logger: Logger;\n  discovery: PluginEndpointDiscovery;\n  config: Config;\n  cache: PluginCacheManager;\n  docsBuildStrategy?: DocsBuildStrategy;\n};\n\n/**\n * One of the two deployment configurations must be provided.\n *\n * @public\n */\nexport type RouterOptions =\n  | RecommendedDeploymentOptions\n  | OutOfTheBoxDeploymentOptions;\n\n/**\n * Typeguard to help createRouter() understand when we are in a \"recommended\"\n * deployment vs. when we are in an out-of-the-box deployment configuration.\n *\n * * @public\n */\nfunction isOutOfTheBoxOption(\n  opt: RouterOptions,\n): opt is OutOfTheBoxDeploymentOptions {\n  return (opt as OutOfTheBoxDeploymentOptions).preparers !== undefined;\n}\n\n/**\n * Creates a techdocs router.\n *\n * @public\n */\nexport async function createRouter(\n  options: RouterOptions,\n): Promise<express.Router> {\n  const router = Router();\n  const { publisher, config, logger, discovery } = options;\n  const catalogClient = new CatalogClient({ discoveryApi: discovery });\n  const docsBuildStrategy =\n    options.docsBuildStrategy ?? DefaultDocsBuildStrategy.fromConfig(config);\n\n  // Entities are cached to optimize the /static/docs request path, which can be called many times\n  // when loading a single techdocs page.\n  const entityLoader = new CachedEntityLoader({\n    catalog: catalogClient,\n    cache: options.cache.getClient(),\n  });\n\n  // Set up a cache client if configured.\n  let cache: TechDocsCache | undefined;\n  const defaultTtl = config.getOptionalNumber('techdocs.cache.ttl');\n  if (defaultTtl) {\n    const cacheClient = options.cache.getClient({ defaultTtl });\n    cache = TechDocsCache.fromConfig(config, { cache: cacheClient, logger });\n  }\n\n  const scmIntegrations = ScmIntegrations.fromConfig(config);\n  const docsSynchronizer = new DocsSynchronizer({\n    publisher,\n    logger,\n    config,\n    scmIntegrations,\n    cache,\n  });\n\n  router.get('/metadata/techdocs/:namespace/:kind/:name', async (req, res) => {\n    const { kind, namespace, name } = req.params;\n    const entityName = { kind, namespace, name };\n    const token = getBearerToken(req.headers.authorization);\n\n    // Verify that the related entity exists and the current user has permission to view it.\n    const entity = await entityLoader.load(entityName, token);\n\n    if (!entity) {\n      throw new NotFoundError(\n        `Unable to get metadata for '${stringifyEntityRef(entityName)}'`,\n      );\n    }\n\n    try {\n      const techdocsMetadata = await publisher.fetchTechDocsMetadata(\n        entityName,\n      );\n\n      res.json(techdocsMetadata);\n    } catch (err) {\n      logger.info(\n        `Unable to get metadata for '${stringifyEntityRef(\n          entityName,\n        )}' with error ${err}`,\n      );\n      throw new NotFoundError(\n        `Unable to get metadata for '${stringifyEntityRef(entityName)}'`,\n        err,\n      );\n    }\n  });\n\n  router.get('/metadata/entity/:namespace/:kind/:name', async (req, res) => {\n    const { kind, namespace, name } = req.params;\n    const entityName = { kind, namespace, name };\n    const token = getBearerToken(req.headers.authorization);\n\n    const entity = await entityLoader.load(entityName, token);\n\n    if (!entity) {\n      throw new NotFoundError(\n        `Unable to get metadata for '${stringifyEntityRef(entityName)}'`,\n      );\n    }\n\n    try {\n      const locationMetadata = getLocationForEntity(entity, scmIntegrations);\n      res.json({ ...entity, locationMetadata });\n    } catch (err) {\n      logger.info(\n        `Unable to get metadata for '${stringifyEntityRef(\n          entityName,\n        )}' with error ${err}`,\n      );\n      throw new NotFoundError(\n        `Unable to get metadata for '${stringifyEntityRef(entityName)}'`,\n        err,\n      );\n    }\n  });\n\n  // Check if docs are the latest version and trigger rebuilds if not\n  // Responds with an event-stream that closes after the build finished\n  // Responds with an immediate success if rebuild not needed\n  // If a build is required, responds with a success when finished\n  router.get('/sync/:namespace/:kind/:name', async (req, res) => {\n    const { kind, namespace, name } = req.params;\n    const token = getBearerToken(req.headers.authorization);\n\n    const entity = await entityLoader.load({ kind, namespace, name }, token);\n\n    if (!entity?.metadata?.uid) {\n      throw new NotFoundError('Entity metadata UID missing');\n    }\n\n    const responseHandler: DocsSynchronizerSyncOpts = createEventStream(res);\n\n    // By default, techdocs-backend will only try to build documentation for an entity if techdocs.builder is set to\n    // 'local'. If set to 'external', it will assume that an external process (e.g. CI/CD pipeline\n    // of the repository) is responsible for building and publishing documentation to the storage provider.\n    // Altering the implementation of the injected docsBuildStrategy allows for more complex behaviours, based on\n    // either config or the properties of the entity (e.g. annotations, labels, spec fields etc.).\n    const shouldBuild = await docsBuildStrategy.shouldBuild({ entity });\n    if (!shouldBuild) {\n      // However, if caching is enabled, take the opportunity to check and\n      // invalidate stale cache entries.\n      if (cache) {\n        await docsSynchronizer.doCacheSync({\n          responseHandler,\n          discovery,\n          token,\n          entity,\n        });\n        return;\n      }\n      responseHandler.finish({ updated: false });\n      return;\n    }\n\n    // Set the synchronization and build process if \"out-of-the-box\" configuration is provided.\n    if (isOutOfTheBoxOption(options)) {\n      const { preparers, generators } = options;\n\n      await docsSynchronizer.doSync({\n        responseHandler,\n        entity,\n        preparers,\n        generators,\n      });\n      return;\n    }\n\n    responseHandler.error(\n      new Error(\n        \"Invalid configuration. docsBuildStrategy.shouldBuild returned 'true', but no 'preparer' was provided to the router initialization.\",\n      ),\n    );\n  });\n\n  // Ensures that the related entity exists and the current user has permission to view it.\n  if (config.getOptionalBoolean('permission.enabled')) {\n    router.use(\n      '/static/docs/:namespace/:kind/:name',\n      async (req, _res, next) => {\n        const { kind, namespace, name } = req.params;\n        const entityName = { kind, namespace, name };\n        const token = getBearerToken(req.headers.authorization);\n\n        const entity = await entityLoader.load(entityName, token);\n\n        if (!entity) {\n          throw new NotFoundError(\n            `Entity not found for ${stringifyEntityRef(entityName)}`,\n          );\n        }\n\n        next();\n      },\n    );\n  }\n\n  // If a cache manager was provided, attach the cache middleware.\n  if (cache) {\n    router.use(createCacheMiddleware({ logger, cache }));\n  }\n\n  // Route middleware which serves files from the storage set in the publisher.\n  router.use('/static/docs', publisher.docsRouter());\n\n  return router;\n}\n\nfunction getBearerToken(header?: string): string | undefined {\n  return header?.match(/(?:Bearer)\\s+(\\S+)/i)?.[1];\n}\n\n/**\n * Create an event-stream response that emits the events 'log', 'error', and 'finish'.\n *\n * @param res - the response to write the event-stream to\n * @returns A tuple of <log, error, finish> callbacks to emit messages. A call to 'error' or 'finish'\n *          will close the event-stream.\n */\nexport function createEventStream(\n  res: Response<any, any>,\n): DocsSynchronizerSyncOpts {\n  // Mandatory headers and http status to keep connection open\n  res.writeHead(200, {\n    Connection: 'keep-alive',\n    'Cache-Control': 'no-cache',\n    'Content-Type': 'text/event-stream',\n  });\n\n  // client closes connection\n  res.socket?.on('close', () => {\n    res.end();\n  });\n\n  // write the event to the stream\n  const send = (type: 'error' | 'finish' | 'log', data: any) => {\n    res.write(`event: ${type}\\ndata: ${JSON.stringify(data)}\\n\\n`);\n\n    // res.flush() is only available with the compression middleware\n    if (res.flush) {\n      res.flush();\n    }\n  };\n\n  return {\n    log: data => {\n      send('log', data);\n    },\n\n    error: e => {\n      send('error', e.message);\n      res.end();\n    },\n\n    finish: result => {\n      send('finish', result);\n      res.end();\n    },\n  };\n}\n","/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  PluginEndpointDiscovery,\n  TokenManager,\n} from '@backstage/backend-common';\nimport {\n  CatalogApi,\n  CatalogClient,\n  CATALOG_FILTER_EXISTS,\n} from '@backstage/catalog-client';\nimport {\n  Entity,\n  parseEntityRef,\n  RELATION_OWNED_BY,\n  stringifyEntityRef,\n} from '@backstage/catalog-model';\nimport { Config } from '@backstage/config';\nimport { catalogEntityReadPermission } from '@backstage/plugin-catalog-common';\nimport { DocumentCollatorFactory } from '@backstage/plugin-search-common';\nimport { TechDocsDocument } from '@backstage/plugin-techdocs-node';\nimport unescape from 'lodash/unescape';\nimport fetch from 'node-fetch';\nimport pLimit from 'p-limit';\nimport { Readable } from 'stream';\nimport { Logger } from 'winston';\n\ninterface MkSearchIndexDoc {\n  title: string;\n  text: string;\n  location: string;\n}\n\n/**\n * Options to configure the TechDocs collator factory\n *\n * @public\n */\nexport type TechDocsCollatorFactoryOptions = {\n  discovery: PluginEndpointDiscovery;\n  logger: Logger;\n  tokenManager: TokenManager;\n  locationTemplate?: string;\n  catalogClient?: CatalogApi;\n  parallelismLimit?: number;\n  legacyPathCasing?: boolean;\n};\n\ntype EntityInfo = {\n  name: string;\n  namespace: string;\n  kind: string;\n};\n\n/**\n * A search collator factory responsible for gathering and transforming\n * TechDocs documents.\n *\n * @public\n */\nexport class DefaultTechDocsCollatorFactory implements DocumentCollatorFactory {\n  public readonly type: string = 'techdocs';\n  public readonly visibilityPermission = catalogEntityReadPermission;\n\n  private discovery: PluginEndpointDiscovery;\n  private locationTemplate: string;\n  private readonly logger: Logger;\n  private readonly catalogClient: CatalogApi;\n  private readonly tokenManager: TokenManager;\n  private readonly parallelismLimit: number;\n  private readonly legacyPathCasing: boolean;\n\n  private constructor(options: TechDocsCollatorFactoryOptions) {\n    this.discovery = options.discovery;\n    this.locationTemplate =\n      options.locationTemplate || '/docs/:namespace/:kind/:name/:path';\n    this.logger = options.logger;\n    this.catalogClient =\n      options.catalogClient ||\n      new CatalogClient({ discoveryApi: options.discovery });\n    this.parallelismLimit = options.parallelismLimit ?? 10;\n    this.legacyPathCasing = options.legacyPathCasing ?? false;\n    this.tokenManager = options.tokenManager;\n  }\n\n  static fromConfig(config: Config, options: TechDocsCollatorFactoryOptions) {\n    const legacyPathCasing =\n      config.getOptionalBoolean(\n        'techdocs.legacyUseCaseSensitiveTripletPaths',\n      ) || false;\n    return new DefaultTechDocsCollatorFactory({ ...options, legacyPathCasing });\n  }\n\n  async getCollator(): Promise<Readable> {\n    return Readable.from(this.execute());\n  }\n\n  private async *execute(): AsyncGenerator<TechDocsDocument, void, undefined> {\n    const limit = pLimit(this.parallelismLimit);\n    const techDocsBaseUrl = await this.discovery.getBaseUrl('techdocs');\n    const { token } = await this.tokenManager.getToken();\n    let entitiesRetrieved = 0;\n    let moreEntitiesToGet = true;\n\n    // Offset/limit pagination is used on the Catalog Client in order to\n    // limit (and allow some control over) memory used by the search backend\n    // at index-time. The batchSize is calculated as a factor of the given\n    // parallelism limit to simplify configuration.\n    const batchSize = this.parallelismLimit * 50;\n    while (moreEntitiesToGet) {\n      const entities = (\n        await this.catalogClient.getEntities(\n          {\n            filter: {\n              'metadata.annotations.backstage.io/techdocs-ref':\n                CATALOG_FILTER_EXISTS,\n            },\n            fields: [\n              'kind',\n              'namespace',\n              'metadata.annotations',\n              'metadata.name',\n              'metadata.title',\n              'metadata.namespace',\n              'spec.type',\n              'spec.lifecycle',\n              'relations',\n            ],\n            limit: batchSize,\n            offset: entitiesRetrieved,\n          },\n          { token },\n        )\n      ).items;\n\n      // Control looping through entity batches.\n      moreEntitiesToGet = entities.length === batchSize;\n      entitiesRetrieved += entities.length;\n\n      const docPromises = entities\n        .filter(it => it.metadata?.annotations?.['backstage.io/techdocs-ref'])\n        .map((entity: Entity) =>\n          limit(async (): Promise<TechDocsDocument[]> => {\n            const entityInfo =\n              DefaultTechDocsCollatorFactory.handleEntityInfoCasing(\n                this.legacyPathCasing,\n                {\n                  kind: entity.kind,\n                  namespace: entity.metadata.namespace || 'default',\n                  name: entity.metadata.name,\n                },\n              );\n\n            try {\n              const searchIndexResponse = await fetch(\n                DefaultTechDocsCollatorFactory.constructDocsIndexUrl(\n                  techDocsBaseUrl,\n                  entityInfo,\n                ),\n                {\n                  headers: {\n                    Authorization: `Bearer ${token}`,\n                  },\n                },\n              );\n              const searchIndex = await searchIndexResponse.json();\n\n              return searchIndex.docs.map((doc: MkSearchIndexDoc) => ({\n                title: unescape(doc.title),\n                text: unescape(doc.text || ''),\n                location: this.applyArgsToFormat(\n                  this.locationTemplate || '/docs/:namespace/:kind/:name/:path',\n                  {\n                    ...entityInfo,\n                    path: doc.location,\n                  },\n                ),\n                path: doc.location,\n                ...entityInfo,\n                entityTitle: entity.metadata.title,\n                componentType: entity.spec?.type?.toString() || 'other',\n                lifecycle: (entity.spec?.lifecycle as string) || '',\n                owner: getSimpleEntityOwnerString(entity),\n                authorization: {\n                  resourceRef: stringifyEntityRef(entity),\n                },\n              }));\n            } catch (e) {\n              this.logger.debug(\n                `Failed to retrieve tech docs search index for entity ${entityInfo.namespace}/${entityInfo.kind}/${entityInfo.name}`,\n                e,\n              );\n              return [];\n            }\n          }),\n        );\n      yield* (await Promise.all(docPromises)).flat();\n    }\n  }\n\n  private applyArgsToFormat(\n    format: string,\n    args: Record<string, string>,\n  ): string {\n    let formatted = format;\n    for (const [key, value] of Object.entries(args)) {\n      formatted = formatted.replace(`:${key}`, value);\n    }\n    return formatted;\n  }\n\n  private static constructDocsIndexUrl(\n    techDocsBaseUrl: string,\n    entityInfo: { kind: string; namespace: string; name: string },\n  ) {\n    return `${techDocsBaseUrl}/static/docs/${entityInfo.namespace}/${entityInfo.kind}/${entityInfo.name}/search/search_index.json`;\n  }\n\n  private static handleEntityInfoCasing(\n    legacyPaths: boolean,\n    entityInfo: EntityInfo,\n  ): EntityInfo {\n    return legacyPaths\n      ? entityInfo\n      : Object.entries(entityInfo).reduce((acc, [key, value]) => {\n          return { ...acc, [key]: value.toLocaleLowerCase('en-US') };\n        }, {} as EntityInfo);\n  }\n}\n\nfunction getSimpleEntityOwnerString(entity: Entity): string {\n  if (entity.relations) {\n    const owner = entity.relations.find(r => r.type === RELATION_OWNED_BY);\n    if (owner) {\n      const { name } = parseEntityRef(owner.targetRef);\n      return name;\n    }\n  }\n  return '';\n}\n","/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  PluginEndpointDiscovery,\n  TokenManager,\n} from '@backstage/backend-common';\nimport {\n  Entity,\n  parseEntityRef,\n  RELATION_OWNED_BY,\n  stringifyEntityRef,\n} from '@backstage/catalog-model';\nimport fetch from 'node-fetch';\nimport unescape from 'lodash/unescape';\nimport { Logger } from 'winston';\nimport pLimit from 'p-limit';\nimport { Config } from '@backstage/config';\nimport { catalogEntityReadPermission } from '@backstage/plugin-catalog-common';\nimport {\n  CatalogApi,\n  CatalogClient,\n  CATALOG_FILTER_EXISTS,\n} from '@backstage/catalog-client';\nimport { TechDocsDocument } from '@backstage/plugin-techdocs-node';\n\ninterface MkSearchIndexDoc {\n  title: string;\n  text: string;\n  location: string;\n}\n\n/**\n * Options to configure the TechDocs collator\n *\n * @public\n */\nexport type TechDocsCollatorOptions = {\n  discovery: PluginEndpointDiscovery;\n  logger: Logger;\n  tokenManager: TokenManager;\n  locationTemplate?: string;\n  catalogClient?: CatalogApi;\n  parallelismLimit?: number;\n  legacyPathCasing?: boolean;\n};\n\ntype EntityInfo = {\n  name: string;\n  namespace: string;\n  kind: string;\n};\n\n/**\n * A search collator responsible for gathering and transforming TechDocs documents.\n *\n * @public\n * @deprecated Upgrade to a more recent `@backstage/search-backend-node` and\n * use `DefaultTechDocsCollatorFactory` instead.\n */\nexport class DefaultTechDocsCollator {\n  public readonly type: string = 'techdocs';\n  public readonly visibilityPermission = catalogEntityReadPermission;\n\n  private constructor(\n    private readonly legacyPathCasing: boolean,\n    private readonly options: TechDocsCollatorOptions,\n  ) {}\n\n  static fromConfig(config: Config, options: TechDocsCollatorOptions) {\n    const legacyPathCasing =\n      config.getOptionalBoolean(\n        'techdocs.legacyUseCaseSensitiveTripletPaths',\n      ) || false;\n    return new DefaultTechDocsCollator(legacyPathCasing, options);\n  }\n\n  async execute() {\n    const {\n      parallelismLimit,\n      discovery,\n      tokenManager,\n      catalogClient,\n      locationTemplate,\n      logger,\n    } = this.options;\n    const limit = pLimit(parallelismLimit ?? 10);\n    const techDocsBaseUrl = await discovery.getBaseUrl('techdocs');\n    const { token } = await tokenManager.getToken();\n    const entities = await (\n      catalogClient ?? new CatalogClient({ discoveryApi: discovery })\n    ).getEntities(\n      {\n        filter: {\n          'metadata.annotations.backstage.io/techdocs-ref':\n            CATALOG_FILTER_EXISTS,\n        },\n        fields: [\n          'kind',\n          'namespace',\n          'metadata.annotations',\n          'metadata.name',\n          'metadata.title',\n          'metadata.namespace',\n          'spec.type',\n          'spec.lifecycle',\n          'relations',\n        ],\n      },\n      { token },\n    );\n    const docPromises = entities.items.map((entity: Entity) =>\n      limit(async (): Promise<TechDocsDocument[]> => {\n        const entityInfo = DefaultTechDocsCollator.handleEntityInfoCasing(\n          this.legacyPathCasing ?? false,\n          {\n            kind: entity.kind,\n            namespace: entity.metadata.namespace || 'default',\n            name: entity.metadata.name,\n          },\n        );\n\n        try {\n          const searchIndexResponse = await fetch(\n            DefaultTechDocsCollator.constructDocsIndexUrl(\n              techDocsBaseUrl,\n              entityInfo,\n            ),\n            {\n              headers: {\n                Authorization: `Bearer ${token}`,\n              },\n            },\n          );\n          const searchIndex = await searchIndexResponse.json();\n\n          return searchIndex.docs.map((doc: MkSearchIndexDoc) => ({\n            title: unescape(doc.title),\n            text: unescape(doc.text || ''),\n            location: this.applyArgsToFormat(\n              locationTemplate || '/docs/:namespace/:kind/:name/:path',\n              {\n                ...entityInfo,\n                path: doc.location,\n              },\n            ),\n            path: doc.location,\n            ...entityInfo,\n            entityTitle: entity.metadata.title,\n            componentType: entity.spec?.type?.toString() || 'other',\n            lifecycle: (entity.spec?.lifecycle as string) || '',\n            owner: getSimpleEntityOwnerString(entity),\n            authorization: {\n              resourceRef: stringifyEntityRef(entity),\n            },\n          }));\n        } catch (e) {\n          logger.debug(\n            `Failed to retrieve tech docs search index for entity ${entityInfo.namespace}/${entityInfo.kind}/${entityInfo.name}`,\n            e,\n          );\n          return [];\n        }\n      }),\n    );\n    return (await Promise.all(docPromises)).flat();\n  }\n\n  protected applyArgsToFormat(\n    format: string,\n    args: Record<string, string>,\n  ): string {\n    let formatted = format;\n    for (const [key, value] of Object.entries(args)) {\n      formatted = formatted.replace(`:${key}`, value);\n    }\n    return formatted;\n  }\n\n  private static constructDocsIndexUrl(\n    techDocsBaseUrl: string,\n    entityInfo: { kind: string; namespace: string; name: string },\n  ) {\n    return `${techDocsBaseUrl}/static/docs/${entityInfo.namespace}/${entityInfo.kind}/${entityInfo.name}/search/search_index.json`;\n  }\n\n  private static handleEntityInfoCasing(\n    legacyPaths: boolean,\n    entityInfo: EntityInfo,\n  ): EntityInfo {\n    return legacyPaths\n      ? entityInfo\n      : Object.entries(entityInfo).reduce((acc, [key, value]) => {\n          return { ...acc, [key]: value.toLocaleLowerCase('en-US') };\n        }, {} as EntityInfo);\n  }\n}\n\nfunction getSimpleEntityOwnerString(entity: Entity): string {\n  if (entity.relations) {\n    const owner = entity.relations.find(r => r.type === RELATION_OWNED_BY);\n    if (owner) {\n      const { name } = parseEntityRef(owner.targetRef);\n      return name;\n    }\n  }\n  return '';\n}\n"],"names":["stringifyEntityRef","DEFAULT_NAMESPACE","isError","os","fs","path","getLocationForEntity","UrlPreparer","assertError","winston","PassThrough","NotFoundError","fetch","router","CustomErrorBase","Router","catalogClient","CatalogClient","ScmIntegrations","catalogEntityReadPermission","Readable","pLimit","CATALOG_FILTER_EXISTS","unescape","getSimpleEntityOwnerString","RELATION_OWNED_BY","parseEntityRef"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAiBA,MAAM,iBAAoB,GAAA,EAAA,CAAA;AAMQ,MAAA,oBAAA,CAAA;AAAA,EAIhC,YAAY,SAAmB,EAAA;AAC7B,IAAA,IAAA,CAAK,SAAY,GAAA,SAAA,CAAA;AACjB,IAAA,IAAA,CAAK,iBAAoB,GAAA,iBAAA,CAAA;AAAA,GAAA;AAAA,EAG3B,cAAuB,GAAA;AACrB,IAAK,IAAA,CAAA,iBAAA,CAAkB,IAAK,CAAA,SAAA,CAAA,GAAa,IAAK,CAAA,GAAA,EAAA,CAAA;AAAA,GAAA;AAAA,EAGhD,cAAqC,GAAA;AACnC,IAAO,OAAA,IAAA,CAAK,kBAAkB,IAAK,CAAA,SAAA,CAAA,CAAA;AAAA,GAAA;AAAA,CAAA;AAO1B,MAAA,oBAAA,GAAuB,CAAC,SAAsB,KAAA;AACzD,EAAM,MAAA,WAAA,GAAc,IAAI,oBAAA,CAAqB,SAAW,CAAA,CAAA,cAAA,EAAA,CAAA;AACxD,EAAA,IAAI,WAAa,EAAA;AAEf,IAAA,IAAI,IAAK,CAAA,GAAA,EAAA,GAAQ,WAAc,GAAA,EAAA,GAAK,GAAM,EAAA;AACxC,MAAO,OAAA,KAAA,CAAA;AAAA,KAAA;AAAA,GAAA;AAGX,EAAO,OAAA,IAAA,CAAA;AAAA,CAAA;;ACAgB,MAAA,WAAA,CAAA;AAAA,EAWvB,WAAY,CAAA;AAAA,IACV,SAAA;AAAA,IACA,UAAA;AAAA,IACA,SAAA;AAAA,IACA,MAAA;AAAA,IACA,MAAA;AAAA,IACA,MAAA;AAAA,IACA,eAAA;AAAA,IACA,SAAA;AAAA,IACA,KAAA;AAAA,GACuB,EAAA;AACvB,IAAK,IAAA,CAAA,QAAA,GAAW,UAAU,GAAI,CAAA,MAAA,CAAA,CAAA;AAC9B,IAAK,IAAA,CAAA,SAAA,GAAY,WAAW,GAAI,CAAA,MAAA,CAAA,CAAA;AAChC,IAAA,IAAA,CAAK,SAAY,GAAA,SAAA,CAAA;AACjB,IAAA,IAAA,CAAK,MAAS,GAAA,MAAA,CAAA;AACd,IAAA,IAAA,CAAK,MAAS,GAAA,MAAA,CAAA;AACd,IAAA,IAAA,CAAK,MAAS,GAAA,MAAA,CAAA;AACd,IAAA,IAAA,CAAK,eAAkB,GAAA,eAAA,CAAA;AACvB,IAAA,IAAA,CAAK,SAAY,GAAA,SAAA,CAAA;AACjB,IAAA,IAAA,CAAK,KAAQ,GAAA,KAAA,CAAA;AAAA,GAAA;AAAA,EAAA,MAOF,KAA0B,GAAA;AAzFzC,IAAA,IAAA,EAAA,EAAA,EAAA,CAAA;AA0FI,IAAA,IAAI,CAAC,IAAA,CAAK,MAAO,CAAA,QAAA,CAAS,GAAK,EAAA;AAC7B,MAAA,MAAM,IAAI,KACR,CAAA,kEAAA,CAAA,CAAA;AAAA,KAAA;AAQJ,IAAA,IAAA,CAAK,MAAO,CAAA,IAAA,CACV,CAA0C,uCAAA,EAAAA,+BAAA,CACxC,IAAK,CAAA,MAAA,CAAA,CAAA,CAAA,CAAA,CAAA;AAMT,IAAI,IAAA,UAAA,CAAA;AACJ,IAAA,IAAI,MAAM,IAAA,CAAK,SAAU,CAAA,oBAAA,CAAqB,KAAK,MAAS,CAAA,EAAA;AAC1D,MAAI,IAAA;AACF,QACE,UAAA,GAAA,CAAA,MAAM,IAAK,CAAA,SAAA,CAAU,qBAAsB,CAAA;AAAA,UACzC,SAAW,EAAA,CAAA,EAAA,GAAA,IAAA,CAAK,MAAO,CAAA,QAAA,CAAS,cAArB,IAAkC,GAAA,EAAA,GAAAC,8BAAA;AAAA,UAC7C,IAAA,EAAM,KAAK,MAAO,CAAA,IAAA;AAAA,UAClB,IAAA,EAAM,IAAK,CAAA,MAAA,CAAO,QAAS,CAAA,IAAA;AAAA,SAE7B,CAAA,EAAA,IAAA,CAAA;AAAA,OAAA,CAAA,OACK,GAAP,EAAA;AAEA,QAAK,IAAA,CAAA,MAAA,CAAO,KACV,CAA6E,0EAAA,EAAA,GAAA,CAAA,CAAA,CAAA,CAAA,CAAA;AAAA,OAAA;AAAA,KAAA;AAKnF,IAAI,IAAA,WAAA,CAAA;AACJ,IAAI,IAAA,OAAA,CAAA;AACJ,IAAI,IAAA;AACF,MAAA,MAAM,mBAAmB,MAAM,IAAA,CAAK,QAAS,CAAA,OAAA,CAAQ,KAAK,MAAQ,EAAA;AAAA,QAChE,IAAM,EAAA,UAAA;AAAA,QACN,QAAQ,IAAK,CAAA,MAAA;AAAA,OAAA,CAAA,CAAA;AAGf,MAAA,WAAA,GAAc,gBAAiB,CAAA,WAAA,CAAA;AAC/B,MAAA,OAAA,GAAU,gBAAiB,CAAA,IAAA,CAAA;AAAA,KAAA,CAAA,OACpB,GAAP,EAAA;AACA,MAAA,IAAIC,cAAQ,CAAA,GAAA,CAAA,IAAQ,GAAI,CAAA,IAAA,KAAS,kBAAoB,EAAA;AAGnD,QAAA,IAAI,oBAAqB,CAAA,IAAA,CAAK,MAAO,CAAA,QAAA,CAAS,GAAK,CAAA,CAAA,cAAA,EAAA,CAAA;AACnD,QAAA,IAAA,CAAK,MAAO,CAAA,KAAA,CACV,CAAY,SAAA,EAAAF,+BAAA,CACV,IAAK,CAAA,MAAA,CAAA,CAAA,2DAAA,CAAA,CAAA,CAAA;AAGT,QAAO,OAAA,KAAA,CAAA;AAAA,OAAA;AAET,MAAM,MAAA,GAAA,CAAA;AAAA,KAAA;AAGR,IAAA,IAAA,CAAK,MAAO,CAAA,IAAA,CACV,CAAqC,kCAAA,EAAAA,+BAAA,CACnC,KAAK,MACS,CAAA,CAAA,YAAA,EAAA,WAAA,CAAA,CAAA,CAAA,CAAA;AAOlB,IAAA,IAAA,CAAK,MAAO,CAAA,IAAA,CACV,CAA2C,wCAAA,EAAAA,+BAAA,CACzC,IAAK,CAAA,MAAA,CAAA,CAAA,CAAA,CAAA,CAAA;AAIT,IAAM,MAAA,UAAA,GAAa,IAAK,CAAA,MAAA,CAAO,iBAC7B,CAAA,0BAAA,CAAA,CAAA;AAEF,IAAM,MAAA,UAAA,GAAa,cAAcG,sBAAG,CAAA,MAAA,EAAA,CAAA;AAEpC,IAAM,MAAA,kBAAA,GAAqBC,uBAAG,YAAa,CAAA,UAAA,CAAA,CAAA;AAC3C,IAAA,MAAM,YAAY,MAAMA,sBAAA,CAAG,OACzB,CAAAC,wBAAA,CAAK,KAAK,kBAAoB,EAAA,eAAA,CAAA,CAAA,CAAA;AAGhC,IAAA,MAAM,wBAA2B,GAAAC,uCAAA,CAC/B,IAAK,CAAA,MAAA,EACL,IAAK,CAAA,eAAA,CAAA,CAAA;AAEP,IAAM,MAAA,IAAA,CAAK,UAAU,GAAI,CAAA;AAAA,MACvB,QAAU,EAAA,WAAA;AAAA,MACV,SAAA;AAAA,MACA,wBAAA;AAAA,MACA,IAAM,EAAA,OAAA;AAAA,MACN,QAAQ,IAAK,CAAA,MAAA;AAAA,MACb,WAAW,IAAK,CAAA,SAAA;AAAA,KAAA,CAAA,CAAA;AAMlB,IAAI,IAAA,IAAA,CAAK,oBAAoBC,8BAAa,EAAA;AACxC,MAAK,IAAA,CAAA,MAAA,CAAO,MACV,CAA+B,4BAAA,EAAA,WAAA,CAAA,kCAAA,CAAA,CAAA,CAAA;AAEjC,MAAI,IAAA;AAEF,QAAAH,sBAAA,CAAG,MAAO,CAAA,WAAA,CAAA,CAAA;AAAA,OAAA,CAAA,OACH,KAAP,EAAA;AACA,QAAYI,kBAAA,CAAA,KAAA,CAAA,CAAA;AACZ,QAAK,IAAA,CAAA,MAAA,CAAO,KAAM,CAAA,CAAA,kCAAA,EAAqC,KAAM,CAAA,OAAA,CAAA,CAAA,CAAA,CAAA;AAAA,OAAA;AAAA,KAAA;AAQjE,IAAA,IAAA,CAAK,MAAO,CAAA,IAAA,CACV,CAA2C,wCAAA,EAAAR,+BAAA,CACzC,IAAK,CAAA,MAAA,CAAA,CAAA,CAAA,CAAA,CAAA;AAIT,IAAA,MAAM,SAAY,GAAA,MAAM,IAAK,CAAA,SAAA,CAAU,OAAQ,CAAA;AAAA,MAC7C,QAAQ,IAAK,CAAA,MAAA;AAAA,MACb,SAAW,EAAA,SAAA;AAAA,KAAA,CAAA,CAAA;AAIb,IAAA,IAAI,KAAK,KAAS,IAAA,SAAA,KAAwB,CAAA,EAAA,GAAA,SAAA,IAAA,IAAA,GAAA,KAAA,CAAA,GAAA,SAAA,CAAA,OAAA,KAAX,mBAAoB,MAAQ,CAAA,EAAA;AACzD,MAAA,IAAA,CAAK,MAAO,CAAA,KAAA,CACV,CAAgB,aAAA,EAAA,SAAA,CAAU,OAAQ,CAAA,MAAA,CAAA,cAAA,CAAA,CAAA,CAAA;AAEpC,MAAM,MAAA,IAAA,CAAK,KAAM,CAAA,kBAAA,CAAmB,SAAU,CAAA,OAAA,CAAA,CAAA;AAAA,KAAA;AAGhD,IAAI,IAAA;AAEF,MAAAI,sBAAA,CAAG,MAAO,CAAA,SAAA,CAAA,CAAA;AACV,MAAK,IAAA,CAAA,MAAA,CAAO,MACV,CAAgC,6BAAA,EAAA,SAAA,CAAA,kCAAA,CAAA,CAAA,CAAA;AAAA,KAAA,CAAA,OAE3B,KAAP,EAAA;AACA,MAAYI,kBAAA,CAAA,KAAA,CAAA,CAAA;AACZ,MAAK,IAAA,CAAA,MAAA,CAAO,KAAM,CAAA,CAAA,mCAAA,EAAsC,KAAM,CAAA,OAAA,CAAA,CAAA,CAAA,CAAA;AAAA,KAAA;AAIhE,IAAA,IAAI,oBAAqB,CAAA,IAAA,CAAK,MAAO,CAAA,QAAA,CAAS,GAAK,CAAA,CAAA,cAAA,EAAA,CAAA;AAEnD,IAAO,OAAA,IAAA,CAAA;AAAA,GAAA;AAAA;;ACzMmB,MAAA,gBAAA,CAAA;AAAA,EAO5B,WAAY,CAAA;AAAA,IACV,SAAA;AAAA,IACA,MAAA;AAAA,IACA,MAAA;AAAA,IACA,eAAA;AAAA,IACA,KAAA;AAAA,GAOC,EAAA;AACD,IAAA,IAAA,CAAK,MAAS,GAAA,MAAA,CAAA;AACd,IAAA,IAAA,CAAK,MAAS,GAAA,MAAA,CAAA;AACd,IAAA,IAAA,CAAK,SAAY,GAAA,SAAA,CAAA;AACjB,IAAA,IAAA,CAAK,eAAkB,GAAA,eAAA,CAAA;AACvB,IAAA,IAAA,CAAK,KAAQ,GAAA,KAAA,CAAA;AAAA,GAAA;AAAA,EAAA,MAGT,MAAO,CAAA;AAAA,IACX,eAAA,EAAiB,EAAE,GAAA,EAAK,KAAO,EAAA,MAAA,EAAA;AAAA,IAC/B,MAAA;AAAA,IACA,SAAA;AAAA,IACA,UAAA;AAAA,GAMC,EAAA;AAED,IAAM,MAAA,UAAA,GAAaC,mBAAQ,YAAa,CAAA;AAAA,MACtC,KAAA,EAAO,OAAQ,CAAA,GAAA,CAAI,SAAa,IAAA,MAAA;AAAA,MAChC,MAAA,EAAQA,kBAAQ,CAAA,MAAA,CAAO,OACrB,CAAAA,kBAAA,CAAQ,MAAO,CAAA,QAAA,EAAA,EACfA,kBAAQ,CAAA,MAAA,CAAO,SACf,EAAA,EAAAA,kBAAA,CAAQ,MAAO,CAAA,MAAA,EAAA,CAAA;AAAA,MAEjB,WAAa,EAAA,EAAA;AAAA,KAAA,CAAA,CAAA;AAIf,IAAA,MAAM,YAAY,IAAIC,kBAAA,EAAA,CAAA;AACtB,IAAU,SAAA,CAAA,EAAA,CAAG,MAAQ,EAAA,OAAM,IAAQ,KAAA;AACjC,MAAA,GAAA,CAAI,KAAK,QAAW,EAAA,CAAA,IAAA,EAAA,CAAA,CAAA;AAAA,KAAA,CAAA,CAAA;AAGtB,IAAA,UAAA,CAAW,IAAI,IAAID,kBAAA,CAAQ,UAAW,CAAA,MAAA,CAAO,EAAE,MAAQ,EAAA,SAAA,EAAA,CAAA,CAAA,CAAA;AAGvD,IAAA,IAAI,CAAC,oBAAA,CAAqB,MAAO,CAAA,QAAA,CAAS,GAAO,CAAA,EAAA;AAC/C,MAAA,MAAA,CAAO,EAAE,OAAS,EAAA,KAAA,EAAA,CAAA,CAAA;AAClB,MAAA,OAAA;AAAA,KAAA;AAGF,IAAA,IAAI,SAAY,GAAA,KAAA,CAAA;AAEhB,IAAI,IAAA;AACF,MAAM,MAAA,WAAA,GAAc,IAAI,WAAY,CAAA;AAAA,QAClC,SAAA;AAAA,QACA,UAAA;AAAA,QACA,WAAW,IAAK,CAAA,SAAA;AAAA,QAChB,MAAQ,EAAA,UAAA;AAAA,QACR,MAAA;AAAA,QACA,QAAQ,IAAK,CAAA,MAAA;AAAA,QACb,iBAAiB,IAAK,CAAA,eAAA;AAAA,QACtB,SAAA;AAAA,QACA,OAAO,IAAK,CAAA,KAAA;AAAA,OAAA,CAAA,CAAA;AAGd,MAAM,MAAA,OAAA,GAAU,MAAM,WAAY,CAAA,KAAA,EAAA,CAAA;AAElC,MAAA,IAAI,CAAC,OAAS,EAAA;AACZ,QAAA,MAAA,CAAO,EAAE,OAAS,EAAA,KAAA,EAAA,CAAA,CAAA;AAClB,QAAA,OAAA;AAAA,OAAA;AAAA,KAAA,CAAA,OAEK,CAAP,EAAA;AACA,MAAYD,kBAAA,CAAA,CAAA,CAAA,CAAA;AACZ,MAAM,MAAA,GAAA,GAAM,kCAAkC,CAAE,CAAA,OAAA,CAAA,CAAA,CAAA;AAChD,MAAA,UAAA,CAAW,KAAM,CAAA,GAAA,CAAA,CAAA;AACjB,MAAK,IAAA,CAAA,MAAA,CAAO,MAAM,GAAK,EAAA,CAAA,CAAA,CAAA;AACvB,MAAM,KAAA,CAAA,CAAA,CAAA,CAAA;AACN,MAAA,OAAA;AAAA,KAAA;AAMF,IAAA,KAAA,IAAS,OAAU,GAAA,CAAA,EAAG,OAAU,GAAA,CAAA,EAAG,OAAW,EAAA,EAAA;AAC5C,MAAA,IAAI,MAAM,IAAA,CAAK,SAAU,CAAA,oBAAA,CAAqB,MAAS,CAAA,EAAA;AACrD,QAAY,SAAA,GAAA,IAAA,CAAA;AACZ,QAAA,MAAA;AAAA,OAAA;AAEF,MAAA,MAAM,IAAI,OAAA,CAAQ,CAAK,CAAA,KAAA,UAAA,CAAW,CAAG,EAAA,GAAA,CAAA,CAAA,CAAA;AAAA,KAAA;AAEvC,IAAA,IAAI,CAAC,SAAW,EAAA;AACd,MAAA,IAAA,CAAK,OAAO,KACV,CAAA,gFAAA,CAAA,CAAA;AAEF,MAAA,KAAA,CACE,IAAIG,oBACF,CAAA,yFAAA,CAAA,CAAA,CAAA;AAGJ,MAAA,OAAA;AAAA,KAAA;AAGF,IAAA,MAAA,CAAO,EAAE,OAAS,EAAA,IAAA,EAAA,CAAA,CAAA;AAAA,GAAA;AAAA,EAAA,MAGd,WAAY,CAAA;AAAA,IAChB,iBAAiB,EAAE,MAAA,EAAA;AAAA,IACnB,SAAA;AAAA,IACA,KAAA;AAAA,IACA,MAAA;AAAA,GAMC,EAAA;AA1KL,IAAA,IAAA,EAAA,CAAA;AA4KI,IAAA,IAAI,CAAC,oBAAqB,CAAA,MAAA,CAAO,SAAS,GAAS,CAAA,IAAA,CAAC,KAAK,KAAO,EAAA;AAC9D,MAAA,MAAA,CAAO,EAAE,OAAS,EAAA,KAAA,EAAA,CAAA,CAAA;AAClB,MAAA,OAAA;AAAA,KAAA;AAIF,IAAM,MAAA,OAAA,GAAU,MAAM,SAAA,CAAU,UAAW,CAAA,UAAA,CAAA,CAAA;AAC3C,IAAA,MAAM,SAAY,GAAA,CAAA,CAAA,EAAA,GAAA,MAAA,CAAO,QAAP,KAAA,IAAA,GAAA,KAAA,CAAA,GAAA,EAAA,CAAiB,SAAa,KAAAV,8BAAA,CAAA;AAChD,IAAA,MAAM,OAAO,MAAO,CAAA,IAAA,CAAA;AACpB,IAAM,MAAA,IAAA,GAAO,OAAO,QAAS,CAAA,IAAA,CAAA;AAC7B,IAAA,MAAM,gBACJ,GAAA,IAAA,CAAK,MAAO,CAAA,kBAAA,CACV,6CACG,CAAA,IAAA,KAAA,CAAA;AACP,IAAM,MAAA,WAAA,GAAc,CAAG,EAAA,SAAA,CAAA,CAAA,EAAa,IAAQ,CAAA,CAAA,EAAA,IAAA,CAAA,CAAA,CAAA;AAC5C,IAAA,MAAM,iBAAoB,GAAA,CAAA,EACxB,gBAAmB,GAAA,WAAA,GAAc,YAAY,iBAAkB,CAAA,OAAA,CAAA,CAAA,CAAA,CAAA;AAEjE,IAAI,IAAA;AACF,MAAA,MAAM,CAAC,cAAA,EAAgB,cAAkB,CAAA,GAAA,MAAM,QAAQ,GAAI,CAAA;AAAA,QACzD,IAAK,CAAA,SAAA,CAAU,qBAAsB,CAAA,EAAE,WAAW,IAAM,EAAA,IAAA,EAAA,CAAA;AAAA,QACxDW,yBAAA,CACE,CAAG,EAAA,OAAA,CAAA,aAAA,EAAuB,iBAC1B,CAAA,uBAAA,CAAA,EAAA;AAAA,UACE,OAAS,EAAA,KAAA,GAAQ,EAAE,aAAA,EAAe,UAAU,KAAY,CAAA,CAAA,EAAA,GAAA,EAAA;AAAA,SAAA,CAAA,CAE1D,IACA,CAAA,CAAA,CAAA,KACE,CAAE,CAAA,IAAA,EAAA,CAAO,MAAM,MAAM,KAAA,CAAA,CAAA,CAAA;AAAA,OAAA,CAAA,CAAA;AAO3B,MAAI,IAAA,cAAA,CAAe,eAAoB,KAAA,cAAA,CAAe,eAAiB,EAAA;AACrE,QAAA,MAAM,KAAQ,GAAA;AAAA,UACZ,uBAAO,GAAI,CAAA;AAAA,YACT,GAAI,eAAe,KAAS,IAAA,EAAA;AAAA,YAC5B,GAAI,eAAe,KAAS,IAAA,EAAA;AAAA,WAAA,CAAA;AAAA,SAE9B,CAAA,GAAA,CAAI,CAAK,CAAA,KAAA,CAAA,EAAG,iBAAqB,CAAA,CAAA,EAAA,CAAA,CAAA,CAAA,CAAA,CAAA;AACnC,QAAM,MAAA,IAAA,CAAK,MAAM,kBAAmB,CAAA,KAAA,CAAA,CAAA;AACpC,QAAA,MAAA,CAAO,EAAE,OAAS,EAAA,IAAA,EAAA,CAAA,CAAA;AAAA,OACb,MAAA;AACL,QAAA,MAAA,CAAO,EAAE,OAAS,EAAA,KAAA,EAAA,CAAA,CAAA;AAAA,OAAA;AAAA,KAAA,CAAA,OAEb,CAAP,EAAA;AACA,MAAYJ,kBAAA,CAAA,CAAA,CAAA,CAAA;AAEZ,MAAA,IAAA,CAAK,MAAO,CAAA,KAAA,CACV,CAA2B,wBAAA,EAAA,iBAAA,CAAA,EAAA,EAAsB,CAAE,CAAA,OAAA,CAAA,CAAA,CAAA,CAAA;AAErD,MAAA,MAAA,CAAO,EAAE,OAAS,EAAA,KAAA,EAAA,CAAA,CAAA;AAAA,KAClB,SAAA;AAEA,MAAI,IAAA,oBAAA,CAAqB,MAAO,CAAA,QAAA,CAAS,GAAM,CAAA,CAAA,cAAA,EAAA,CAAA;AAAA,KAAA;AAAA,GAAA;AAAA;;ACzM9C,MAAM,wBAAwB,CAAC;AAAA,EACpC,KAAA;AAAA,CACoC,KAAA;AACpC,EAAA,MAAM,eAAkB,GAAAK,0BAAA,EAAA,CAAA;AAKxB,EAAA,eAAA,CAAgB,GAAI,CAAA,OAAO,GAAK,EAAA,GAAA,EAAK,IAAS,KAAA;AAC5C,IAAA,MAAM,SAAS,GAAI,CAAA,MAAA,CAAA;AACnB,IAAM,MAAA,WAAA,GAAc,GAAI,CAAA,IAAA,CAAK,UAAW,CAAA,eAAA,CAAA,CAAA;AAGxC,IAAI,IAAA,CAAC,WAAe,IAAA,CAAC,MAAQ,EAAA;AAC3B,MAAA,IAAA,EAAA,CAAA;AACA,MAAA,OAAA;AAAA,KAAA;AAIF,IAAA,MAAM,OAAU,GAAA,SAAA,CAAU,GAAI,CAAA,IAAA,CAAK,MAAM,uBAA0B,CAAA,CAAA,CAAA,CAAA,CAAA,CAAA;AACnE,IAAM,MAAA,OAAA,GAAU,MAAO,CAAA,GAAA,CAAI,IAAK,CAAA,MAAA,CAAA,CAAA;AAChC,IAAM,MAAA,SAAA,GAAY,MAAO,CAAA,KAAA,CAAM,IAAK,CAAA,MAAA,CAAA,CAAA;AACpC,IAAA,IAAI,YAAe,GAAA,IAAA,CAAA;AACnB,IAAA,MAAM,MAAmB,GAAA,EAAA,CAAA;AAIzB,IAAA,MAAA,CAAO,KAAQ,GAAA,CACb,IACA,EAAA,QAAA,EACA,QACG,KAAA;AACH,MAAO,MAAA,CAAA,IAAA,CAAK,OAAO,IAAK,CAAA,IAAA,CAAA,CAAA,CAAA;AACxB,MAAI,IAAA,OAAO,aAAa,UAAY,EAAA;AAClC,QAAA,OAAO,UAAU,IAAM,EAAA,QAAA,CAAA,CAAA;AAAA,OAAA;AAEzB,MAAO,OAAA,SAAA,CAAU,MAAM,QAAU,EAAA,QAAA,CAAA,CAAA;AAAA,KAAA,CAAA;AAKnC,IAAO,MAAA,CAAA,EAAA,CAAG,OAAS,EAAA,OAAM,QAAY,KAAA;AACnC,MAAM,MAAA,OAAA,GAAU,OAAO,MAAO,CAAA,MAAA,CAAA,CAAA;AAC9B,MAAA,MAAM,IAAO,GAAA,OAAA,CAAQ,QAAS,CAAA,MAAA,EAAQ,CAAG,EAAA,EAAA,CAAA,CAAA;AACzC,MAAA,IAAI,YAAgB,IAAA,CAAC,QAAY,IAAA,IAAA,CAAK,MAAM,kBAAqB,CAAA,EAAA;AAC/D,QAAM,MAAA,KAAA,CAAM,IAAI,OAAS,EAAA,OAAA,CAAA,CAAA;AAAA,OAAA;AAAA,KAAA,CAAA,CAAA;AAK7B,IAAM,MAAA,MAAA,GAAS,MAAM,KAAA,CAAM,GAAI,CAAA,OAAA,CAAA,CAAA;AAK/B,IAAA,IAAI,MAAQ,EAAA;AACV,MAAe,YAAA,GAAA,KAAA,CAAA;AACf,MAAQ,OAAA,CAAA,MAAA,CAAA,CAAA;AACR,MAAA,OAAA;AAAA,KAAA;AAIF,IAAA,IAAA,EAAA,CAAA;AAAA,GAAA,CAAA,CAAA;AAGF,EAAO,OAAA,eAAA,CAAA;AAAA,CAAA;;ACxEF,MAAA,sBAAA,SAAqCC,sBAAgB,CAAA;AAAA,CAAA;AAEjC,MAAA,aAAA,CAAA;AAAA,EAKjB,WAAY,CAAA;AAAA,IAClB,KAAA;AAAA,IACA,MAAA;AAAA,IACA,WAAA;AAAA,GAKC,EAAA;AACD,IAAA,IAAA,CAAK,KAAQ,GAAA,KAAA,CAAA;AACb,IAAA,IAAA,CAAK,MAAS,GAAA,MAAA,CAAA;AACd,IAAA,IAAA,CAAK,WAAc,GAAA,WAAA,CAAA;AAAA,GAAA;AAAA,EAAA,OAGd,UACL,CAAA,MAAA,EACA,EAAE,KAAA,EAAO,MACT,EAAA,EAAA;AACA,IAAM,MAAA,OAAA,GAAU,OAAO,iBAAkB,CAAA,4BAAA,CAAA,CAAA;AACzC,IAAM,MAAA,WAAA,GAAc,OAAY,KAAA,KAAA,CAAA,GAAY,GAAO,GAAA,OAAA,CAAA;AACnD,IAAA,OAAO,IAAI,aAAA,CAAc,EAAE,KAAA,EAAO,MAAQ,EAAA,WAAA,EAAA,CAAA,CAAA;AAAA,GAAA;AAAA,EAAA,MAGtC,IAAI,IAA2C,EAAA;AACnD,IAAI,IAAA;AAGF,MAAM,MAAA,QAAA,GAAY,MAAM,OAAA,CAAQ,IAAK,CAAA;AAAA,QACnC,IAAA,CAAK,MAAM,GAAI,CAAA,IAAA,CAAA;AAAA,QACf,IAAI,OAAA,CAAQ,CAAe,WAAA,KAAA,UAAA,CAAW,aAAa,IAAK,CAAA,WAAA,CAAA,CAAA;AAAA,OAAA,CAAA,CAAA;AAG1D,MAAA,IAAI,aAAa,KAAW,CAAA,EAAA;AAC1B,QAAK,IAAA,CAAA,MAAA,CAAO,MAAM,CAAc,WAAA,EAAA,IAAA,CAAA,CAAA,CAAA,CAAA;AAChC,QAAO,OAAA,MAAA,CAAO,KAAK,QAAU,EAAA,QAAA,CAAA,CAAA;AAAA,OAAA;AAG/B,MAAK,IAAA,CAAA,MAAA,CAAO,MAAM,CAAe,YAAA,EAAA,IAAA,CAAA,CAAA,CAAA,CAAA;AACjC,MAAO,OAAA,QAAA,CAAA;AAAA,KAAA,CAAA,OACA,CAAP,EAAA;AACA,MAAYN,kBAAA,CAAA,CAAA,CAAA,CAAA;AACZ,MAAA,IAAA,CAAK,MAAO,CAAA,IAAA,CAAK,CAA6B,0BAAA,EAAA,IAAA,CAAA,EAAA,EAAS,CAAE,CAAA,OAAA,CAAA,CAAA,CAAA,CAAA;AACzD,MAAK,IAAA,CAAA,MAAA,CAAO,MAAM,CAAE,CAAA,KAAA,CAAA,CAAA;AACpB,MAAO,OAAA,KAAA,CAAA,CAAA;AAAA,KAAA;AAAA,GAAA;AAAA,EAIL,MAAA,GAAA,CAAI,MAAc,IAA6B,EAAA;AACnD,IAAK,IAAA,CAAA,MAAA,CAAO,MAAM,CAA2B,wBAAA,EAAA,IAAA,CAAA,CAAA,CAAA,CAAA;AAC7C,IAAK,IAAA,CAAA,KAAA,CACF,GAAI,CAAA,IAAA,EAAM,IAAK,CAAA,QAAA,CAAS,QACxB,CAAA,CAAA,CAAA,KAAA,CAAM,CAAK,CAAA,KAAA,IAAA,CAAK,MAAO,CAAA,KAAA,CAAM,aAAe,EAAA,CAAA,CAAA,CAAA,CAAA;AAAA,GAAA;AAAA,EAAA,MAG3C,WAAW,IAA6B,EAAA;AAC5C,IAAO,OAAA,IAAA,CAAK,MAAM,MAAO,CAAA,IAAA,CAAA,CAAA;AAAA,GAAA;AAAA,EAAA,MAGrB,mBACJ,KACuC,EAAA;AACvC,IAAM,MAAA,OAAA,GAAU,MAAM,OAAQ,CAAA,UAAA,CAC5B,MAAM,GAAI,CAAA,CAAA,IAAA,KAAQ,IAAK,CAAA,KAAA,CAAM,MAAO,CAAA,IAAA,CAAA,CAAA,CAAA,CAAA;AAEtC,IAAA,MAAM,QAAW,GAAA,OAAA,CAAQ,MACvB,CAAA,CAAA,CAAA,KAAK,EAAE,MAAW,KAAA,UAAA,CAAA,CAAA;AAGpB,IAAA,IAAI,SAAS,MAAQ,EAAA;AACnB,MAAM,MAAA,IAAI,uBACR,mCACA,EAAA,QAAA,CAAA,CAAA;AAAA,KAAA;AAIJ,IAAO,OAAA,OAAA,CAAA;AAAA,GAAA;AAAA;;AC1EqB,MAAA,kBAAA,CAAA;AAAA,EAK9B,WAAA,CAAY,EAAE,OAAA,EAAS,KAAoC,EAAA,EAAA;AAF1C,IAAc,IAAA,CAAA,WAAA,GAAA,GAAA,CAAA;AAG7B,IAAA,IAAA,CAAK,OAAU,GAAA,OAAA,CAAA;AACf,IAAA,IAAA,CAAK,KAAQ,GAAA,KAAA,CAAA;AAAA,GAAA;AAAA,EAGT,MAAA,IAAA,CACJ,WACA,KAC6B,EAAA;AAC7B,IAAM,MAAA,QAAA,GAAW,IAAK,CAAA,WAAA,CAAY,SAAW,EAAA,KAAA,CAAA,CAAA;AAC7C,IAAI,IAAA,MAAA,GAAS,MAAM,IAAA,CAAK,YAAa,CAAA,QAAA,CAAA,CAAA;AAErC,IAAA,IAAI,MAAQ,EAAA;AACV,MAAO,OAAA,MAAA,CAAA;AAAA,KAAA;AAGT,IAAA,MAAA,GAAS,MAAM,IAAA,CAAK,OAAQ,CAAA,cAAA,CAAe,WAAW,EAAE,KAAA,EAAA,CAAA,CAAA;AAExD,IAAA,IAAI,MAAQ,EAAA;AACV,MAAA,IAAA,CAAK,KAAM,CAAA,GAAA,CAAI,QAAU,EAAA,MAAA,EAAQ,EAAE,GAAK,EAAA,GAAA,EAAA,CAAA,CAAA;AAAA,KAAA;AAG1C,IAAO,OAAA,MAAA,CAAA;AAAA,GAAA;AAAA,EAAA,MAGK,aAAa,GAA0C,EAAA;AAGnE,IAAQ,OAAA,MAAM,QAAQ,IAAK,CAAA;AAAA,MACzB,IAAA,CAAK,MAAM,GAAI,CAAA,GAAA,CAAA;AAAA,MACf,IAAI,OAAA,CAAQ,CAAe,WAAA,KAAA,UAAA,CAAW,aAAa,IAAK,CAAA,WAAA,CAAA,CAAA;AAAA,KAAA,CAAA,CAAA;AAAA,GAAA;AAAA,EAIpD,WAAA,CACN,YACA,KACQ,EAAA;AACR,IAAM,MAAA,GAAA,GAAM,CAAC,SAAA,EAAWR,+BAAmB,CAAA,UAAA,CAAA,CAAA,CAAA;AAE3C,IAAA,IAAI,KAAO,EAAA;AACT,MAAA,GAAA,CAAI,IAAK,CAAA,KAAA,CAAA,CAAA;AAAA,KAAA;AAGX,IAAA,OAAO,IAAI,IAAK,CAAA,GAAA,CAAA,CAAA;AAAA,GAAA;AAAA;;ACzCkB,MAAA,wBAAA,CAAA;AAAA,EAG5B,YAAY,MAAgB,EAAA;AAClC,IAAA,IAAA,CAAK,MAAS,GAAA,MAAA,CAAA;AAAA,GAAA;AAAA,EAAA,OAGT,WAAW,MAA0C,EAAA;AAC1D,IAAA,OAAO,IAAI,wBAAyB,CAAA,MAAA,CAAA,CAAA;AAAA,GAAA;AAAA,EAAA,MAGhC,YAAY,CAA4C,EAAA;AAC5D,IAAO,OAAA,IAAA,CAAK,MAAO,CAAA,SAAA,CAAU,kBAAwB,CAAA,KAAA,OAAA,CAAA;AAAA,GAAA;AAAA;;AC0CzD,SAAA,mBAAA,CACE,GACqC,EAAA;AACrC,EAAA,OAAQ,IAAqC,SAAc,KAAA,KAAA,CAAA,CAAA;AAAA,CAAA;AAQ7D,eAAA,YAAA,CACE,OACyB,EAAA;AAvG3B,EAAA,IAAA,EAAA,CAAA;AAwGE,EAAA,MAAM,MAAS,GAAAe,0BAAA,EAAA,CAAA;AACf,EAAA,MAAM,EAAE,SAAA,EAAW,MAAQ,EAAA,MAAA,EAAQ,SAAc,EAAA,GAAA,OAAA,CAAA;AACjD,EAAA,MAAMC,eAAgB,GAAA,IAAIC,2BAAc,CAAA,EAAE,YAAc,EAAA,SAAA,EAAA,CAAA,CAAA;AACxD,EAAA,MAAM,iBACJ,GAAA,CAAA,EAAA,GAAA,OAAA,CAAQ,iBAAR,KAAA,IAAA,GAAA,EAAA,GAA6B,yBAAyB,UAAW,CAAA,MAAA,CAAA,CAAA;AAInE,EAAM,MAAA,YAAA,GAAe,IAAI,kBAAmB,CAAA;AAAA,IAC1C,OAAS,EAAAD,eAAA;AAAA,IACT,KAAA,EAAO,QAAQ,KAAM,CAAA,SAAA,EAAA;AAAA,GAAA,CAAA,CAAA;AAIvB,EAAI,IAAA,KAAA,CAAA;AACJ,EAAM,MAAA,UAAA,GAAa,OAAO,iBAAkB,CAAA,oBAAA,CAAA,CAAA;AAC5C,EAAA,IAAI,UAAY,EAAA;AACd,IAAA,MAAM,WAAc,GAAA,OAAA,CAAQ,KAAM,CAAA,SAAA,CAAU,EAAE,UAAA,EAAA,CAAA,CAAA;AAC9C,IAAA,KAAA,GAAQ,aAAc,CAAA,UAAA,CAAW,MAAQ,EAAA,EAAE,OAAO,WAAa,EAAA,MAAA,EAAA,CAAA,CAAA;AAAA,GAAA;AAGjE,EAAM,MAAA,eAAA,GAAkBE,4BAAgB,UAAW,CAAA,MAAA,CAAA,CAAA;AACnD,EAAM,MAAA,gBAAA,GAAmB,IAAI,gBAAiB,CAAA;AAAA,IAC5C,SAAA;AAAA,IACA,MAAA;AAAA,IACA,MAAA;AAAA,IACA,eAAA;AAAA,IACA,KAAA;AAAA,GAAA,CAAA,CAAA;AAGF,EAAA,MAAA,CAAO,GAAI,CAAA,2CAAA,EAA6C,OAAO,GAAA,EAAK,GAAQ,KAAA;AAC1E,IAAA,MAAM,EAAE,IAAA,EAAM,SAAW,EAAA,IAAA,EAAA,GAAS,GAAI,CAAA,MAAA,CAAA;AACtC,IAAM,MAAA,UAAA,GAAa,EAAE,IAAA,EAAM,SAAW,EAAA,IAAA,EAAA,CAAA;AACtC,IAAM,MAAA,KAAA,GAAQ,cAAe,CAAA,GAAA,CAAI,OAAQ,CAAA,aAAA,CAAA,CAAA;AAGzC,IAAA,MAAM,MAAS,GAAA,MAAM,YAAa,CAAA,IAAA,CAAK,UAAY,EAAA,KAAA,CAAA,CAAA;AAEnD,IAAA,IAAI,CAAC,MAAQ,EAAA;AACX,MAAM,MAAA,IAAIP,oBACR,CAAA,CAAA,4BAAA,EAA+BX,+BAAmB,CAAA,UAAA,CAAA,CAAA,CAAA,CAAA,CAAA,CAAA;AAAA,KAAA;AAItD,IAAI,IAAA;AACF,MAAM,MAAA,gBAAA,GAAmB,MAAM,SAAA,CAAU,qBACvC,CAAA,UAAA,CAAA,CAAA;AAGF,MAAA,GAAA,CAAI,IAAK,CAAA,gBAAA,CAAA,CAAA;AAAA,KAAA,CAAA,OACF,GAAP,EAAA;AACA,MAAO,MAAA,CAAA,IAAA,CACL,CAA+B,4BAAA,EAAAA,+BAAA,CAC7B,UACe,CAAA,CAAA,aAAA,EAAA,GAAA,CAAA,CAAA,CAAA,CAAA;AAEnB,MAAA,MAAM,IAAIW,oBAAA,CACR,CAA+B,4BAAA,EAAAX,+BAAA,CAAmB,UAClD,CAAA,CAAA,CAAA,CAAA,EAAA,GAAA,CAAA,CAAA;AAAA,KAAA;AAAA,GAAA,CAAA,CAAA;AAKN,EAAA,MAAA,CAAO,GAAI,CAAA,yCAAA,EAA2C,OAAO,GAAA,EAAK,GAAQ,KAAA;AACxE,IAAA,MAAM,EAAE,IAAA,EAAM,SAAW,EAAA,IAAA,EAAA,GAAS,GAAI,CAAA,MAAA,CAAA;AACtC,IAAM,MAAA,UAAA,GAAa,EAAE,IAAA,EAAM,SAAW,EAAA,IAAA,EAAA,CAAA;AACtC,IAAM,MAAA,KAAA,GAAQ,cAAe,CAAA,GAAA,CAAI,OAAQ,CAAA,aAAA,CAAA,CAAA;AAEzC,IAAA,MAAM,MAAS,GAAA,MAAM,YAAa,CAAA,IAAA,CAAK,UAAY,EAAA,KAAA,CAAA,CAAA;AAEnD,IAAA,IAAI,CAAC,MAAQ,EAAA;AACX,MAAM,MAAA,IAAIW,oBACR,CAAA,CAAA,4BAAA,EAA+BX,+BAAmB,CAAA,UAAA,CAAA,CAAA,CAAA,CAAA,CAAA,CAAA;AAAA,KAAA;AAItD,IAAI,IAAA;AACF,MAAM,MAAA,gBAAA,GAAmBM,wCAAqB,MAAQ,EAAA,eAAA,CAAA,CAAA;AACtD,MAAI,GAAA,CAAA,IAAA,CAAK,KAAK,MAAQ,EAAA,gBAAA,EAAA,CAAA,CAAA;AAAA,KAAA,CAAA,OACf,GAAP,EAAA;AACA,MAAO,MAAA,CAAA,IAAA,CACL,CAA+B,4BAAA,EAAAN,+BAAA,CAC7B,UACe,CAAA,CAAA,aAAA,EAAA,GAAA,CAAA,CAAA,CAAA,CAAA;AAEnB,MAAA,MAAM,IAAIW,oBAAA,CACR,CAA+B,4BAAA,EAAAX,+BAAA,CAAmB,UAClD,CAAA,CAAA,CAAA,CAAA,EAAA,GAAA,CAAA,CAAA;AAAA,KAAA;AAAA,GAAA,CAAA,CAAA;AASN,EAAA,MAAA,CAAO,GAAI,CAAA,8BAAA,EAAgC,OAAO,GAAA,EAAK,GAAQ,KAAA;AAxMjE,IAAA,IAAA,GAAA,CAAA;AAyMI,IAAA,MAAM,EAAE,IAAA,EAAM,SAAW,EAAA,IAAA,EAAA,GAAS,GAAI,CAAA,MAAA,CAAA;AACtC,IAAM,MAAA,KAAA,GAAQ,cAAe,CAAA,GAAA,CAAI,OAAQ,CAAA,aAAA,CAAA,CAAA;AAEzC,IAAA,MAAM,SAAS,MAAM,YAAA,CAAa,KAAK,EAAE,IAAA,EAAM,WAAW,IAAQ,EAAA,EAAA,KAAA,CAAA,CAAA;AAElE,IAAA,IAAI,EAAC,CAAA,GAAA,GAAA,MAAA,IAAA,IAAA,GAAA,KAAA,CAAA,GAAA,MAAA,CAAQ,QAAR,KAAA,IAAA,GAAA,KAAA,CAAA,GAAA,GAAA,CAAkB,GAAK,CAAA,EAAA;AAC1B,MAAA,MAAM,IAAIW,oBAAc,CAAA,6BAAA,CAAA,CAAA;AAAA,KAAA;AAG1B,IAAA,MAAM,kBAA4C,iBAAkB,CAAA,GAAA,CAAA,CAAA;AAOpE,IAAA,MAAM,WAAc,GAAA,MAAM,iBAAkB,CAAA,WAAA,CAAY,EAAE,MAAA,EAAA,CAAA,CAAA;AAC1D,IAAA,IAAI,CAAC,WAAa,EAAA;AAGhB,MAAA,IAAI,KAAO,EAAA;AACT,QAAA,MAAM,iBAAiB,WAAY,CAAA;AAAA,UACjC,eAAA;AAAA,UACA,SAAA;AAAA,UACA,KAAA;AAAA,UACA,MAAA;AAAA,SAAA,CAAA,CAAA;AAEF,QAAA,OAAA;AAAA,OAAA;AAEF,MAAgB,eAAA,CAAA,MAAA,CAAO,EAAE,OAAS,EAAA,KAAA,EAAA,CAAA,CAAA;AAClC,MAAA,OAAA;AAAA,KAAA;AAIF,IAAA,IAAI,oBAAoB,OAAU,CAAA,EAAA;AAChC,MAAM,MAAA,EAAE,WAAW,UAAe,EAAA,GAAA,OAAA,CAAA;AAElC,MAAA,MAAM,iBAAiB,MAAO,CAAA;AAAA,QAC5B,eAAA;AAAA,QACA,MAAA;AAAA,QACA,SAAA;AAAA,QACA,UAAA;AAAA,OAAA,CAAA,CAAA;AAEF,MAAA,OAAA;AAAA,KAAA;AAGF,IAAgB,eAAA,CAAA,KAAA,CACd,IAAI,KACF,CAAA,oIAAA,CAAA,CAAA,CAAA;AAAA,GAAA,CAAA,CAAA;AAMN,EAAI,IAAA,MAAA,CAAO,mBAAmB,oBAAuB,CAAA,EAAA;AACnD,IAAA,MAAA,CAAO,GACL,CAAA,qCAAA,EACA,OAAO,GAAA,EAAK,MAAM,IAAS,KAAA;AACzB,MAAA,MAAM,EAAE,IAAA,EAAM,SAAW,EAAA,IAAA,EAAA,GAAS,GAAI,CAAA,MAAA,CAAA;AACtC,MAAM,MAAA,UAAA,GAAa,EAAE,IAAA,EAAM,SAAW,EAAA,IAAA,EAAA,CAAA;AACtC,MAAM,MAAA,KAAA,GAAQ,cAAe,CAAA,GAAA,CAAI,OAAQ,CAAA,aAAA,CAAA,CAAA;AAEzC,MAAA,MAAM,MAAS,GAAA,MAAM,YAAa,CAAA,IAAA,CAAK,UAAY,EAAA,KAAA,CAAA,CAAA;AAEnD,MAAA,IAAI,CAAC,MAAQ,EAAA;AACX,QAAM,MAAA,IAAIA,oBACR,CAAA,CAAA,qBAAA,EAAwBX,+BAAmB,CAAA,UAAA,CAAA,CAAA,CAAA,CAAA,CAAA;AAAA,OAAA;AAI/C,MAAA,IAAA,EAAA,CAAA;AAAA,KAAA,CAAA,CAAA;AAAA,GAAA;AAMN,EAAA,IAAI,KAAO,EAAA;AACT,IAAO,MAAA,CAAA,GAAA,CAAI,qBAAsB,CAAA,EAAE,MAAQ,EAAA,KAAA,EAAA,CAAA,CAAA,CAAA;AAAA,GAAA;AAI7C,EAAO,MAAA,CAAA,GAAA,CAAI,gBAAgB,SAAU,CAAA,UAAA,EAAA,CAAA,CAAA;AAErC,EAAO,OAAA,MAAA,CAAA;AAAA,CAAA;AAGT,SAAA,cAAA,CAAwB,MAAqC,EAAA;AA/R7D,EAAA,IAAA,EAAA,CAAA;AAgSE,EAAO,OAAA,CAAA,EAAA,GAAA,MAAA,IAAA,IAAA,GAAA,KAAA,CAAA,GAAA,MAAA,CAAQ,KAAM,CAAA,qBAAA,CAAA,KAAd,IAAuC,GAAA,KAAA,CAAA,GAAA,EAAA,CAAA,CAAA,CAAA,CAAA;AAAA,CAAA;AAUzC,SAAA,iBAAA,CACL,GAC0B,EAAA;AA5S5B,EAAA,IAAA,EAAA,CAAA;AA8SE,EAAA,GAAA,CAAI,UAAU,GAAK,EAAA;AAAA,IACjB,UAAY,EAAA,YAAA;AAAA,IACZ,eAAiB,EAAA,UAAA;AAAA,IACjB,cAAgB,EAAA,mBAAA;AAAA,GAAA,CAAA,CAAA;AAIlB,EAAA,CAAA,EAAA,GAAA,GAAA,CAAI,MAAJ,KAAA,IAAA,GAAA,KAAA,CAAA,GAAA,EAAA,CAAY,EAAG,CAAA,OAAA,EAAS,MAAM;AAC5B,IAAI,GAAA,CAAA,GAAA,EAAA,CAAA;AAAA,GAAA,CAAA,CAAA;AAIN,EAAM,MAAA,IAAA,GAAO,CAAC,IAAA,EAAkC,IAAc,KAAA;AAC5D,IAAA,GAAA,CAAI,MAAM,CAAU,OAAA,EAAA,IAAA,CAAA;AAAA,MAAA,EAAe,KAAK,SAAU,CAAA,IAAA,CAAA,CAAA;AAAA;AAAA,CAAA,CAAA,CAAA;AAGlD,IAAA,IAAI,IAAI,KAAO,EAAA;AACb,MAAI,GAAA,CAAA,KAAA,EAAA,CAAA;AAAA,KAAA;AAAA,GAAA,CAAA;AAIR,EAAO,OAAA;AAAA,IACL,KAAK,CAAQ,IAAA,KAAA;AACX,MAAA,IAAA,CAAK,KAAO,EAAA,IAAA,CAAA,CAAA;AAAA,KAAA;AAAA,IAGd,OAAO,CAAK,CAAA,KAAA;AACV,MAAA,IAAA,CAAK,SAAS,CAAE,CAAA,OAAA,CAAA,CAAA;AAChB,MAAI,GAAA,CAAA,GAAA,EAAA,CAAA;AAAA,KAAA;AAAA,IAGN,QAAQ,CAAU,MAAA,KAAA;AAChB,MAAA,IAAA,CAAK,QAAU,EAAA,MAAA,CAAA,CAAA;AACf,MAAI,GAAA,CAAA,GAAA,EAAA,CAAA;AAAA,KAAA;AAAA,GAAA,CAAA;AAAA;;ACrQqE,MAAA,8BAAA,CAAA;AAAA,EAYrE,YAAY,OAAyC,EAAA;AAX7C,IAAe,IAAA,CAAA,IAAA,GAAA,UAAA,CAAA;AACf,IAAuB,IAAA,CAAA,oBAAA,GAAAmB,+CAAA,CAAA;AA5EzC,IAAA,IAAA,EAAA,EAAA,EAAA,CAAA;AAuFI,IAAA,IAAA,CAAK,YAAY,OAAQ,CAAA,SAAA,CAAA;AACzB,IAAK,IAAA,CAAA,gBAAA,GACH,QAAQ,gBAAoB,IAAA,oCAAA,CAAA;AAC9B,IAAA,IAAA,CAAK,SAAS,OAAQ,CAAA,MAAA,CAAA;AACtB,IAAA,IAAA,CAAK,gBACH,OAAQ,CAAA,aAAA,IACR,IAAIF,2BAAc,CAAA,EAAE,cAAc,OAAQ,CAAA,SAAA,EAAA,CAAA,CAAA;AAC5C,IAAK,IAAA,CAAA,gBAAA,GAAmB,CAAQ,EAAA,GAAA,OAAA,CAAA,gBAAA,KAAR,IAA4B,GAAA,EAAA,GAAA,EAAA,CAAA;AACpD,IAAK,IAAA,CAAA,gBAAA,GAAmB,CAAQ,EAAA,GAAA,OAAA,CAAA,gBAAA,KAAR,IAA4B,GAAA,EAAA,GAAA,KAAA,CAAA;AACpD,IAAA,IAAA,CAAK,eAAe,OAAQ,CAAA,YAAA,CAAA;AAAA,GAAA;AAAA,EAGvB,OAAA,UAAA,CAAW,QAAgB,OAAyC,EAAA;AACzE,IAAM,MAAA,gBAAA,GACJ,MAAO,CAAA,kBAAA,CACL,6CACG,CAAA,IAAA,KAAA,CAAA;AACP,IAAO,OAAA,IAAI,8BAA+B,CAAA,EAAA,GAAK,OAAS,EAAA,gBAAA,EAAA,CAAA,CAAA;AAAA,GAAA;AAAA,EAAA,MAGpD,WAAiC,GAAA;AACrC,IAAO,OAAAG,eAAA,CAAS,KAAK,IAAK,CAAA,OAAA,EAAA,CAAA,CAAA;AAAA,GAAA;AAAA,EAAA,OAGb,OAA6D,GAAA;AAC1E,IAAM,MAAA,KAAA,GAAQC,2BAAO,IAAK,CAAA,gBAAA,CAAA,CAAA;AAC1B,IAAA,MAAM,eAAkB,GAAA,MAAM,IAAK,CAAA,SAAA,CAAU,UAAW,CAAA,UAAA,CAAA,CAAA;AACxD,IAAA,MAAM,EAAE,KAAA,EAAA,GAAU,MAAM,IAAA,CAAK,YAAa,CAAA,QAAA,EAAA,CAAA;AAC1C,IAAA,IAAI,iBAAoB,GAAA,CAAA,CAAA;AACxB,IAAA,IAAI,iBAAoB,GAAA,IAAA,CAAA;AAMxB,IAAM,MAAA,SAAA,GAAY,KAAK,gBAAmB,GAAA,EAAA,CAAA;AAC1C,IAAA,OAAO,iBAAmB,EAAA;AACxB,MAAA,MAAM,QACJ,GAAA,CAAA,MAAM,IAAK,CAAA,aAAA,CAAc,WACvB,CAAA;AAAA,QACE,MAAQ,EAAA;AAAA,UACN,gDACE,EAAAC,mCAAA;AAAA,SAAA;AAAA,QAEJ,MAAQ,EAAA;AAAA,UACN,MAAA;AAAA,UACA,WAAA;AAAA,UACA,sBAAA;AAAA,UACA,eAAA;AAAA,UACA,gBAAA;AAAA,UACA,oBAAA;AAAA,UACA,WAAA;AAAA,UACA,gBAAA;AAAA,UACA,WAAA;AAAA,SAAA;AAAA,QAEF,KAAO,EAAA,SAAA;AAAA,QACP,MAAQ,EAAA,iBAAA;AAAA,OAAA,EAEV,EAAE,KAEJ,EAAA,CAAA,EAAA,KAAA,CAAA;AAGF,MAAA,iBAAA,GAAoB,SAAS,MAAW,KAAA,SAAA,CAAA;AACxC,MAAA,iBAAA,IAAqB,QAAS,CAAA,MAAA,CAAA;AAE9B,MAAM,MAAA,WAAA,GAAc,QACjB,CAAA,MAAA,CAAO,CAAG,EAAA,KAAA;AA1JnB,QAAA,IAAA,EAAA,EAAA,EAAA,CAAA;AA0JsB,QAAG,OAAA,CAAA,EAAA,GAAA,CAAA,EAAA,GAAA,EAAA,CAAA,QAAA,KAAH,IAAa,GAAA,KAAA,CAAA,GAAA,EAAA,CAAA,WAAA,KAAb,IAA2B,GAAA,KAAA,CAAA,GAAA,EAAA,CAAA,2BAAA,CAAA,CAAA;AAAA,OAAA,CAAA,CACxC,GAAI,CAAA,CAAC,MACJ,KAAA,KAAA,CAAM,YAAyC;AAC7C,QAAA,MAAM,UACJ,GAAA,8BAAA,CAA+B,sBAC7B,CAAA,IAAA,CAAK,gBACL,EAAA;AAAA,UACE,MAAM,MAAO,CAAA,IAAA;AAAA,UACb,SAAA,EAAW,MAAO,CAAA,QAAA,CAAS,SAAa,IAAA,SAAA;AAAA,UACxC,IAAA,EAAM,OAAO,QAAS,CAAA,IAAA;AAAA,SAAA,CAAA,CAAA;AAI5B,QAAI,IAAA;AACF,UAAA,MAAM,sBAAsB,MAAMV,yBAAA,CAChC,8BAA+B,CAAA,qBAAA,CAC7B,iBACA,UAEF,CAAA,EAAA;AAAA,YACE,OAAS,EAAA;AAAA,cACP,eAAe,CAAU,OAAA,EAAA,KAAA,CAAA,CAAA;AAAA,aAAA;AAAA,WAAA,CAAA,CAAA;AAI/B,UAAM,MAAA,WAAA,GAAc,MAAM,mBAAoB,CAAA,IAAA,EAAA,CAAA;AAE9C,UAAA,OAAO,WAAY,CAAA,IAAA,CAAK,GAAI,CAAA,CAAC,GAAuB,KAAA;AArLlE,YAAA,IAAA,EAAA,EAAA,EAAA,EAAA,EAAA,CAAA;AAqLsE,YAAA,OAAA;AAAA,cACtD,KAAA,EAAOW,6BAAS,GAAI,CAAA,KAAA,CAAA;AAAA,cACpB,IAAA,EAAMA,4BAAS,CAAA,GAAA,CAAI,IAAQ,IAAA,EAAA,CAAA;AAAA,cAC3B,QAAU,EAAA,IAAA,CAAK,iBACb,CAAA,IAAA,CAAK,oBAAoB,oCACzB,EAAA;AAAA,gBACK,GAAA,UAAA;AAAA,gBACH,MAAM,GAAI,CAAA,QAAA;AAAA,eAAA,CAAA;AAAA,cAGd,MAAM,GAAI,CAAA,QAAA;AAAA,cACP,GAAA,UAAA;AAAA,cACH,WAAA,EAAa,OAAO,QAAS,CAAA,KAAA;AAAA,cAC7B,eAAe,CAAO,CAAA,EAAA,GAAA,CAAA,EAAA,GAAA,MAAA,CAAA,IAAA,KAAP,IAAa,GAAA,KAAA,CAAA,GAAA,EAAA,CAAA,IAAA,KAAb,mBAAmB,QAAc,EAAA,KAAA,OAAA;AAAA,cAChD,SAAY,EAAA,CAAA,CAAA,EAAA,GAAA,MAAA,CAAO,IAAP,KAAA,IAAA,GAAA,KAAA,CAAA,GAAA,EAAA,CAAa,SAAwB,KAAA,EAAA;AAAA,cACjD,OAAOC,4BAA2B,CAAA,MAAA,CAAA;AAAA,cAClC,aAAe,EAAA;AAAA,gBACb,aAAaxB,+BAAmB,CAAA,MAAA,CAAA;AAAA,eAAA;AAAA,aAAA,CAAA;AAAA,WAAA,CAAA,CAAA;AAAA,SAAA,CAAA,OAG7B,CAAP,EAAA;AACA,UAAK,IAAA,CAAA,MAAA,CAAO,MACV,CAAwD,qDAAA,EAAA,UAAA,CAAW,aAAa,UAAW,CAAA,IAAA,CAAA,CAAA,EAAQ,WAAW,IAC9G,CAAA,CAAA,EAAA,CAAA,CAAA,CAAA;AAEF,UAAO,OAAA,EAAA,CAAA;AAAA,SAAA;AAAA,OAAA,CAAA,CAAA,CAAA;AAIf,MAAQ,OAAA,CAAA,MAAM,OAAQ,CAAA,GAAA,CAAI,WAAc,CAAA,EAAA,IAAA,EAAA,CAAA;AAAA,KAAA;AAAA,GAAA;AAAA,EAIpC,iBAAA,CACN,QACA,IACQ,EAAA;AACR,IAAA,IAAI,SAAY,GAAA,MAAA,CAAA;AAChB,IAAA,KAAA,MAAW,CAAC,GAAA,EAAK,KAAU,CAAA,IAAA,MAAA,CAAO,QAAQ,IAAO,CAAA,EAAA;AAC/C,MAAY,SAAA,GAAA,SAAA,CAAU,OAAQ,CAAA,CAAA,CAAA,EAAI,GAAO,CAAA,CAAA,EAAA,KAAA,CAAA,CAAA;AAAA,KAAA;AAE3C,IAAO,OAAA,SAAA,CAAA;AAAA,GAAA;AAAA,EAGM,OAAA,qBAAA,CACb,iBACA,UACA,EAAA;AACA,IAAA,OAAO,GAAG,eAA+B,CAAA,aAAA,EAAA,UAAA,CAAW,SAAa,CAAA,CAAA,EAAA,UAAA,CAAW,QAAQ,UAAW,CAAA,IAAA,CAAA,yBAAA,CAAA,CAAA;AAAA,GAAA;AAAA,EAGlF,OAAA,sBAAA,CACb,aACA,UACY,EAAA;AACZ,IAAO,OAAA,WAAA,GACH,UACA,GAAA,MAAA,CAAO,OAAQ,CAAA,UAAA,CAAA,CAAY,OAAO,CAAC,GAAA,EAAK,CAAC,GAAA,EAAK,KAAW,CAAA,KAAA;AACvD,MAAA,OAAO,EAAK,GAAA,GAAA,EAAA,CAAM,GAAM,GAAA,KAAA,CAAM,iBAAkB,CAAA,OAAA,CAAA,EAAA,CAAA;AAAA,KAC/C,EAAA,EAAA,CAAA,CAAA;AAAA,GAAA;AAAA,CAAA;AAIX,SAAAwB,4BAAA,CAAoC,MAAwB,EAAA;AAC1D,EAAA,IAAI,OAAO,SAAW,EAAA;AACpB,IAAA,MAAM,QAAQ,MAAO,CAAA,SAAA,CAAU,IAAK,CAAA,CAAA,CAAA,KAAK,EAAE,IAAS,KAAAC,8BAAA,CAAA,CAAA;AACpD,IAAA,IAAI,KAAO,EAAA;AACT,MAAM,MAAA,EAAE,IAAS,EAAA,GAAAC,2BAAA,CAAe,KAAM,CAAA,SAAA,CAAA,CAAA;AACtC,MAAO,OAAA,IAAA,CAAA;AAAA,KAAA;AAAA,GAAA;AAGX,EAAO,OAAA,EAAA,CAAA;AAAA;;ACnL4B,MAAA,uBAAA,CAAA;AAAA,EAI3B,WAAA,CACW,kBACA,OACjB,EAAA;AAFiB,IAAA,IAAA,CAAA,gBAAA,GAAA,gBAAA,CAAA;AACA,IAAA,IAAA,CAAA,OAAA,GAAA,OAAA,CAAA;AALH,IAAe,IAAA,CAAA,IAAA,GAAA,UAAA,CAAA;AACf,IAAuB,IAAA,CAAA,oBAAA,GAAAP,+CAAA,CAAA;AAAA,GAAA;AAAA,EAOhC,OAAA,UAAA,CAAW,QAAgB,OAAkC,EAAA;AAClE,IAAM,MAAA,gBAAA,GACJ,MAAO,CAAA,kBAAA,CACL,6CACG,CAAA,IAAA,KAAA,CAAA;AACP,IAAO,OAAA,IAAI,wBAAwB,gBAAkB,EAAA,OAAA,CAAA,CAAA;AAAA,GAAA;AAAA,EAAA,MAGjD,OAAU,GAAA;AACd,IAAM,MAAA;AAAA,MACJ,gBAAA;AAAA,MACA,SAAA;AAAA,MACA,YAAA;AAAA,qBACAH,eAAA;AAAA,MACA,gBAAA;AAAA,MACA,MAAA;AAAA,KAAA,GACE,IAAK,CAAA,OAAA,CAAA;AACT,IAAM,MAAA,KAAA,GAAQK,2BAAO,gBAAoB,IAAA,IAAA,GAAA,gBAAA,GAAA,EAAA,CAAA,CAAA;AACzC,IAAM,MAAA,eAAA,GAAkB,MAAM,SAAA,CAAU,UAAW,CAAA,UAAA,CAAA,CAAA;AACnD,IAAM,MAAA,EAAE,KAAU,EAAA,GAAA,MAAM,YAAa,CAAA,QAAA,EAAA,CAAA;AACrC,IAAM,MAAA,QAAA,GAAW,MACf,CAAiBL,eAAA,IAAA,IAAA,GAAAA,eAAA,GAAA,IAAIC,4BAAc,EAAE,YAAA,EAAc,cACnD,WACA,CAAA;AAAA,MACE,MAAQ,EAAA;AAAA,QACN,gDACE,EAAAK,mCAAA;AAAA,OAAA;AAAA,MAEJ,MAAQ,EAAA;AAAA,QACN,MAAA;AAAA,QACA,WAAA;AAAA,QACA,sBAAA;AAAA,QACA,eAAA;AAAA,QACA,gBAAA;AAAA,QACA,oBAAA;AAAA,QACA,WAAA;AAAA,QACA,gBAAA;AAAA,QACA,WAAA;AAAA,OAAA;AAAA,KAAA,EAGJ,EAAE,KAAA,EAAA,CAAA,CAAA;AAEJ,IAAA,MAAM,cAAc,QAAS,CAAA,KAAA,CAAM,IAAI,CAAC,MAAA,KACtC,MAAM,YAAyC;AA7HrD,MAAA,IAAA,EAAA,CAAA;AA8HQ,MAAA,MAAM,aAAa,uBAAwB,CAAA,sBAAA,CACzC,CAAK,EAAA,GAAA,IAAA,CAAA,gBAAA,KAAL,YAAyB,KACzB,EAAA;AAAA,QACE,MAAM,MAAO,CAAA,IAAA;AAAA,QACb,SAAA,EAAW,MAAO,CAAA,QAAA,CAAS,SAAa,IAAA,SAAA;AAAA,QACxC,IAAA,EAAM,OAAO,QAAS,CAAA,IAAA;AAAA,OAAA,CAAA,CAAA;AAI1B,MAAI,IAAA;AACF,QAAA,MAAM,sBAAsB,MAAMV,yBAAA,CAChC,uBAAwB,CAAA,qBAAA,CACtB,iBACA,UAEF,CAAA,EAAA;AAAA,UACE,OAAS,EAAA;AAAA,YACP,eAAe,CAAU,OAAA,EAAA,KAAA,CAAA,CAAA;AAAA,WAAA;AAAA,SAAA,CAAA,CAAA;AAI/B,QAAM,MAAA,WAAA,GAAc,MAAM,mBAAoB,CAAA,IAAA,EAAA,CAAA;AAE9C,QAAA,OAAO,WAAY,CAAA,IAAA,CAAK,GAAI,CAAA,CAAC,GAAuB,KAAA;AArJ9D,UAAA,IAAA,GAAA,EAAA,EAAA,EAAA,EAAA,CAAA;AAqJkE,UAAA,OAAA;AAAA,YACtD,KAAA,EAAOW,6BAAS,GAAI,CAAA,KAAA,CAAA;AAAA,YACpB,IAAA,EAAMA,4BAAS,CAAA,GAAA,CAAI,IAAQ,IAAA,EAAA,CAAA;AAAA,YAC3B,QAAU,EAAA,IAAA,CAAK,iBACb,CAAA,gBAAA,IAAoB,oCACpB,EAAA;AAAA,cACK,GAAA,UAAA;AAAA,cACH,MAAM,GAAI,CAAA,QAAA;AAAA,aAAA,CAAA;AAAA,YAGd,MAAM,GAAI,CAAA,QAAA;AAAA,YACP,GAAA,UAAA;AAAA,YACH,WAAA,EAAa,OAAO,QAAS,CAAA,KAAA;AAAA,YAC7B,eAAe,CAAO,CAAA,EAAA,GAAA,CAAA,GAAA,GAAA,MAAA,CAAA,IAAA,KAAP,IAAa,GAAA,KAAA,CAAA,GAAA,GAAA,CAAA,IAAA,KAAb,mBAAmB,QAAc,EAAA,KAAA,OAAA;AAAA,YAChD,SAAY,EAAA,CAAA,CAAA,EAAA,GAAA,MAAA,CAAO,IAAP,KAAA,IAAA,GAAA,KAAA,CAAA,GAAA,EAAA,CAAa,SAAwB,KAAA,EAAA;AAAA,YACjD,OAAO,0BAA2B,CAAA,MAAA,CAAA;AAAA,YAClC,aAAe,EAAA;AAAA,cACb,aAAavB,+BAAmB,CAAA,MAAA,CAAA;AAAA,aAAA;AAAA,WAAA,CAAA;AAAA,SAAA,CAAA,CAAA;AAAA,OAAA,CAAA,OAG7B,CAAP,EAAA;AACA,QAAA,MAAA,CAAO,MACL,CAAwD,qDAAA,EAAA,UAAA,CAAW,aAAa,UAAW,CAAA,IAAA,CAAA,CAAA,EAAQ,WAAW,IAC9G,CAAA,CAAA,EAAA,CAAA,CAAA,CAAA;AAEF,QAAO,OAAA,EAAA,CAAA;AAAA,OAAA;AAAA,KAAA,CAAA,CAAA,CAAA;AAIb,IAAQ,OAAA,CAAA,MAAM,OAAQ,CAAA,GAAA,CAAI,WAAc,CAAA,EAAA,IAAA,EAAA,CAAA;AAAA,GAAA;AAAA,EAGhC,iBAAA,CACR,QACA,IACQ,EAAA;AACR,IAAA,IAAI,SAAY,GAAA,MAAA,CAAA;AAChB,IAAA,KAAA,MAAW,CAAC,GAAA,EAAK,KAAU,CAAA,IAAA,MAAA,CAAO,QAAQ,IAAO,CAAA,EAAA;AAC/C,MAAY,SAAA,GAAA,SAAA,CAAU,OAAQ,CAAA,CAAA,CAAA,EAAI,GAAO,CAAA,CAAA,EAAA,KAAA,CAAA,CAAA;AAAA,KAAA;AAE3C,IAAO,OAAA,SAAA,CAAA;AAAA,GAAA;AAAA,EAGM,OAAA,qBAAA,CACb,iBACA,UACA,EAAA;AACA,IAAA,OAAO,GAAG,eAA+B,CAAA,aAAA,EAAA,UAAA,CAAW,SAAa,CAAA,CAAA,EAAA,UAAA,CAAW,QAAQ,UAAW,CAAA,IAAA,CAAA,yBAAA,CAAA,CAAA;AAAA,GAAA;AAAA,EAGlF,OAAA,sBAAA,CACb,aACA,UACY,EAAA;AACZ,IAAO,OAAA,WAAA,GACH,UACA,GAAA,MAAA,CAAO,OAAQ,CAAA,UAAA,CAAA,CAAY,OAAO,CAAC,GAAA,EAAK,CAAC,GAAA,EAAK,KAAW,CAAA,KAAA;AACvD,MAAA,OAAO,EAAK,GAAA,GAAA,EAAA,CAAM,GAAM,GAAA,KAAA,CAAM,iBAAkB,CAAA,OAAA,CAAA,EAAA,CAAA;AAAA,KAC/C,EAAA,EAAA,CAAA,CAAA;AAAA,GAAA;AAAA,CAAA;AAIX,SAAA,0BAAA,CAAoC,MAAwB,EAAA;AAC1D,EAAA,IAAI,OAAO,SAAW,EAAA;AACpB,IAAA,MAAM,QAAQ,MAAO,CAAA,SAAA,CAAU,IAAK,CAAA,CAAA,CAAA,KAAK,EAAE,IAAS,KAAAyB,8BAAA,CAAA,CAAA;AACpD,IAAA,IAAI,KAAO,EAAA;AACT,MAAM,MAAA,EAAE,IAAS,EAAA,GAAAC,2BAAA,CAAe,KAAM,CAAA,SAAA,CAAA,CAAA;AACtC,MAAO,OAAA,IAAA,CAAA;AAAA,KAAA;AAAA,GAAA;AAGX,EAAO,OAAA,EAAA,CAAA;AAAA;;;;;;;;;;;;"}