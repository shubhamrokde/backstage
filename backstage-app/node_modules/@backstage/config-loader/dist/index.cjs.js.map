{"version":3,"file":"index.cjs.js","sources":["../src/lib/env.ts","../src/lib/transform/utils.ts","../src/lib/transform/apply.ts","../src/lib/transform/include.ts","../src/lib/transform/substitution.ts","../src/lib/schema/types.ts","../src/lib/schema/compile.ts","../src/lib/schema/collect.ts","../src/lib/schema/filtering.ts","../src/lib/schema/load.ts","../src/lib/urls.ts","../src/loader.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { AppConfig } from '@backstage/config';\nimport { JsonObject } from '@backstage/types';\nimport { assertError } from '@backstage/errors';\n\nconst ENV_PREFIX = 'APP_CONFIG_';\n\n// Update the same pattern in config package if this is changed\nconst CONFIG_KEY_PART_PATTERN = /^[a-z][a-z0-9]*(?:[-_][a-z][a-z0-9]*)*$/i;\n\n/**\n * Read runtime configuration from the environment.\n *\n * Only environment variables prefixed with APP_CONFIG_ will be considered.\n *\n * For each variable, the prefix will be removed, and rest of the key will\n * be split by '_'. Each part will then be used as keys to build up a nested\n * config object structure. The treatment of the entire environment variable\n * is case-sensitive.\n *\n * The value of the variable should be JSON serialized, as it will be parsed\n * and the type will be kept intact. For example \"true\" and true are treated\n * differently, as well as \"42\" and 42.\n *\n * For example, to set the config app.title to \"My Title\", use the following:\n *\n * APP_CONFIG_app_title='\"My Title\"'\n *\n * @public\n */\nexport function readEnvConfig(env: {\n  [name: string]: string | undefined;\n}): AppConfig[] {\n  let data: JsonObject | undefined = undefined;\n\n  for (const [name, value] of Object.entries(env)) {\n    if (!value) {\n      continue;\n    }\n    if (name.startsWith(ENV_PREFIX)) {\n      const key = name.replace(ENV_PREFIX, '');\n      const keyParts = key.split('_');\n\n      let obj = (data = data ?? {});\n      for (const [index, part] of keyParts.entries()) {\n        if (!CONFIG_KEY_PART_PATTERN.test(part)) {\n          throw new TypeError(`Invalid env config key '${key}'`);\n        }\n        if (index < keyParts.length - 1) {\n          obj = (obj[part] = obj[part] ?? {}) as JsonObject;\n          if (typeof obj !== 'object' || Array.isArray(obj)) {\n            const subKey = keyParts.slice(0, index + 1).join('_');\n            throw new TypeError(\n              `Could not nest config for key '${key}' under existing value '${subKey}'`,\n            );\n          }\n        } else {\n          if (part in obj) {\n            throw new TypeError(\n              `Refusing to override existing config at key '${key}'`,\n            );\n          }\n          try {\n            const [, parsedValue] = safeJsonParse(value);\n            if (parsedValue === null) {\n              throw new Error('value may not be null');\n            }\n            obj[part] = parsedValue;\n          } catch (error) {\n            throw new TypeError(\n              `Failed to parse JSON-serialized config value for key '${key}', ${error}`,\n            );\n          }\n        }\n      }\n    }\n  }\n\n  return data ? [{ data, context: 'env' }] : [];\n}\n\nfunction safeJsonParse(str: string): [Error | null, any] {\n  try {\n    return [null, JSON.parse(str)];\n  } catch (err) {\n    assertError(err);\n    return [err, str];\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { JsonValue, JsonObject } from '@backstage/types';\n\nexport function isObject(obj: JsonValue | undefined): obj is JsonObject {\n  if (typeof obj !== 'object') {\n    return false;\n  } else if (Array.isArray(obj)) {\n    return false;\n  }\n  return obj !== null;\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { JsonObject, JsonValue } from '@backstage/types';\nimport { assertError } from '@backstage/errors';\nimport { TransformFunc } from './types';\nimport { isObject } from './utils';\n\n/**\n * Applies a set of transforms to raw configuration data.\n */\nexport async function applyConfigTransforms(\n  initialDir: string,\n  input: JsonValue,\n  transforms: TransformFunc[],\n): Promise<JsonObject> {\n  async function transform(\n    inputObj: JsonValue,\n    path: string,\n    baseDir: string,\n  ): Promise<JsonValue | undefined> {\n    let obj = inputObj;\n    let dir = baseDir;\n\n    for (const tf of transforms) {\n      try {\n        const result = await tf(inputObj, baseDir);\n        if (result.applied) {\n          if (result.value === undefined) {\n            return undefined;\n          }\n          obj = result.value;\n          dir = result.newBaseDir ?? dir;\n          break;\n        }\n      } catch (error) {\n        assertError(error);\n        throw new Error(`error at ${path}, ${error.message}`);\n      }\n    }\n\n    if (typeof obj !== 'object') {\n      return obj;\n    } else if (obj === null) {\n      return undefined;\n    } else if (Array.isArray(obj)) {\n      const arr = new Array<JsonValue>();\n\n      for (const [index, value] of obj.entries()) {\n        const out = await transform(value, `${path}[${index}]`, dir);\n        if (out !== undefined) {\n          arr.push(out);\n        }\n      }\n\n      return arr;\n    }\n\n    const out: JsonObject = {};\n\n    for (const [key, value] of Object.entries(obj)) {\n      // undefined covers optional fields\n      if (value !== undefined) {\n        const result = await transform(value, `${path}.${key}`, dir);\n        if (result !== undefined) {\n          out[key] = result;\n        }\n      }\n    }\n\n    return out;\n  }\n\n  const finalData = await transform(input, '', initialDir);\n  if (!isObject(finalData)) {\n    throw new TypeError('expected object at config root');\n  }\n  return finalData;\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport yaml from 'yaml';\nimport { extname, dirname, resolve as resolvePath } from 'path';\nimport { JsonObject, JsonValue } from '@backstage/types';\nimport { isObject } from './utils';\nimport { TransformFunc, EnvFunc, ReadFileFunc } from './types';\n\n// Parsers for each type of included file\nconst includeFileParser: {\n  [ext in string]: (content: string) => Promise<JsonObject>;\n} = {\n  '.json': async content => JSON.parse(content),\n  '.yaml': async content => yaml.parse(content),\n  '.yml': async content => yaml.parse(content),\n};\n\n/**\n * Transforms a include description into the actual included value.\n */\nexport function createIncludeTransform(\n  env: EnvFunc,\n  readFile: ReadFileFunc,\n  substitute: TransformFunc,\n): TransformFunc {\n  return async (input: JsonValue, baseDir: string) => {\n    if (!isObject(input)) {\n      return { applied: false };\n    }\n    // Check if there's any key that starts with a '$', in that case we treat\n    // this entire object as an include description.\n    const [includeKey] = Object.keys(input).filter(key => key.startsWith('$'));\n    if (includeKey) {\n      if (Object.keys(input).length !== 1) {\n        throw new Error(\n          `include key ${includeKey} should not have adjacent keys`,\n        );\n      }\n    } else {\n      return { applied: false };\n    }\n\n    const rawIncludedValue = input[includeKey];\n    if (typeof rawIncludedValue !== 'string') {\n      throw new Error(`${includeKey} include value is not a string`);\n    }\n\n    const substituteResults = await substitute(rawIncludedValue, baseDir);\n    const includeValue = substituteResults.applied\n      ? substituteResults.value\n      : rawIncludedValue;\n\n    // The second string check is needed for Typescript to know this is a string.\n    if (includeValue === undefined || typeof includeValue !== 'string') {\n      throw new Error(`${includeKey} substitution value was undefined`);\n    }\n\n    switch (includeKey) {\n      case '$file':\n        try {\n          const value = await readFile(resolvePath(baseDir, includeValue));\n          return { applied: true, value };\n        } catch (error) {\n          throw new Error(`failed to read file ${includeValue}, ${error}`);\n        }\n      case '$env':\n        try {\n          return { applied: true, value: await env(includeValue) };\n        } catch (error) {\n          throw new Error(`failed to read env ${includeValue}, ${error}`);\n        }\n\n      case '$include': {\n        const [filePath, dataPath] = includeValue.split(/#(.*)/);\n\n        const ext = extname(filePath);\n        const parser = includeFileParser[ext];\n        if (!parser) {\n          throw new Error(\n            `no configuration parser available for included file ${filePath}`,\n          );\n        }\n\n        const path = resolvePath(baseDir, filePath);\n        const content = await readFile(path);\n        const newBaseDir = dirname(path);\n\n        const parts = dataPath ? dataPath.split('.') : [];\n\n        let value: JsonValue | undefined;\n        try {\n          value = await parser(content);\n        } catch (error) {\n          throw new Error(\n            `failed to parse included file ${filePath}, ${error}`,\n          );\n        }\n\n        // This bit handles selecting a subtree in the included file, if a path was provided after a #\n        for (const [index, part] of parts.entries()) {\n          if (!isObject(value)) {\n            const errPath = parts.slice(0, index).join('.');\n            throw new Error(\n              `value at '${errPath}' in included file ${filePath} is not an object`,\n            );\n          }\n          value = value[part];\n        }\n\n        return {\n          applied: true,\n          value,\n          newBaseDir: newBaseDir !== baseDir ? newBaseDir : undefined,\n        };\n      }\n\n      default:\n        throw new Error(`unknown include ${includeKey}`);\n    }\n  };\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { JsonValue } from '@backstage/types';\nimport { TransformFunc, EnvFunc } from './types';\n\n/**\n * A environment variable substitution transform that transforms e.g. 'token ${MY_TOKEN}'\n * to 'token abc' if MY_TOKEN is 'abc'. If any of the substituted variables are undefined,\n * the entire expression ends up undefined.\n */\nexport function createSubstitutionTransform(env: EnvFunc): TransformFunc {\n  return async (input: JsonValue) => {\n    if (typeof input !== 'string') {\n      return { applied: false };\n    }\n\n    const parts: (string | undefined)[] = input.split(/(\\$?\\$\\{[^{}]*\\})/);\n    for (let i = 1; i < parts.length; i += 2) {\n      const part = parts[i]!;\n      if (part.startsWith('$$')) {\n        parts[i] = part.slice(1);\n      } else {\n        parts[i] = await env(part.slice(2, -1).trim());\n      }\n    }\n\n    if (parts.some(part => part === undefined)) {\n      return { applied: true, value: undefined };\n    }\n    return { applied: true, value: parts.join('') };\n  };\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { AppConfig } from '@backstage/config';\nimport { JsonObject } from '@backstage/types';\n\n/**\n * An sub-set of configuration schema.\n */\nexport type ConfigSchemaPackageEntry = {\n  /**\n   * The configuration schema itself.\n   */\n  value: JsonObject;\n  /**\n   * The relative path that the configuration schema was discovered at.\n   */\n  path: string;\n};\n\n/**\n * A list of all possible configuration value visibilities.\n */\nexport const CONFIG_VISIBILITIES = ['frontend', 'backend', 'secret'] as const;\n\n/**\n * A type representing the possible configuration value visibilities\n *\n * @public\n */\nexport type ConfigVisibility = 'frontend' | 'backend' | 'secret';\n\n/**\n * The default configuration visibility if no other values is given.\n */\nexport const DEFAULT_CONFIG_VISIBILITY: ConfigVisibility = 'backend';\n\n/**\n * An explanation of a configuration validation error.\n */\nexport type ValidationError = {\n  keyword: string;\n  dataPath: string;\n  schemaPath: string;\n  params: Record<string, any>;\n  propertyName?: string;\n  message?: string;\n};\n\n/**\n * The result of validating configuration data using a schema.\n */\ntype ValidationResult = {\n  /**\n   * Errors that where emitted during validation, if any.\n   */\n  errors?: ValidationError[];\n  /**\n   * The configuration visibilities that were discovered during validation.\n   *\n   * The path in the key uses the form `/<key>/<sub-key>/<array-index>/<leaf-key>`\n   */\n  visibilityByDataPath: Map<string, ConfigVisibility>;\n\n  /**\n   * The configuration visibilities that were discovered during validation.\n   *\n   * The path in the key uses the form `/properties/<key>/items/additionalProperties/<leaf-key>`\n   */\n  visibilityBySchemaPath: Map<string, ConfigVisibility>;\n\n  /**\n   * The deprecated options that were discovered during validation.\n   *\n   * The path in the key uses the form `/<key>/<sub-key>/<array-index>/<leaf-key>`\n   */\n  deprecationByDataPath: Map<string, string>;\n};\n\n/**\n * A function used validate configuration data.\n */\nexport type ValidationFunc = (configs: AppConfig[]) => ValidationResult;\n\n/**\n * A function used to transform primitive configuration values.\n *\n * @public\n */\nexport type TransformFunc<T extends number | string | boolean> = (\n  value: T,\n  context: { visibility: ConfigVisibility },\n) => T | undefined;\n\n/**\n * Options used to process configuration data with a schema.\n *\n * @public\n */\nexport type ConfigSchemaProcessingOptions = {\n  /**\n   * The visibilities that should be included in the output data.\n   * If omitted, the data will not be filtered by visibility.\n   */\n  visibility?: ConfigVisibility[];\n\n  /**\n   * A transform function that can be used to transform primitive configuration values\n   * during validation. The value returned from the transform function will be used\n   * instead of the original value. If the transform returns `undefined`, the value\n   * will be omitted.\n   */\n  valueTransform?: TransformFunc<any>;\n\n  /**\n   * Whether or not to include the `filteredKeys` property in the output `AppConfig`s.\n   *\n   * Default: `false`.\n   */\n  withFilteredKeys?: boolean;\n\n  /**\n   * Whether or not to include the `deprecatedKeys` property in the output `AppConfig`s.\n   *\n   * Default: `true`.\n   */\n  withDeprecatedKeys?: boolean;\n};\n\n/**\n * A loaded configuration schema that is ready to process configuration data.\n *\n * @public\n */\nexport type ConfigSchema = {\n  process(\n    appConfigs: AppConfig[],\n    options?: ConfigSchemaProcessingOptions,\n  ): AppConfig[];\n\n  serialize(): JsonObject;\n};\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport Ajv from 'ajv';\nimport { JSONSchema7 as JSONSchema } from 'json-schema';\nimport mergeAllOf, { Resolvers } from 'json-schema-merge-allof';\nimport traverse from 'json-schema-traverse';\nimport { ConfigReader } from '@backstage/config';\nimport {\n  ConfigSchemaPackageEntry,\n  ValidationFunc,\n  CONFIG_VISIBILITIES,\n  ConfigVisibility,\n} from './types';\n\n/**\n * This takes a collection of Backstage configuration schemas from various\n * sources and compiles them down into a single schema validation function.\n *\n * It also handles the implementation of the custom \"visibility\" keyword used\n * to specify the scope of different config paths.\n */\nexport function compileConfigSchemas(\n  schemas: ConfigSchemaPackageEntry[],\n): ValidationFunc {\n  // The ajv instance below is stateful and doesn't really allow for additional\n  // output during validation. We work around this by having this extra piece\n  // of state that we reset before each validation.\n  const visibilityByDataPath = new Map<string, ConfigVisibility>();\n  const deprecationByDataPath = new Map<string, string>();\n\n  const ajv = new Ajv({\n    allErrors: true,\n    allowUnionTypes: true,\n    schemas: {\n      'https://backstage.io/schema/config-v1': true,\n    },\n  })\n    .addKeyword({\n      keyword: 'visibility',\n      metaSchema: {\n        type: 'string',\n        enum: CONFIG_VISIBILITIES,\n      },\n      compile(visibility: ConfigVisibility) {\n        return (_data, context) => {\n          if (context?.dataPath === undefined) {\n            return false;\n          }\n          if (visibility && visibility !== 'backend') {\n            const normalizedPath = context.dataPath.replace(\n              /\\['?(.*?)'?\\]/g,\n              (_, segment) => `/${segment}`,\n            );\n            visibilityByDataPath.set(normalizedPath, visibility);\n          }\n          return true;\n        };\n      },\n    })\n    .removeKeyword('deprecated') // remove `deprecated` keyword so that we can implement our own compiler\n    .addKeyword({\n      keyword: 'deprecated',\n      metaSchema: { type: 'string' },\n      compile(deprecationDescription: string) {\n        return (_data, context) => {\n          if (context?.dataPath === undefined) {\n            return false;\n          }\n          const normalizedPath = context.dataPath.replace(\n            /\\['?(.*?)'?\\]/g,\n            (_, segment) => `/${segment}`,\n          );\n          // create mapping of deprecation description and data path of property\n          deprecationByDataPath.set(normalizedPath, deprecationDescription);\n          return true;\n        };\n      },\n    });\n\n  for (const schema of schemas) {\n    try {\n      ajv.compile(schema.value);\n    } catch (error) {\n      throw new Error(`Schema at ${schema.path} is invalid, ${error}`);\n    }\n  }\n\n  const merged = mergeConfigSchemas(schemas.map(_ => _.value));\n\n  const validate = ajv.compile(merged);\n\n  const visibilityBySchemaPath = new Map<string, ConfigVisibility>();\n  traverse(merged, (schema, path) => {\n    if (schema.visibility && schema.visibility !== 'backend') {\n      visibilityBySchemaPath.set(path, schema.visibility);\n    }\n  });\n\n  return configs => {\n    const config = ConfigReader.fromConfigs(configs).get();\n\n    visibilityByDataPath.clear();\n\n    const valid = validate(config);\n\n    if (!valid) {\n      return {\n        errors: validate.errors ?? [],\n        visibilityByDataPath: new Map(visibilityByDataPath),\n        visibilityBySchemaPath,\n        deprecationByDataPath,\n      };\n    }\n\n    return {\n      visibilityByDataPath: new Map(visibilityByDataPath),\n      visibilityBySchemaPath,\n      deprecationByDataPath,\n    };\n  };\n}\n\n/**\n * Given a list of configuration schemas from packages, merge them\n * into a single json schema.\n *\n * @public\n */\nexport function mergeConfigSchemas(schemas: JSONSchema[]): JSONSchema {\n  const merged = mergeAllOf(\n    { allOf: schemas },\n    {\n      // JSONSchema is typically subtractive, as in it always reduces the set of allowed\n      // inputs through constraints. This changes the object property merging to be additive\n      // rather than subtractive.\n      ignoreAdditionalProperties: true,\n      resolvers: {\n        // This ensures that the visibilities across different schemas are sound, and\n        // selects the most specific visibility for each path.\n        visibility(values: string[], path: string[]) {\n          const hasFrontend = values.some(_ => _ === 'frontend');\n          const hasSecret = values.some(_ => _ === 'secret');\n          if (hasFrontend && hasSecret) {\n            throw new Error(\n              `Config schema visibility is both 'frontend' and 'secret' for ${path.join(\n                '/',\n              )}`,\n            );\n          } else if (hasFrontend) {\n            return 'frontend';\n          } else if (hasSecret) {\n            return 'secret';\n          }\n\n          return 'backend';\n        },\n      } as Partial<Resolvers<JSONSchema>>,\n    },\n  );\n  return merged;\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport fs from 'fs-extra';\nimport {\n  resolve as resolvePath,\n  relative as relativePath,\n  dirname,\n  sep,\n} from 'path';\nimport { ConfigSchemaPackageEntry } from './types';\nimport { JsonObject } from '@backstage/types';\nimport { assertError } from '@backstage/errors';\n\ntype Item = {\n  name?: string;\n  parentPath?: string;\n  packagePath?: string;\n};\n\nconst req =\n  typeof __non_webpack_require__ === 'undefined'\n    ? require\n    : __non_webpack_require__;\n\n/**\n * This collects all known config schemas across all dependencies of the app.\n */\nexport async function collectConfigSchemas(\n  packageNames: string[],\n  packagePaths: string[],\n): Promise<ConfigSchemaPackageEntry[]> {\n  const schemas = new Array<ConfigSchemaPackageEntry>();\n  const tsSchemaPaths = new Array<string>();\n  const visitedPackageVersions = new Map<string, Set<string>>(); // pkgName: [versions...]\n\n  const currentDir = await fs.realpath(process.cwd());\n\n  async function processItem(item: Item) {\n    let pkgPath = item.packagePath;\n\n    if (pkgPath) {\n      const pkgExists = await fs.pathExists(pkgPath);\n      if (!pkgExists) {\n        return;\n      }\n    } else if (item.name) {\n      const { name, parentPath } = item;\n\n      try {\n        pkgPath = req.resolve(\n          `${name}/package.json`,\n          parentPath && {\n            paths: [parentPath],\n          },\n        );\n      } catch {\n        // We can somewhat safely ignore packages that don't export package.json,\n        // as they are likely not part of the Backstage ecosystem anyway.\n      }\n    }\n    if (!pkgPath) {\n      return;\n    }\n\n    const pkg = await fs.readJson(pkgPath);\n\n    // Ensures that we only process the same version of each package once.\n    let versions = visitedPackageVersions.get(pkg.name);\n    if (versions?.has(pkg.version)) {\n      return;\n    }\n    if (!versions) {\n      versions = new Set();\n      visitedPackageVersions.set(pkg.name, versions);\n    }\n    versions.add(pkg.version);\n\n    const depNames = [\n      ...Object.keys(pkg.dependencies ?? {}),\n      ...Object.keys(pkg.devDependencies ?? {}),\n      ...Object.keys(pkg.optionalDependencies ?? {}),\n      ...Object.keys(pkg.peerDependencies ?? {}),\n    ];\n\n    // TODO(Rugvip): Trying this out to avoid having to traverse the full dependency graph,\n    //               since that's pretty slow. We probably need a better way to determine when\n    //               we've left the Backstage ecosystem, but this will do for now.\n    const hasSchema = 'configSchema' in pkg;\n    const hasBackstageDep = depNames.some(_ => _.startsWith('@backstage/'));\n    if (!hasSchema && !hasBackstageDep) {\n      return;\n    }\n    if (hasSchema) {\n      if (typeof pkg.configSchema === 'string') {\n        const isJson = pkg.configSchema.endsWith('.json');\n        const isDts = pkg.configSchema.endsWith('.d.ts');\n        if (!isJson && !isDts) {\n          throw new Error(\n            `Config schema files must be .json or .d.ts, got ${pkg.configSchema}`,\n          );\n        }\n        if (isDts) {\n          tsSchemaPaths.push(\n            relativePath(\n              currentDir,\n              resolvePath(dirname(pkgPath), pkg.configSchema),\n            ),\n          );\n        } else {\n          const path = resolvePath(dirname(pkgPath), pkg.configSchema);\n          const value = await fs.readJson(path);\n          schemas.push({\n            value,\n            path: relativePath(currentDir, path),\n          });\n        }\n      } else {\n        schemas.push({\n          value: pkg.configSchema,\n          path: relativePath(currentDir, pkgPath),\n        });\n      }\n    }\n\n    await Promise.all(\n      depNames.map(depName =>\n        processItem({ name: depName, parentPath: pkgPath }),\n      ),\n    );\n  }\n\n  await Promise.all([\n    ...packageNames.map(name => processItem({ name, parentPath: currentDir })),\n    ...packagePaths.map(path => processItem({ name: path, packagePath: path })),\n  ]);\n\n  const tsSchemas = await compileTsSchemas(tsSchemaPaths);\n\n  return schemas.concat(tsSchemas);\n}\n\n// This handles the support of TypeScript .d.ts config schema declarations.\n// We collect all typescript schema definition and compile them all in one go.\n// This is much faster than compiling them separately.\nasync function compileTsSchemas(paths: string[]) {\n  if (paths.length === 0) {\n    return [];\n  }\n\n  // Lazy loaded, because this brings up all of TypeScript and we don't\n  // want that eagerly loaded in tests\n  const { getProgramFromFiles, generateSchema } = await import(\n    'typescript-json-schema'\n  );\n\n  const program = getProgramFromFiles(paths, {\n    incremental: false,\n    isolatedModules: true,\n    lib: ['ES5'], // Skipping most libs speeds processing up a lot, we just need the primitive types anyway\n    noEmit: true,\n    noResolve: true,\n    skipLibCheck: true, // Skipping lib checks speeds things up\n    skipDefaultLibCheck: true,\n    strict: true,\n    typeRoots: [], // Do not include any additional types\n    types: [],\n  });\n\n  const tsSchemas = paths.map(path => {\n    let value;\n    try {\n      value = generateSchema(\n        program,\n        // All schemas should export a `Config` symbol\n        'Config',\n        // This enables the use of these tags in TSDoc comments\n        {\n          required: true,\n          validationKeywords: ['visibility', 'deprecated'],\n        },\n        [path.split(sep).join('/')], // Unix paths are expected for all OSes here\n      ) as JsonObject | null;\n    } catch (error) {\n      assertError(error);\n      if (error.message !== 'type Config not found') {\n        throw error;\n      }\n    }\n\n    if (!value) {\n      throw new Error(`Invalid schema in ${path}, missing Config export`);\n    }\n    return { path, value };\n  });\n\n  return tsSchemas;\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { JsonObject, JsonValue } from '@backstage/types';\nimport {\n  ConfigVisibility,\n  DEFAULT_CONFIG_VISIBILITY,\n  TransformFunc,\n  ValidationError,\n} from './types';\n\n/**\n * This filters data by visibility by discovering the visibility of each\n * value, and then only keeping the ones that are specified in `includeVisibilities`.\n */\nexport function filterByVisibility(\n  data: JsonObject,\n  includeVisibilities: ConfigVisibility[],\n  visibilityByDataPath: Map<string, ConfigVisibility>,\n  deprecationByDataPath: Map<string, string>,\n  transformFunc?: TransformFunc<number | string | boolean>,\n  withFilteredKeys?: boolean,\n  withDeprecatedKeys?: boolean,\n): {\n  data: JsonObject;\n  filteredKeys?: string[];\n  deprecatedKeys?: { key: string; description: string }[];\n} {\n  const filteredKeys = new Array<string>();\n  const deprecatedKeys = new Array<{ key: string; description: string }>();\n\n  function transform(\n    jsonVal: JsonValue,\n    visibilityPath: string, // Matches the format we get from ajv\n    filterPath: string, // Matches the format of the ConfigReader\n  ): JsonValue | undefined {\n    const visibility =\n      visibilityByDataPath.get(visibilityPath) ?? DEFAULT_CONFIG_VISIBILITY;\n    const isVisible = includeVisibilities.includes(visibility);\n\n    // deprecated keys are added regardless of visibility indicator\n    const deprecation = deprecationByDataPath.get(visibilityPath);\n    if (deprecation) {\n      deprecatedKeys.push({ key: filterPath, description: deprecation });\n    }\n\n    if (typeof jsonVal !== 'object') {\n      if (isVisible) {\n        if (transformFunc) {\n          return transformFunc(jsonVal, { visibility });\n        }\n        return jsonVal;\n      }\n      if (withFilteredKeys) {\n        filteredKeys.push(filterPath);\n      }\n      return undefined;\n    } else if (jsonVal === null) {\n      return undefined;\n    } else if (Array.isArray(jsonVal)) {\n      const arr = new Array<JsonValue>();\n\n      for (const [index, value] of jsonVal.entries()) {\n        let path = visibilityPath;\n        const hasVisibilityInIndex = visibilityByDataPath.get(\n          `${visibilityPath}/${index}`,\n        );\n\n        if (hasVisibilityInIndex || typeof value === 'object') {\n          path = `${visibilityPath}/${index}`;\n        }\n\n        const out = transform(value, path, `${filterPath}[${index}]`);\n\n        if (out !== undefined) {\n          arr.push(out);\n        }\n      }\n\n      if (arr.length > 0 || isVisible) {\n        return arr;\n      }\n      return undefined;\n    }\n\n    const outObj: JsonObject = {};\n    let hasOutput = false;\n\n    for (const [key, value] of Object.entries(jsonVal)) {\n      if (value === undefined) {\n        continue;\n      }\n      const out = transform(\n        value,\n        `${visibilityPath}/${key}`,\n        filterPath ? `${filterPath}.${key}` : key,\n      );\n      if (out !== undefined) {\n        outObj[key] = out;\n        hasOutput = true;\n      }\n    }\n\n    if (hasOutput || isVisible) {\n      return outObj;\n    }\n    return undefined;\n  }\n\n  return {\n    filteredKeys: withFilteredKeys ? filteredKeys : undefined,\n    deprecatedKeys: withDeprecatedKeys ? deprecatedKeys : undefined,\n    data: (transform(data, '', '') as JsonObject) ?? {},\n  };\n}\n\nexport function filterErrorsByVisibility(\n  errors: ValidationError[] | undefined,\n  includeVisibilities: ConfigVisibility[] | undefined,\n  visibilityByDataPath: Map<string, ConfigVisibility>,\n  visibilityBySchemaPath: Map<string, ConfigVisibility>,\n): ValidationError[] {\n  if (!errors) {\n    return [];\n  }\n  if (!includeVisibilities) {\n    return errors;\n  }\n\n  const visibleSchemaPaths = Array.from(visibilityBySchemaPath)\n    .filter(([, v]) => includeVisibilities.includes(v))\n    .map(([k]) => k);\n\n  // If we're filtering by visibility we only care about the errors that happened\n  // in a visible path.\n  return errors.filter(error => {\n    // We always include structural errors as we don't know whether there are\n    // any visible paths within the structures.\n    if (\n      error.keyword === 'type' &&\n      ['object', 'array'].includes(error.params.type)\n    ) {\n      return true;\n    }\n\n    // For fields that were required we use the schema path to determine whether\n    // it was visible in addition to the data path. This is because the data path\n    // visibilities are only populated for values that we reached, which we won't\n    // if the value is missing.\n    // We don't use this method for all the errors as the data path is more robust\n    // and doesn't require us to properly trim the schema path.\n    if (error.keyword === 'required') {\n      const trimmedPath = error.schemaPath.slice(1, -'/required'.length);\n      const fullPath = `${trimmedPath}/properties/${error.params.missingProperty}`;\n      if (\n        visibleSchemaPaths.some(visiblePath => visiblePath.startsWith(fullPath))\n      ) {\n        return true;\n      }\n    }\n\n    const vis =\n      visibilityByDataPath.get(error.dataPath) ?? DEFAULT_CONFIG_VISIBILITY;\n    return vis && includeVisibilities.includes(vis);\n  });\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { AppConfig } from '@backstage/config';\nimport { JsonObject } from '@backstage/types';\nimport { compileConfigSchemas } from './compile';\nimport { collectConfigSchemas } from './collect';\nimport { filterByVisibility, filterErrorsByVisibility } from './filtering';\nimport {\n  ValidationError,\n  ConfigSchema,\n  ConfigSchemaPackageEntry,\n  CONFIG_VISIBILITIES,\n} from './types';\n\n/**\n * Options that control the loading of configuration schema files in the backend.\n *\n * @public\n */\nexport type LoadConfigSchemaOptions =\n  | {\n      dependencies: string[];\n      packagePaths?: string[];\n    }\n  | {\n      serialized: JsonObject;\n    };\n\nfunction errorsToError(errors: ValidationError[]): Error {\n  const messages = errors.map(({ dataPath, message, params }) => {\n    const paramStr = Object.entries(params)\n      .map(([name, value]) => `${name}=${value}`)\n      .join(' ');\n    return `Config ${message || ''} { ${paramStr} } at ${dataPath}`;\n  });\n  const error = new Error(`Config validation failed, ${messages.join('; ')}`);\n  (error as any).messages = messages;\n  return error;\n}\n\n/**\n * Loads config schema for a Backstage instance.\n *\n * @public\n */\nexport async function loadConfigSchema(\n  options: LoadConfigSchemaOptions,\n): Promise<ConfigSchema> {\n  let schemas: ConfigSchemaPackageEntry[];\n\n  if ('dependencies' in options) {\n    schemas = await collectConfigSchemas(\n      options.dependencies,\n      options.packagePaths ?? [],\n    );\n  } else {\n    const { serialized } = options;\n    if (serialized?.backstageConfigSchemaVersion !== 1) {\n      throw new Error(\n        'Serialized configuration schema is invalid or has an invalid version number',\n      );\n    }\n    schemas = serialized.schemas as ConfigSchemaPackageEntry[];\n  }\n\n  const validate = compileConfigSchemas(schemas);\n\n  return {\n    process(\n      configs: AppConfig[],\n      { visibility, valueTransform, withFilteredKeys, withDeprecatedKeys } = {},\n    ): AppConfig[] {\n      const result = validate(configs);\n\n      const visibleErrors = filterErrorsByVisibility(\n        result.errors,\n        visibility,\n        result.visibilityByDataPath,\n        result.visibilityBySchemaPath,\n      );\n      if (visibleErrors.length > 0) {\n        throw errorsToError(visibleErrors);\n      }\n\n      let processedConfigs = configs;\n\n      if (visibility) {\n        processedConfigs = processedConfigs.map(({ data, context }) => ({\n          context,\n          ...filterByVisibility(\n            data,\n            visibility,\n            result.visibilityByDataPath,\n            result.deprecationByDataPath,\n            valueTransform,\n            withFilteredKeys,\n            withDeprecatedKeys,\n          ),\n        }));\n      } else if (valueTransform) {\n        processedConfigs = processedConfigs.map(({ data, context }) => ({\n          context,\n          ...filterByVisibility(\n            data,\n            Array.from(CONFIG_VISIBILITIES),\n            result.visibilityByDataPath,\n            result.deprecationByDataPath,\n            valueTransform,\n            withFilteredKeys,\n            withDeprecatedKeys,\n          ),\n        }));\n      }\n\n      return processedConfigs;\n    },\n    serialize(): JsonObject {\n      return {\n        schemas,\n        backstageConfigSchemaVersion: 1,\n      };\n    },\n  };\n}\n","/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nexport function isValidUrl(url: string): boolean {\n  try {\n    // eslint-disable-next-line no-new\n    new URL(url);\n    return true;\n  } catch {\n    return false;\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport fs from 'fs-extra';\nimport yaml from 'yaml';\nimport chokidar from 'chokidar';\nimport { basename, dirname, isAbsolute, resolve as resolvePath } from 'path';\nimport { AppConfig } from '@backstage/config';\nimport { ForwardedError } from '@backstage/errors';\nimport {\n  applyConfigTransforms,\n  createIncludeTransform,\n  createSubstitutionTransform,\n  isValidUrl,\n  readEnvConfig,\n} from './lib';\nimport fetch from 'node-fetch';\n\n/** @public */\nexport type ConfigTarget = { path: string } | { url: string };\n\n/** @public */\nexport type LoadConfigOptionsWatch = {\n  /**\n   * A listener that is called when a config file is changed.\n   */\n  onChange: (configs: AppConfig[]) => void;\n\n  /**\n   * An optional signal that stops the watcher once the promise resolves.\n   */\n  stopSignal?: Promise<void>;\n};\n\n/** @public */\nexport type LoadConfigOptionsRemote = {\n  /**\n   * A remote config reloading period, in seconds\n   */\n  reloadIntervalSeconds: number;\n};\n\n/**\n * Options that control the loading of configuration files in the backend.\n *\n * @public\n */\nexport type LoadConfigOptions = {\n  // The root directory of the config loading context. Used to find default configs.\n  configRoot: string;\n\n  // Paths to load config files from. Configs from earlier paths have lower priority.\n  configTargets: ConfigTarget[];\n\n  /**\n   * Custom environment variable loading function\n   *\n   * @experimental This API is not stable and may change at any point\n   */\n  experimentalEnvFunc?: (name: string) => Promise<string | undefined>;\n\n  /**\n   * An optional remote config\n   */\n  remote?: LoadConfigOptionsRemote;\n\n  /**\n   * An optional configuration that enables watching of config files.\n   */\n  watch?: LoadConfigOptionsWatch;\n};\n\n/**\n * Results of loading configuration files.\n * @public\n */\nexport type LoadConfigResult = {\n  /**\n   * Array of all loaded configs.\n   */\n  appConfigs: AppConfig[];\n};\n\n/**\n * Load configuration data.\n *\n * @public\n */\nexport async function loadConfig(\n  options: LoadConfigOptions,\n): Promise<LoadConfigResult> {\n  const { configRoot, experimentalEnvFunc: envFunc, watch, remote } = options;\n\n  const configPaths: string[] = options.configTargets\n    .slice()\n    .filter((e): e is { path: string } => e.hasOwnProperty('path'))\n    .map(configTarget => configTarget.path);\n\n  const configUrls: string[] = options.configTargets\n    .slice()\n    .filter((e): e is { url: string } => e.hasOwnProperty('url'))\n    .map(configTarget => configTarget.url);\n\n  if (remote === undefined) {\n    if (configUrls.length > 0) {\n      throw new Error(\n        `Please make sure you are passing the remote option when loading remote configurations. See https://backstage.io/docs/conf/writing#configuration-files for detailed info.`,\n      );\n    }\n  } else if (remote.reloadIntervalSeconds <= 0) {\n    throw new Error(\n      `Remote config must be contain a non zero reloadIntervalSeconds: <seconds> value`,\n    );\n  }\n\n  // If no paths are provided, we default to reading\n  // `app-config.yaml` and, if it exists, `app-config.local.yaml`\n  if (configPaths.length === 0 && configUrls.length === 0) {\n    configPaths.push(resolvePath(configRoot, 'app-config.yaml'));\n\n    const localConfig = resolvePath(configRoot, 'app-config.local.yaml');\n    if (await fs.pathExists(localConfig)) {\n      configPaths.push(localConfig);\n    }\n  }\n\n  const env = envFunc ?? (async (name: string) => process.env[name]);\n\n  const loadConfigFiles = async () => {\n    const fileConfigs = [];\n    const loadedPaths = new Set<string>();\n\n    for (const configPath of configPaths) {\n      if (!isAbsolute(configPath)) {\n        throw new Error(`Config load path is not absolute: '${configPath}'`);\n      }\n\n      const dir = dirname(configPath);\n      const readFile = (path: string) => {\n        const fullPath = resolvePath(dir, path);\n        // if we read a file when building configuration,\n        // we should include that file when watching for\n        // changes, too.\n        loadedPaths.add(fullPath);\n\n        return fs.readFile(fullPath, 'utf8');\n      };\n\n      const input = yaml.parse(await readFile(configPath));\n      const substitutionTransform = createSubstitutionTransform(env);\n      const data = await applyConfigTransforms(dir, input, [\n        createIncludeTransform(env, readFile, substitutionTransform),\n        substitutionTransform,\n      ]);\n\n      fileConfigs.push({ data, context: basename(configPath) });\n    }\n\n    return { fileConfigs, loadedPaths };\n  };\n\n  const loadRemoteConfigFiles = async () => {\n    const configs: AppConfig[] = [];\n\n    const readConfigFromUrl = async (url: string) => {\n      const response = await fetch(url);\n      if (!response.ok) {\n        throw new Error(`Could not read config file at ${url}`);\n      }\n\n      return await response.text();\n    };\n\n    for (let i = 0; i < configUrls.length; i++) {\n      const configUrl = configUrls[i];\n      if (!isValidUrl(configUrl)) {\n        throw new Error(`Config load path is not valid: '${configUrl}'`);\n      }\n\n      const remoteConfigContent = await readConfigFromUrl(configUrl);\n      if (!remoteConfigContent) {\n        throw new Error(`Config is not valid`);\n      }\n      const configYaml = yaml.parse(remoteConfigContent);\n      const substitutionTransform = createSubstitutionTransform(env);\n      const data = await applyConfigTransforms(configRoot, configYaml, [\n        substitutionTransform,\n      ]);\n\n      configs.push({ data, context: configUrl });\n    }\n\n    return configs;\n  };\n\n  let fileConfigs: AppConfig[];\n  let loadedPaths: Set<string>;\n  try {\n    ({ fileConfigs, loadedPaths } = await loadConfigFiles());\n  } catch (error) {\n    throw new ForwardedError('Failed to read static configuration file', error);\n  }\n\n  let remoteConfigs: AppConfig[] = [];\n  if (remote) {\n    try {\n      remoteConfigs = await loadRemoteConfigFiles();\n    } catch (error) {\n      throw new ForwardedError(\n        `Failed to read remote configuration file`,\n        error,\n      );\n    }\n  }\n\n  const envConfigs = await readEnvConfig(process.env);\n\n  const watchConfigFile = (watchProp: LoadConfigOptionsWatch) => {\n    let watchedFiles = Array.from(loadedPaths);\n\n    const watcher = chokidar.watch(watchedFiles, {\n      usePolling: process.env.NODE_ENV === 'test',\n    });\n\n    let currentSerializedConfig = JSON.stringify(fileConfigs);\n    watcher.on('change', async () => {\n      try {\n        const { fileConfigs: newConfigs, loadedPaths: newLoadedPaths } =\n          await loadConfigFiles();\n\n        // Replace watches to handle any added or removed\n        // $include or $file expressions.\n        watcher.unwatch(watchedFiles);\n        watchedFiles = Array.from(newLoadedPaths);\n        watcher.add(watchedFiles);\n\n        const newSerializedConfig = JSON.stringify(newConfigs);\n\n        if (currentSerializedConfig === newSerializedConfig) {\n          return;\n        }\n        currentSerializedConfig = newSerializedConfig;\n\n        watchProp.onChange([...remoteConfigs, ...newConfigs, ...envConfigs]);\n      } catch (error) {\n        console.error(`Failed to reload configuration files, ${error}`);\n      }\n    });\n\n    if (watchProp.stopSignal) {\n      watchProp.stopSignal.then(() => {\n        watcher.close();\n      });\n    }\n  };\n\n  const watchRemoteConfig = (\n    watchProp: LoadConfigOptionsWatch,\n    remoteProp: LoadConfigOptionsRemote,\n  ) => {\n    const hasConfigChanged = async (\n      oldRemoteConfigs: AppConfig[],\n      newRemoteConfigs: AppConfig[],\n    ) => {\n      return (\n        JSON.stringify(oldRemoteConfigs) !== JSON.stringify(newRemoteConfigs)\n      );\n    };\n\n    let handle: NodeJS.Timeout | undefined;\n    try {\n      handle = setInterval(async () => {\n        console.info(`Checking for config update`);\n        const newRemoteConfigs = await loadRemoteConfigFiles();\n        if (await hasConfigChanged(remoteConfigs, newRemoteConfigs)) {\n          remoteConfigs = newRemoteConfigs;\n          console.info(`Remote config change, reloading config ...`);\n          watchProp.onChange([...remoteConfigs, ...fileConfigs, ...envConfigs]);\n          console.info(`Remote config reloaded`);\n        }\n      }, remoteProp.reloadIntervalSeconds * 1000);\n    } catch (error) {\n      console.error(`Failed to reload configuration files, ${error}`);\n    }\n\n    if (watchProp.stopSignal) {\n      watchProp.stopSignal.then(() => {\n        if (handle !== undefined) {\n          console.info(`Stopping remote config watch`);\n          clearInterval(handle);\n          handle = undefined;\n        }\n      });\n    }\n  };\n\n  // Set up config file watching if requested by the caller\n  if (watch) {\n    watchConfigFile(watch);\n  }\n\n  if (watch && remote) {\n    watchRemoteConfig(watch, remote);\n  }\n\n  return {\n    appConfigs: remote\n      ? [...remoteConfigs, ...fileConfigs, ...envConfigs]\n      : [...fileConfigs, ...envConfigs],\n  };\n}\n"],"names":["assertError","yaml","resolvePath","extname","path","dirname","Ajv","traverse","config","ConfigReader","mergeAllOf","fs","relativePath","sep","isAbsolute","basename","fetch","ForwardedError","chokidar"],"mappings":"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"}